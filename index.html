<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>모바일 보드게임</title>
    <meta name="description" content="친구들과 함께 즐기는 재미있는 모바일 보드게임">
    <meta name="theme-color" content="#4CAF50">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            margin: 0 !important;
            padding: 0 !important;
            width: 100%;
            height: 100%;
        }

        :root {
            --color-start: #FF6B6B;
            --color-quiz: #20B2AA;
            --color-golden: #FFD700;
            --color-special: #9370DB;
            --color-corner: #4682B4;
            --color-center: #F8F9FA;
            --color-background: #FAFAFA;
            --color-normal: #E3F2FD;
            /* 우측 UI(설정/전체화면) 영역 폭을 기준으로 좌우 여백을 동일하게 맞추는 간격 */
            --side-ui-gap: 66px;
            
            /* 특별 칸별 고유 색상 */
            --color-superjump: #00BFFF;
            --color-island: #616161;
            --color-donation: #FF69B4;
            
            /* 주사위 버튼 색상 시스템 */
            --dice-primary: #10B981;
            --dice-secondary: #059669;
            --dice-dark: #047857;
            --dice-glow: rgba(16, 185, 129, 0.6);
            --dice-glow-strong: rgba(16, 185, 129, 0.9);
            --dice-glow-urgent: rgba(16, 185, 129, 0.8);
            --dice-glow-max: rgba(16, 185, 129, 1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--color-background) 0%, var(--color-normal) 100%);
            min-height: calc(var(--vh, 1vh) * 100);
            overflow: auto; /* 자동 스크롤바 활성화 */
        }

        /* 메인 게임 컨테이너 (데스크톱: 그리드로 보드 좌측 영역 가운데 정렬 + 패널 우측 고정) */
        .game-container {
            width: 100vw;
            min-height: calc(var(--vh, 1vh) * 100);
            display: grid;
            grid-template-columns: 1fr auto; /* 좌측 가변 영역 + 우측 패널 고정 폭 */
            position: relative;
            align-items: center; /* 수직 가운데 */
            justify-items: center; /* 각 그리드 셀 내부 가로 가운데 */
            gap: 0;
        }

        /* 게임 보드 컨테이너 */
        .board-container {
            flex: 0 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
            aspect-ratio: 1 / 1;
            width: min(100%, 100vh);
            height: min(100%, 100vh);
        }


        /* 플레이어 정보 패널 */
        .player-panel {
            width: clamp(200px, 20vw, 280px); /* 화면 크기에 따라 200px~280px 사이에서 조절 */
            min-width: 200px;
            max-width: 280px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            padding: 15px;
            box-sizing: border-box;
            overflow: visible;
            gap: 10px;
            flex-shrink: 0; /* 패널 크기 고정 */
            justify-self: end; /* 그리드 우측 정렬 (오른쪽 끝) */
        }

        /* 패널 상단 버튼들 */
        .panel-buttons {
            display: flex;
            flex-direction: row;
            align-items: stretch;
            margin-bottom: 15px;
            gap: 8px;
            width: 100%;
        }

        /* 플레이어 섹션 */
        .players-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
            justify-content: flex-start;
            align-items: stretch;
            width: 100%;
            margin-bottom: 8px;
        }

        .player-panel .players-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* 중앙 주사위 컨트롤 */
        .center-dice-controls {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .center-dice-controls .dice-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border: 2px solid var(--color-corner);
        }

        /* 플레이어 정보 */
        .player-info {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 3px 3.5px;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .player-info.active {
            border: 2px solid #FFD700;
            animation: playerBlink 1s infinite;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        /* 플레이어 아바타 */
        .player-avatar {
            width: 45px;
            height: 45px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }

        /* 플레이어 세부 정보 */
        .player-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
            align-items: flex-start;
            flex: 1;
        }

        .player-name {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .player-score {
            font-size: 16px;
            color: #666;
            font-weight: bold;
        }

        .player-lands {
            font-size: 11px;
            color: #888;
        }

        .golden-keys {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #FFD700;
        }

        @keyframes playerBlink {
            0% { 
                border-color: #FFD700;
                box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            }
            50% { 
                border-color: #FFA500;
                box-shadow: 0 0 15px rgba(255, 165, 0, 0.8);
            }
            100% { 
                border-color: #FFD700;
                box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            }
        }

        /* 테스트 모드 체크박스 */
        .test-mode-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .test-mode-checkbox {
            width: 18px;
            height: 18px;
            accent-color: #4CAF50;
            cursor: pointer;
        }

        .test-mode-label {
            font-size: 12px;
            color: #333;
            cursor: pointer;
            user-select: none;
            font-weight: 500;
        }

        /* 전체화면 버튼 */
        .fullscreen-button {
            width: calc(50% - 4px);
            height: 45px;
            background: rgba(255, 255, 255, 0.98);
            border: 3px solid #333;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            color: #333;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            gap: 8px;
        }

        .fullscreen-button:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.05);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
        }

        .fullscreen-button:active {
            transform: scale(0.95);
        }

        /* 설정 버튼 */
        .settings-button {
            width: calc(50% - 4px);
            height: 45px;
            background: rgba(255, 255, 255, 0.98);
            border: 3px solid #333;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            color: #333;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            gap: 8px;
        }

        .settings-button:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.05);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
        }

        .settings-button:active {
            transform: scale(0.95);
        }

        /* 전체화면 아이콘 */
        .fullscreen-icon {
            position: relative;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 기본 상태: 확대 아이콘 표시, 축소 아이콘 숨김 */
        .fullscreen-icon .expand-icon {
            display: block;
        }

        .fullscreen-icon .minimize-icon {
            display: none;
        }

        /* 전체화면 상태: 확대 아이콘 숨김, 축소 아이콘 표시 */
        .fullscreen-icon.minimize .expand-icon {
            display: none;
        }

        .fullscreen-icon.minimize .minimize-icon {
            display: block;
        }

        /* SVG 아이콘 스타일 */
        .fullscreen-icon svg {
            transition: all 0.2s ease;
        }

        .fullscreen-button:hover .fullscreen-icon svg {
            transform: scale(1.1);
        }

        /* 전체화면 모드 */
        .fullscreen-mode {
            margin: 0 !important;
            padding: 0 !important;
        }

        .fullscreen-mode .board-container {
            padding: 0 !important;
            margin: 0 !important;
            overflow: visible !important;
            width: min(100vw, 100vh) !important;
            height: min(100vw, 100vh) !important;
            aspect-ratio: 1 / 1 !important;
        }

        .fullscreen-mode .game-board {
            width: 100% !important;
            height: 100% !important;
            margin: 0 !important;
            overflow: visible !important;
        }

        .fullscreen-mode .player-panel {
            display: flex !important;
        }

        .fullscreen-mode .center-dice-controls {
            display: flex !important;
        }

        .player-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
            align-items: flex-start;
            flex: 1;
        }

        .player-name {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .player-score {
            font-size: 12px;
            color: #666;
        }

        .player-lands {
            font-size: 11px;
            color: #888;
        }

        .golden-keys {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #FFD700;
        }

        .game-status {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .phase-badge {
            background: rgba(76, 175, 80, 0.9);
            color: white;
        }

        .turn-badge {
            background: rgba(255, 193, 7, 0.9);
            color: #333;
        }

        /* 게임 보드 */

        /* 플레이어 점수 현황 패널 */
        .player-score-panel {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0;
            min-width: 45px;
            background: transparent;
            border-radius: 0;
            padding: 0;
            backdrop-filter: none;
            border: none;
            margin: 0;
        }

        .player-score-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 0;
            background: transparent;
            border: none;
            transition: all 0.3s ease;
        }

        .player-score-item:hover {
            transform: translateY(-1px);
        }

        .player-score-item.current-player .player-mini-avatar {
            border: 2px solid #FFD700;
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.5);
        }

        .player-mini-avatar {
            width: 35px;
            height: 35px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .player-score-value {
            font-size: 20px;
            font-weight: bold;
            color: #000;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 6px;
            min-width: 70px;
            line-height: 1.2;
        }

        .player-separator {
            width: 35px;
            height: 35px;
            background: transparent;
            border: none;
            margin: 0;
            padding: 0;
        }

        /* 세로가 긴 화면 (모바일 세로 모드) - 플레이어 패널을 보드 아래로 이동 */
        @media (max-aspect-ratio: 1/1) and (max-width: 768px) {
            .game-container {
                display: flex;
                flex-direction: column;
                grid-template-columns: none;
                gap: 15px;
                padding: 10px;
            }
            
            .board-container {
                width: 100%;
                order: 1; /* 보드가 위로 */
            }
            
            .player-panel {
                width: 100%;
                height: auto;
                min-width: auto;
                order: 2; /* 플레이어 패널이 아래로 */
                max-height: none; /* 높이 제한 제거 */
                overflow: visible; /* 스크롤바 제거 */
            }
            
            .players-section {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
            }
            
            .player-info {
                flex: 1 1 calc(50% - 4px);
                max-width: calc(50% - 4px);
                min-width: 140px;
            }
            
            /* 세로 화면에서 버튼들 스타일 조정 */
            .test-mode-container {
                justify-content: center;
                margin-bottom: 12px;
            }
            
            .panel-buttons {
                justify-content: center;
                gap: 12px;
                margin-bottom: 15px;
            }
            
            .fullscreen-button,
            .settings-button {
                width: auto;
                min-width: 120px;
                max-width: 140px;
                flex: 1;
                padding: 8px 12px;
            }
            
            /* 중앙 주사위 컨트롤도 조정 */
            .center-dice-controls {
                position: static;
                transform: none;
                margin: 10px auto;
                z-index: auto;
            }
        }

        /* 플레이어 패널 반응형 너비 조정 */
        @media (max-width: 1200px) {
            .player-panel {
                width: clamp(180px, 18vw, 240px);
                min-width: 180px;
                max-width: 240px;
            }
        }

        @media (max-width: 900px) {
            .player-panel {
                width: clamp(160px, 16vw, 200px);
                min-width: 160px;
                max-width: 200px;
                padding: 12px;
            }
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            :root { /* 우측 버튼(35px) + 테두리(3px*2) + 우측 여백(8px) */
                --side-ui-gap: 49px;
            }
            .board-container {
                flex-direction: column;
                gap: 5px;
                padding: 2px var(--side-ui-gap);
                justify-content: center;
            }

            .player-score-panel {
                position: static;
                z-index: auto;
                min-width: auto;
                width: 100%;
                padding: 0;
                flex-direction: row;
                justify-content: center;
                gap: 0;
                border-radius: 0;
                background: transparent;
                border: none;
                margin: 0;
            }

            .player-mini-avatar {
                width: 30px;
                height: 30px;
                font-size: 12px;
            }

            .player-score-value {
                font-size: 18px;
                min-width: 60px;
                padding: 2px 6px;
            }

            .player-separator {
                width: 30px;
                height: 30px;
            }
        }

        /* 매우 작은 세로 화면 - 플레이어 정보를 1줄로 배치 */
        @media (max-aspect-ratio: 1/1) and (max-width: 480px) {
            .game-container {
                display: flex;
                flex-direction: column;
                grid-template-columns: none;
                gap: 10px;
                padding: 8px;
            }
            
            .board-container {
                width: 100%;
                order: 1;
            }
            
            .player-panel {
                width: 100%;
                height: auto;
                min-width: auto;
                order: 2;
                max-height: none; /* 높이 제한 제거 */
                overflow: visible; /* 스크롤바 제거 */
            }
            
            .players-section {
                display: flex;
                flex-direction: column;
                gap: 6px;
            }
            
            .player-info {
                flex: none;
                width: 100%;
                max-width: none;
                min-width: auto;
            }
            
            /* 매우 작은 세로 화면에서 버튼들 스타일 조정 */
            .test-mode-container {
                justify-content: center;
                margin-bottom: 10px;
            }
            
            .panel-buttons {
                justify-content: center;
                gap: 10px;
                margin-bottom: 12px;
            }
            
            .fullscreen-button,
            .settings-button {
                width: auto;
                min-width: 100px;
                max-width: 120px;
                flex: 1;
                padding: 6px 10px;
                font-size: 14px;
            }
            
            .fullscreen-button span,
            .settings-button span {
                font-size: 12px;
            }
            
            /* 중앙 주사위 컨트롤도 조정 */
            .center-dice-controls {
                position: static;
                transform: none;
                margin: 8px auto;
                z-index: auto;
            }
        }

        @media (max-width: 600px) and (min-aspect-ratio: 1/1) {
            .player-panel {
                width: clamp(140px, 14vw, 180px);
                min-width: 140px;
                max-width: 180px;
                padding: 10px;
            }
        }

        @media (max-width: 480px) {
            :root { /* 우측 버튼(30px) + 테두리(3px*2) + 우측 여백(5px) */
                --side-ui-gap: 41px;
            }
            .player-score-panel {
                padding: 0;
                gap: 0;
                border-radius: 0;
                background: transparent;
                border: none;
                margin: 0;
            }

            .player-mini-avatar {
                width: 28px;
                height: 28px;
                font-size: 11px;
            }

            .player-score-value {
                font-size: 16px;
                min-width: 56px;
                padding: 2px 4px;
            }

            .player-separator {
                width: 28px;
                height: 28px;
            }
        }

        /* 게임 보드 */
        .game-board {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            aspect-ratio: 1 / 1;
            border: none;
            border-radius: 20px;
            background: var(--color-background);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(7, 1fr);
            gap: 0px;
            padding: 0px;
            overflow: visible;
        }

        /* 보드 칸 */
        .board-space {
            border-radius: 0px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: none;
            min-height: 25px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            overflow: hidden;
            contain: layout;
        }

        .board-space:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* 칸 번호 */
        .space-number {
            font-size: clamp(12px, 3vw, 24px);
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            text-align: center;
            line-height: 1;
        }

        /* 칸 이름 */
        .space-name {
            font-size: clamp(8px, 2vw, 16px);
            color: white;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            margin-top: 1px;
            line-height: 1;
            font-weight: bold;
        }

        /* 일반 칸의 글자 색상을 어두운 회색으로 */
        .space-quiz .space-name {
            color: #333 !important;
            text-shadow: none !important;
        }

        /* 특별 칸들의 글자 크기를 더 크게 */
        .corner-space .space-name {
            font-size: clamp(8px, 2.2vw, 16px);
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }

        /* 시작 칸 스타일 (둥근 모서리) */
        .space-start {
            border-radius: 12px !important;
        }

        .corner-space[data-space-id="0"] {
            background: #FFFFFF !important; /* 시작 칸은 항상 흰색 */
            border-radius: 12px !important;
            border: 3px solid #333333 !important; /* 더 두꺼운 진한 회색 테두리 */
        }

        .space-start .space-name {
            font-size: clamp(10px, 2.8vw, 20px) !important;
            font-weight: 900 !important;
            color: #000000 !important;
            text-shadow: none !important;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: transparent !important;
            padding: 4px 6px !important;
            border: none !important;
            box-shadow: none !important;
            width: 90% !important;
            height: 80% !important;
            text-align: center !important;
            box-sizing: border-box !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        /* 중앙 패널과 겹치는 영역의 모든 칸들 - 호버 효과 비활성화 */
        .board-space:nth-child(16),  /* (2,2) */
        .board-space:nth-child(17),  /* (2,3) */
        .board-space:nth-child(18),  /* (2,4) */
        .board-space:nth-child(23),  /* (3,2) */
        .board-space:nth-child(24),  /* (3,3) */
        .board-space:nth-child(25),  /* (3,4) */
        .board-space:nth-child(30),  /* (4,2) */
        .board-space:nth-child(31),  /* (4,3) */
        .board-space:nth-child(32) { /* (4,4) */
            cursor: default !important;
        }

        .board-space:nth-child(16):hover,
        .board-space:nth-child(17):hover,
        .board-space:nth-child(18):hover,
        .board-space:nth-child(23):hover,
        .board-space:nth-child(24):hover,
        .board-space:nth-child(25):hover,
        .board-space:nth-child(30):hover,
        .board-space:nth-child(31):hover,
        .board-space:nth-child(32):hover {
            transform: none !important;
            box-shadow: none !important;
            cursor: default !important;
        }

        /* 소유권 표시 - 전체 칸 색상 변경 */
        .board-space {
            transition: background-color 0.3s ease;
        }

        /* 소유된 칸의 배경색을 플레이어 색상으로 변경 */
        .board-space.owned {
            background-color: var(--owner-color, transparent) !important;
            opacity: 1.0; /* 플레이어 패널과 동일한 색상 강도 */
            color: black !important; /* 소유된 칸의 텍스트는 검은색으로 */
        }

        /* 슈퍼 점프 칸 스타일 (전기 파란색 테마, 둥근 모서리) */
        .corner-space[data-space-id="6"] {
            background: var(--color-superjump) !important;
            border-radius: 12px !important;
            border: 3px solid #0080CC !important; /* 입체감 있는 진한 파란색 테두리 */
        }

        .corner-space[data-space-id="6"] .space-name {
            font-size: clamp(8px, 2.2vw, 16px) !important;
            font-weight: 900 !important;
            color: #FFFFFF !important;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8) !important;
            background: transparent !important;
            padding: 4px 6px !important;
            border: none !important;
            box-shadow: none !important;
            width: 90% !important;
            height: 80% !important;
            text-align: center !important;
            box-sizing: border-box !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        /* 무인도 칸 스타일 (어두운 회색 테마, 둥근 모서리) */
        .corner-space[data-space-id="12"] {
            background: var(--color-island) !important;
            border-radius: 12px !important;
            border: 3px solid #404040 !important; /* 입체감 있는 진한 회색 테두리 */
        }

        .corner-space[data-space-id="12"] .space-name {
            font-size: clamp(8px, 2.2vw, 16px) !important;
            font-weight: 900 !important;
            color: #FFFFFF !important;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8) !important;
            background: transparent !important;
            padding: 4px 6px !important;
            border: none !important;
            box-shadow: none !important;
            width: 90% !important;
            height: 80% !important;
            text-align: center !important;
            box-sizing: border-box !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        /* 기부 천사 칸 스타일 (핫핑크 테마, 둥근 모서리) */
        .corner-space[data-space-id="18"] {
            background: var(--color-donation) !important;
            border-radius: 12px !important;
            border: 3px solid #E6458B !important; /* 입체감 있는 진한 핑크색 테두리 */
        }

        .corner-space[data-space-id="18"] .space-name {
            font-size: clamp(8px, 2.2vw, 16px) !important;
            font-weight: 900 !important;
            color: #FFFFFF !important;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8) !important;
            background: transparent !important;
            padding: 4px 6px !important;
            border: none !important;
            box-shadow: none !important;
            width: 90% !important;
            height: 80% !important;
            text-align: center !important;
            box-sizing: border-box !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            flex-direction: column !important;
        }



        /* 내부 빈칸들을 위한 특별 스타일 - 모든 그림자와 테두리 제거 */
        .board-space.center-background {
            border: none !important;
            box-shadow: none !important;
            outline: none !important;
        }

        .board-space.center-background:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        /* 중앙 배경 칸들 - 호버 효과 비활성화 */
        .board-space.center-background {
            cursor: default !important;
            pointer-events: none !important; /* 마우스 이벤트 완전 차단 */
        }

        .board-space.center-background:hover {
            transform: none !important;
            box-shadow: none !important;
            cursor: default !important;
        }

        /* 중앙 패널과 겹치는 영역의 모든 칸들 - 호버 효과 비활성화 */
        .board-space:nth-child(16),  /* (2,2) */
        .board-space:nth-child(17),  /* (2,3) */
        .board-space:nth-child(18),  /* (2,4) */
        .board-space:nth-child(23),  /* (3,2) */
        .board-space:nth-child(24),  /* (3,3) */
        .board-space:nth-child(25),  /* (3,4) */
        .board-space:nth-child(30),  /* (4,2) */
        .board-space:nth-child(31),  /* (4,3) */
        .board-space:nth-child(32) { /* (4,4) */
            cursor: default !important;
        }

        .board-space:nth-child(16):hover,
        .board-space:nth-child(17):hover,
        .board-space:nth-child(18):hover,
        .board-space:nth-child(23):hover,
        .board-space:nth-child(24):hover,
        .board-space:nth-child(25):hover,
        .board-space:nth-child(30):hover,
        .board-space:nth-child(31):hover,
        .board-space:nth-child(32):hover {
            transform: none !important;
            box-shadow: none !important;
            cursor: default !important;
        }

        /* 땅 소유 시 플레이어 색상으로 변경 */
        .board-space.owned {
            background: var(--owner-color, var(--color-quiz)) !important;
            transition: background-color 0.3s ease;
        }

        .space-number {
            font-size: clamp(12px, 3vw, 24px);
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            text-align: center;
            line-height: 1;
        }

        .space-name {
            font-size: clamp(8px, 2vw, 16px);
            color: white;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            margin-top: 1px;
            line-height: 1;
            font-weight: bold;
        }

        /* 특별 칸들의 글자 크기를 더 크게 */
        .corner-space .space-name {
            font-size: clamp(8px, 2.2vw, 16px);
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }


        /* 시작 칸 텍스트 스타일 */
        .space-start .space-name {
            font-size: clamp(10px, 2.8vw, 20px) !important;
            font-weight: 900 !important;
            color: #000000 !important;
            text-shadow: none !important;
            letter-spacing: 1px;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-align: center !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            width: 100% !important;
            height: 100% !important;
        }

        /* 슈퍼 점프 칸 텍스트 스타일 (전기 파란색 테마) */
        .corner-space[data-space-id="6"] .space-name {
            font-size: clamp(8px, 2.2vw, 16px) !important;
            font-weight: 900 !important;
            color: #FFFFFF !important;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8) !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-align: center !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            width: 100% !important;
            height: 100% !important;
        }

        /* 무인도 칸 텍스트 스타일 (어두운 회색 테마) */
        .corner-space[data-space-id="12"] .space-name {
            font-size: clamp(8px, 2.2vw, 16px) !important;
            font-weight: 900 !important;
            color: #FFFFFF !important;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8) !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-align: center !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            width: 100% !important;
            height: 100% !important;
        }

        /* 기부 천사 칸 텍스트 스타일 (핫핑크 테마) */
        .corner-space[data-space-id="18"] .space-name {
            font-size: clamp(8px, 2.2vw, 16px) !important;
            font-weight: 900 !important;
            color: #FFFFFF !important;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8) !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-align: center !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            width: 100% !important;
            height: 100% !important;
        }



        /* 모노폴리 스타일 보드 칸 배치 */
        .corner-space {
            background: var(--color-corner) !important;
            color: white;
            font-weight: bold;
            border: 2px solid var(--color-corner) !important;
            font-size: 12px;
        }

        .side-space {
            min-height: 20px;
        }

        .center-space {
            background: var(--color-center) !important;
            color: #000;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            border: 2px solid var(--color-corner);
        }

        /* 플레이어 말 */
        .player-piece {
            position: absolute;
            width: 25px;
            height: 25px;
            border-radius: 8px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.5s ease;
            top: 8%; /* 띠지와 겹치지 않도록 위치 조정 */
            background: rgba(0, 0, 0, 0.2); /* 배경을 조금 더 진하게 하여 가시성 향상 */
            z-index: 10; /* 띠지(z-index: 2)보다 위에 표시 */
        }

        .player-piece.moving {
            animation: bounceMove 0.6s ease-in-out;
            z-index: 20;
        }

        @keyframes bounceMove {
            0% {
                transform: translateY(0px) scale(1);
            }
            25% { 
                transform: translateY(-15px) scale(1.1);
            }
            50% { 
                transform: translateY(0px) scale(1);
            }
            75% { 
                transform: translateY(-8px) scale(1.05);
            }
            100% { 
                transform: translateY(0px) scale(1);
            }
        }

        .player-piece.landing {
            animation: landingBounce 0.4s ease-out;
        }

        @keyframes landingBounce {
            0% {
                transform: translateY(0px) scale(1);
            }
            50% {
                transform: translateY(-10px) scale(1.15);
            }
            100% {
                transform: translateY(0px) scale(1);
            }
        }


        .fullscreen-button:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* 설정 모달 스타일 */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .settings-container {
            background: white;
            border-radius: 8px;
            width: 95%;
            max-width: 900px;
            height: 85%;
            max-height: 650px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }

        .settings-header h2 {
            margin: 0;
            color: #333;
            font-size: 18px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .close-btn:hover {
            background: #e9ecef;
        }

        .settings-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .settings-sidebar {
            width: 160px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            padding: 8px 0;
            overflow-y: auto;
        }

        .sidebar-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            font-size: 13px;
        }

        .sidebar-item:hover {
            background: #e3f2fd;
        }

        .sidebar-item.active {
            background: #bbdefb;
            border-left-color: #2196f3;
            font-weight: bold;
        }

        .settings-main {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
        }

        .settings-panel {
            display: none;
        }

        .settings-panel.active {
            display: block;
        }

        .settings-panel h3 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 16px;
        }

        .setting-group {
            margin: 4px 0;
            padding: 6px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .setting-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .volume-slider {
            width: 100%;
            margin: 6px 0;
        }

        .volume-value {
            color: #666;
            font-size: 14px;
        }






        .mini-board-container {
            background: white;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .mini-board {
            width: 200px;
            height: 150px;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(7, 1fr);
            gap: 1px;
            background: #333;
            border-radius: 6px;
            padding: 2px;
        }

        .mini-space {
            background: #fff;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: bold;
            color: #333;
        }


        .color-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .color-swatch {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .preview-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-apply, .btn-cancel {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-apply {
            background: #2196f3;
            color: white;
        }

        .btn-apply:hover {
            background: #1976d2;
        }

        .btn-cancel {
            background: #f5f5f5;
            color: #666;
        }

        .btn-cancel:hover {
            background: #e0e0e0;
        }

        /* 모바일 반응형 */
        @media (max-width: 768px) {
            .settings-container {
                width: 95%;
                height: 90%;
            }
            
            .settings-content {
                flex-direction: column;
            }
            
            .settings-sidebar {
                width: 100%;
                height: auto;
                max-height: 120px;
                flex-direction: row;
                overflow-x: auto;
                padding: 10px;
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }
            
            .sidebar-item {
                min-width: 80px;
                text-align: center;
                padding: 10px 5px;
                border-left: none;
                border-bottom: 3px solid transparent;
            }
            
            .sidebar-item.active {
                border-left: none;
                border-bottom-color: #2196f3;
            }
            
            
            .color-settings-layout {
                flex-direction: column;
            }
            
            .palette-preview {
                width: 100%;
                min-width: auto;
            }
            
            .mini-board {
                width: 150px;
                height: 120px;
            }
        }

        .fullscreen-button:active {
            transform: scale(0.95);
        }

        .settings-button:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .settings-button:active {
            transform: scale(0.95);
        }

        .fullscreen-icon {
            position: relative;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 기본 상태: 확대 아이콘 표시, 축소 아이콘 숨김 */
        .fullscreen-icon .expand-icon {
            display: block;
        }

        .fullscreen-icon .minimize-icon {
            display: none;
        }

        /* 전체화면 상태: 확대 아이콘 숨김, 축소 아이콘 표시 */
        .fullscreen-icon.minimize .expand-icon {
            display: none;
        }

        .fullscreen-icon.minimize .minimize-icon {
            display: block;
        }

        /* SVG 아이콘 스타일 */
        .fullscreen-icon svg {
            transition: all 0.2s ease;
        }

        .fullscreen-button:hover .fullscreen-icon svg {
            transform: scale(1.1);
        }

        /* 전체화면 모드일 때 */
        .fullscreen-mode {
            margin: 0 !important;
            padding: 0 !important;
        }

        .fullscreen-mode .board-container {
            padding: 2px 2vw !important;
            margin: 0 !important;
            overflow: hidden !important;
            clip-path: inset(0) !important;
        }

        .fullscreen-mode .game-board {
            width: 95vw;
            height: calc(100% - 4px);
            margin: 0 !important;
            overflow: hidden !important;
            clip-path: inset(0) !important;
        }

        .fullscreen-mode .center-panel {
            width: calc(95vw * 4.5 / 7);
            max-width: calc(95vw * 4.5 / 7);
            min-width: calc(95vw * 4.5 / 7);
            box-sizing: border-box;
        }


        /* 새로운 SVG 기반 주사위 스타일 */
        .dice-display {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dice-icon {
            width: 64px;
            height: 64px;
            fill: #374151;
        }

        /* 주사위 표시 영역의 주사위 아이콘 스타일 */
        #diceIcon {
            fill: #374151;
        }

        .dice-icon.spinning {
            animation: spin 0.1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .control-button {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
            border: 2px solid #B8860B;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
            transition: all 0.3s ease;
        }

        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.6);
            background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
        }

        .control-button:active {
            transform: translateY(0);
        }

        .control-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* 팝업 스타일 */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        /* 황금 열쇠 팝업은 어두운 배경 없이 */
        #goldenKeyPopup {
            background: transparent;
        }

        .popup-overlay.show {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .popup-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 90vw;
            max-height: calc(var(--vh, 1vh) * 80);
            width: 500px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
            overflow-y: auto;
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(50px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .popup-title {
            color: white;
            text-align: center;
            margin: 0 0 20px 0;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .popup-content {
            color: white;
            text-align: center;
            margin: 0 0 25px 0;
            font-size: 16px;
            line-height: 1.5;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .popup-button {
            background: white;
            color: #333;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .popup-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            background: #f8f9fa;
        }

        /* 반응형 디자인 */
        
        /* 전체화면 버튼 반응형 - 가로 화면에서만 적용 */
        @media (max-width: 768px) and (min-aspect-ratio: 1/1) {
            .fullscreen-button {
                width: 35px;
                height: 35px;
                font-size: 16px;
                top: 8px;
                right: 8px;
            }
            .settings-button {
                width: 35px;
                height: 35px;
                font-size: 16px;
                top: 50px;
                right: 8px;
            }
        }

        @media (max-width: 480px) and (min-aspect-ratio: 1/1) {
            .fullscreen-button {
                width: 30px;
                height: 30px;
                font-size: 14px;
                top: 5px;
                right: 5px;
            }
            .settings-button {
                width: 30px;
                height: 30px;
                font-size: 14px;
                top: 40px;
                right: 5px;
            }
        }
        
        /* 중간 크기 화면 - 2줄 배치 (2x2) */
        @media (max-width: 900px) {
            .center-panel {
                padding: 15px 20px;
                gap: 12px;
                width: calc(100% * 4.5 / 7);
                max-width: calc(100% * 4.5 / 7);
                min-width: calc(100% * 4.5 / 7);
                box-sizing: border-box;
            }
            
            .players-section {
                gap: 8px;
                flex-wrap: nowrap;
                flex-direction: column;
                justify-content: flex-start;
            }
            
            .player-info {
                min-width: 180px;
                padding: 10px 12px;
                gap: 10px;
                flex: none;
                width: 100%;
                max-width: none;
            }
            
            .player-avatar {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            .player-name {
                font-size: 13px;
            }
            
            .player-score {
                font-size: 12px;
            }
            
            .player-lands {
                font-size: 11px;
            }
            
            .controls-section {
                gap: 10px;
            }
            
            .game-board {
                width: 100%;
                height: 100%;
                aspect-ratio: 1 / 1;
            }
        }

        /* 태블릿 크기 - 2줄 배치 유지 */
        @media (max-width: 768px) {
            .center-panel {
                padding: 15px 18px;
                gap: 10px;
                width: calc(100% * 4.5 / 7);
                max-width: calc(100% * 4.5 / 7);
                min-width: calc(100% * 4.5 / 7);
                box-sizing: border-box;
            }
            
            .players-section {
                gap: 6px;
                flex-wrap: nowrap;
                flex-direction: column;
                justify-content: flex-start;
            }
            
            .player-info {
                min-width: 160px;
                padding: 8px 10px;
                gap: 8px;
                flex: none;
                width: 100%;
                max-width: none;
            }
            
            .player-avatar {
                width: 36px;
                height: 36px;
                font-size: 15px;
            }
            
            .player-name {
                font-size: 12px;
            }
            
            .player-score {
                font-size: 11px;
            }
            
            .player-lands {
                font-size: 10px;
            }
            
            .controls-section {
                gap: 8px;
            }
            
            .game-board {
                width: 100%;
                height: 100%;
                aspect-ratio: 1 / 1;
            }
        }

        /* 작은 화면 - 4줄 배치 (세로) */
        @media (max-width: 600px) {
            .center-panel {
                padding: 12px 15px;
                gap: 8px;
                width: calc(100% * 4.5 / 7);
                max-width: calc(100% * 4.5 / 7);
                min-width: calc(100% * 4.5 / 7);
                box-sizing: border-box;
            }
            
            .players-section {
                gap: 6px;
                flex-wrap: nowrap;
                flex-direction: column;
                align-items: center;
            }
            
            .player-info {
                min-width: 220px;
                padding: 8px 12px;
                gap: 10px;
                flex: none;
                width: 100%;
                max-width: 250px;
            }
            
            .player-avatar {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            
            .player-name {
                font-size: 12px;
            }
            
            .player-score {
                font-size: 11px;
            }
            
            .controls-section {
                gap: 8px;
            }
            
            .game-board {
                width: 100%;
                height: 100%;
                aspect-ratio: 1 / 1;
            }
        }

        @media (max-width: 480px) {
            .center-panel {
                padding: 10px 12px;
                gap: 6px;
                width: calc(100% * 4.5 / 7);
                max-width: calc(100% * 4.5 / 7);
                min-width: calc(100% * 4.5 / 7);
                box-sizing: border-box;
            }
            
            .players-section {
                gap: 4px;
                flex-wrap: nowrap;
                flex-direction: column;
                align-items: center;
            }
            
            .player-info {
                min-width: 200px;
                padding: 6px 10px;
                gap: 8px;
                flex: none;
                width: 100%;
                max-width: 230px;
            }
            
            .player-avatar {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
            
            .player-name {
                font-size: 11px;
            }
            
            .player-score {
                font-size: 10px;
            }
            
            .player-lands {
                font-size: 9px;
            }
            
            .controls-section {
                gap: 8px;
            }
            
            .player-avatar {
                width: 30px;
                height: 30px;
                font-size: 12px;
            }
            
            .player-name {
                font-size: 12px;
            }
            
            .player-score {
                font-size: 10px;
            }
            
            .golden-keys {
                font-size: 10px;
            }
            
            .controls-section {
                gap: 8px;
            }
            
            .game-board {
                width: 100%;
                height: 100%;
                aspect-ratio: 1 / 1;
            }
            
            .space-number {
                font-size: clamp(6px, 3vw, 14px);
            }
            
            .space-name {
                font-size: clamp(5px, 2.5vw, 10px);
            }
        }



        /* 황금 열쇠 발견 메시지 팝업 */
        .golden-discovery-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #FFD700, #FFA500, #FFD700);
            border: 4px solid #B8860B;
            border-radius: 20px;
            padding: 30px 40px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8), 0 0 60px rgba(255, 165, 0, 0.6);
            z-index: 1000;
            text-align: center;
            font-family: 'Arial', sans-serif;
            min-width: 300px;
            max-width: 500px;
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .golden-discovery-popup.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        /* 슈퍼 점프 모드 스타일 */
        .super-jump-target {
            border: 3px solid #FFD700 !important;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            cursor: pointer !important;
            animation: superJumpPulse 1.5s infinite;
        }

        .super-jump-disabled {
            opacity: 0.3 !important;
            cursor: not-allowed !important;
            filter: grayscale(50%);
        }

        @keyframes superJumpPulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 0 25px rgba(255, 215, 0, 1);
            }
        }

        .super-jump-mode-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #00BFFF, #00CED1, #9370DB);
            color: #fff;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 16px;
            border: 3px solid #00BFFF;
            box-shadow: 0 0 30px rgba(0, 191, 255, 0.6);
            z-index: 1000;
        }

        .teleport-mode-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffd700 100%);
            color: #8b4513;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 16px;
            border: 3px solid #ffd700;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
            z-index: 1000;
            animation: superJumpIndicatorPulse 2s infinite;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }


        @keyframes superJumpIndicatorPulse {
            0%, 100% { 
                opacity: 1;
                box-shadow: 0 0 30px rgba(0, 191, 255, 0.6);
            }
            50% { 
                opacity: 0.8;
                box-shadow: 0 0 40px rgba(0, 191, 255, 0.8);
            }
        }

        /* 주사위 버튼 활성화 효과 */
        .dice-button-active {
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            border: 3px solid #FFD700;
            transform: scale(1.05);
            background: linear-gradient(135deg, #FFD700, #FFA500);
        }

        /* 황금 텍스트 효과 */
        .dice-button-active #buttonText,
        .dice-button-urgent #buttonText {
            background: linear-gradient(90deg, 
                #2F1B14, #5D4E37, #8B7355, #5D4E37, #2F1B14);
            background-size: 300% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbowText 2s ease-in-out infinite;
            font-weight: bold;
            text-shadow: none;
        }

        @keyframes rainbowText {
            0% { background-position: 0% 0%; }
            50% { background-position: 100% 0%; }
            100% { background-position: 0% 0%; }
        }

        .dice-button-active:hover {
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            transform: scale(1.1);
            background: linear-gradient(135deg, #FFA500, #FF8C00);
        }



        /* 주사위 버튼 비활성화 상태 */
        .dice-button-disabled {
            opacity: 0.5;
            cursor: not-allowed;
            animation: none;
            box-shadow: none;
            transform: scale(1);
        }

        /* 주사위 버튼 긴급 상태 (턴 대기) */
        .dice-button-urgent {
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.8);
            border: 3px solid #FFD700;
            background: linear-gradient(135deg, #FFD700, #FFA500);
        }


        /* 슈퍼 점프 모드 팝업 스타일 */
        .super-jump-mode .popup-container {
            background: linear-gradient(135deg, #00BFFF, #00CED1, #9370DB);
            border: 3px solid #00BFFF;
            box-shadow: 0 0 30px rgba(0, 191, 255, 0.6);
        }

        .super-jump-mode .popup-title {
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .super-jump-mode .popup-content {
            color: #fff;
        }

        .super-jump-mode .popup-button {
            background: linear-gradient(135deg, #9370DB, #00CED1);
            color: #fff;
            border: 2px solid #00BFFF;
            box-shadow: 0 4px 15px rgba(147, 112, 219, 0.4);
        }

        .super-jump-mode .popup-button:hover {
            background: linear-gradient(135deg, #00CED1, #00BFFF);
            box-shadow: 0 6px 20px rgba(0, 191, 255, 0.6);
        }

        /* 황금 열쇠 모드 팝업 스타일 */
        .golden-key-mode .popup-container {
            background: linear-gradient(135deg, #FFD700, #FFA500, #FF6347);
            border: 3px solid #FFD700;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
        }

        .golden-key-mode .popup-title {
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .golden-key-mode .popup-content {
            color: #fff;
        }

        .golden-key-mode .popup-button {
            background: linear-gradient(135deg, #FF6347, #FFA500);
            color: #fff;
            border: 2px solid #FFD700;
            box-shadow: 0 4px 15px rgba(255, 99, 71, 0.4);
        }

        .golden-key-mode .popup-button:hover {
            background: linear-gradient(135deg, #FFA500, #FFD700);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
        }

        /* 무인도 모드 팝업 스타일 */
        .island-mode .popup-container {
            background: linear-gradient(135deg, #424242, #616161, #757575);
            border: 3px solid #424242;
            box-shadow: 0 0 30px rgba(66, 66, 66, 0.6);
        }

        .island-mode .popup-title {
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .island-mode .popup-content {
            color: #fff;
        }

        .island-mode .popup-button {
            background: linear-gradient(135deg, #616161, #757575);
            color: #fff;
            border: 2px solid #424242;
            box-shadow: 0 4px 15px rgba(97, 97, 97, 0.4);
        }

        .island-mode .popup-button:hover {
            background: linear-gradient(135deg, #757575, #424242);
            box-shadow: 0 6px 20px rgba(66, 66, 66, 0.6);
        }

        /* 기부 천사 모드 팝업 스타일 */
        .donation-mode .popup-container {
            background: linear-gradient(135deg, #FF69B4, #FF1493, #FFB6C1);
            border: 3px solid #FF69B4;
            box-shadow: 0 0 30px rgba(255, 105, 180, 0.6);
        }

        .donation-mode .popup-title {
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .donation-mode .popup-content {
            color: #fff;
        }

        .donation-mode .popup-button {
            background: linear-gradient(135deg, #FF1493, #FF69B4);
            color: #fff;
            border: 2px solid #FF69B4;
            box-shadow: 0 4px 15px rgba(255, 20, 147, 0.4);
        }

        .donation-mode .popup-button:hover {
            background: linear-gradient(135deg, #FF69B4, #FF1493);
            box-shadow: 0 6px 20px rgba(255, 105, 180, 0.6);
        }

        /* 땅 정보 모드 팝업 스타일 */
        .land-info-mode .popup-container {
            background: linear-gradient(135deg, #4CAF50, #45a049, #66BB6A);
            border: 3px solid #4CAF50;
            box-shadow: 0 0 30px rgba(76, 175, 80, 0.6);
        }

        .land-info-mode .popup-title {
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .land-info-mode .popup-content {
            color: #fff;
        }

        .land-info-mode .popup-button {
            background: linear-gradient(135deg, #45a049, #4CAF50);
            color: #fff;
            border: 2px solid #4CAF50;
            box-shadow: 0 4px 15px rgba(69, 160, 73, 0.4);
        }

        .land-info-mode .popup-button:hover {
            background: linear-gradient(135deg, #4CAF50, #66BB6A);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
        }

        /* 땅 정보 섹션 스타일 */
        .land-info-section {
            text-align: left;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin: 8px 0;
            backdrop-filter: blur(10px);
        }


        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 4px 0;
            padding: 3px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: bold;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .info-value {
            color: #FFD700;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .owner-name {
            color: #FFE082;
        }

        .star-count {
            color: #FFD700;
        }

        .toll-amount {
            color: #FFCDD2;
        }

        .star-display {
            text-align: center;
            margin: 15px 0;
            font-size: 24px;
            line-height: 1.2;
        }

        /* 통행세 범례 섹션 스타일 */
        .toll-legend-section {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 10px;
            margin: 8px 0 0 0;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .toll-legend-section h5 {
            color: #fff;
            text-align: center;
            margin: 0 0 8px 0;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .toll-legend-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .toll-legend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            padding: 3px 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .legend-stars {
            font-size: 12px;
            line-height: 1;
        }

        .legend-amount {
            color: #FFD700;
            font-size: 10px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* 명언 섹션 스타일 */
        .quote-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin: 0 0 10px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }
        .quote-text {
            font-style: italic;
            font-size: 0.9em;
            color: #FFD700;
            margin-bottom: 6px;
            line-height: 1.2;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
        }
        .quote-author {
            font-size: 0.75em;
            color: #FFFFFF;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
        }

        /* 시작 모드 팝업 스타일 */
        .start-mode .popup-container {
            background: linear-gradient(135deg, #FFFFFF, #F5F5F5, #E0E0E0);
            border: 3px solid #FFFFFF;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.6);
        }

        .start-mode .popup-title {
            color: #333;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .start-mode .popup-content {
            color: #333;
        }

        .start-mode .popup-button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: #fff;
            border: 2px solid #4CAF50;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .start-mode .popup-button:hover {
            background: linear-gradient(135deg, #45a049, #4CAF50);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
        }

        /* 특별 칸 정보 섹션 스타일 */
        .special-space-section {
            text-align: left;
        }

        .space-description {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            backdrop-filter: blur(10px);
        }

        .space-description h4 {
            color: #fff;
            text-align: center;
            margin: 0 0 10px 0;
            font-size: 16px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .space-description p {
            color: #fff;
            text-align: center;
            margin: 0;
            font-size: 14px;
            line-height: 1.4;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .space-features {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            backdrop-filter: blur(10px);
        }

        .space-features h5 {
            color: #fff;
            text-align: center;
            margin: 0 0 12px 0;
            font-size: 14px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .feature-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 6px 0;
        }

        .feature-icon {
            font-size: 16px;
            margin-right: 10px;
            min-width: 20px;
        }

        .feature-text {
            color: #fff;
            font-size: 13px;
            line-height: 1.3;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* 시작 모드 전용 스타일 */
        .start-mode .space-description,
        .start-mode .space-features {
            background: rgba(0, 0, 0, 0.1);
        }

        .start-mode .space-description h4,
        .start-mode .space-description p,
        .start-mode .space-features h5,
        .start-mode .feature-text {
            color: #333;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
        }

        /* 무인도 모드 표시기 (제거됨) */
        /*
        .island-mode-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #8B0000, #DC143C, #B22222);
            color: #fff;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 16px;
            border: 3px solid #8B0000;
            box-shadow: 0 0 30px rgba(139, 0, 0, 0.6);
            z-index: 1000;
            animation: islandIndicatorPulse 2s infinite;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        @keyframes islandIndicatorPulse {
            0%, 100% { 
                opacity: 1;
                box-shadow: 0 0 30px rgba(139, 0, 0, 0.6);
            }
            50% { 
                opacity: 0.8;
                box-shadow: 0 0 40px rgba(139, 0, 0, 0.8);
            }
        }
        */


        .golden-event-title {
            font-size: 1.8em;
            font-weight: bold;
            color: #8B4513;
            margin: 0 0 15px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .golden-event-content {
            font-size: 1.2em;
            color: #8B4513;
            margin: 0 0 20px 0;
            font-weight: 500;
        }

        .mystery-box-result {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 215, 0, 0.2);
            border-radius: 8px;
            border: 1px solid #B8860B;
        }

        .mystery-box-result p {
            font-size: 1.1em;
            font-weight: bold;
            color: #8B4513;
            margin: 0;
            text-align: center;
        }

        .golden-event-actions {
            text-align: center;
        }

        .golden-event-actions .btn-confirm {
            background: linear-gradient(135deg, #B8860B, #DAA520, #B8860B);
            color: #fff;
            border: 2px solid #8B4513;
            border-radius: 10px;
            padding: 12px 30px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .golden-event-actions .btn-confirm:hover {
            background: linear-gradient(135deg, #DAA520, #FFD700, #DAA520);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        /* 플레이어 선택 리스트 스타일 */
        .player-selection-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }

        .player-selection-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .player-selection-item:hover {
            background: rgba(255, 255, 255, 1);
            border-color: #4CAF50;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .player-selection-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .player-selection-info {
            flex: 1;
        }

        .player-selection-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .player-selection-status {
            font-size: 14px;
            color: #666;
        }

        .player-selection-position {
            font-size: 12px;
            color: #888;
        }

        /* 위치 선택 그리드 스타일 */
        .position-selection-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        .position-selection-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 60px;
            justify-content: center;
        }

        .position-selection-item:hover {
            border-color: #4CAF50;
            background-color: #f0f8f0;
            transform: translateY(-2px);
        }

        .position-selection-item.selected {
            border-color: #4CAF50;
            background-color: #e8f5e8;
        }

        .position-number {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
            margin-bottom: 4px;
        }

        .position-name {
            font-size: 0.8em;
            color: #666;
            text-align: center;
            line-height: 1.2;
        }

        @keyframes goldenTextShine {
            0%, 100% { 
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            }
            50% { 
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3), 0 0 10px #FFD700, 0 0 20px #FFD700;
            }
        }

        /* 보드 칸 색상 - CSS 변수 사용 */
        .space-start { background: var(--color-start); color: #fff; }
        /* 보드 칸 색상 - CSS 변수 사용 */
        .space-quiz { background: #f0f0f0; color: #000; border-radius: 12px; } /* 일반 칸: 연한 회색 배경, 검은색 텍스트, 둥근 모서리 */
        .space-golden { background: var(--color-golden); color: #000; border-radius: 12px; border: 3px solid #FFC107; } /* 황금 열쇠 칸: 반짝이는 밝은 황금빛 테두리 */
        .space-special { background: var(--color-special); color: #fff; }
        .space-corner { background: var(--color-corner); color: #fff; } /* 모서리 칸은 기존 모양 유지 */
        .space-finish { background: var(--color-start); color: #fff; }
        .space-island { background: var(--color-corner); color: #fff; }
        .space-free { background: var(--color-corner); color: #fff; }
        .space-goto { background: var(--color-corner); color: #fff; }
        

        /* 황금 열쇠 칸 텍스트 스타일 (슈퍼 점프와 동일한 글자체 및 크기) */
        .board-space[data-space="3"] .space-name,
        .board-space[data-space="9"] .space-name,
        .board-space[data-space="15"] .space-name,
        .board-space[data-space="21"] .space-name {
            font-family: inherit !important;
            font-size: clamp(8px, 2.2vw, 16px) !important;
            font-weight: bold !important;
            color: #8B4513 !important;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3) !important;
            text-align: center !important;
            line-height: 1.2 !important;
            letter-spacing: 0.5px !important;
        }

        /* 모노폴리 스타일 보드 칸 배치 */
        .corner-space {
            background: var(--color-corner) !important;
            color: white;
            font-weight: bold;
            border: 1px solid var(--color-corner) !important; /* 일반 칸과 두께 통일 */
            font-size: 12px;
        }

        .side-space {
            min-height: 20px;
        }

        .center-space {
            background: var(--color-center) !important;
            color: #000;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            border: 1px solid var(--color-corner);
        }

        /* 황금 열쇠 칸 스타일 */
        .space-content {
            font-size: 24px;
            text-align: center;
            margin-top: 5px;
            line-height: 1;
        }

        /* 땅 내용 래퍼 스타일 */
        .space-content-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
        }

        /* 별 표시 스타일 */
        .star-display {
            font-size: clamp(11px, 2.8vw, 22px);
            line-height: 1;
            text-align: center;
            margin-top: 5px;
        }

        /* 황금 열쇠 칸 텍스트 스타일 (슈퍼 점프와 동일한 글자체 및 크기) */
        .board-space[data-space="3"] .space-name,
        .board-space[data-space="9"] .space-name,
        .board-space[data-space="15"] .space-name,
        .board-space[data-space="21"] .space-name {
            font-family: inherit !important;
            font-size: clamp(8px, 2.2vw, 16px) !important;
            font-weight: bold !important;
            color: #8B4513 !important;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3) !important;
            text-align: center !important;
            line-height: 1.2 !important;
            letter-spacing: 0.5px !important;
        }
    </style>
</head>
<body>
    <!-- 🎮 메인 게임 컨테이너 -->
    <div class="game-container">
        <!-- 🏠 게임 보드 -->
        <div class="board-container">
            <div class="game-board" id="gameBoard">
                <!-- 보드 칸들이 JavaScript로 동적 생성됩니다 -->
            </div>

            <!-- 🎲 중앙 주사위 컨트롤 -->
            <div class="center-dice-controls">
                <div class="dice-controls">
                        <div class="dice-display" id="diceDisplay">
                            <svg class="dice-icon" id="diceIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect width="18" height="18" x="3" y="3" rx="2" ry="2" fill="white" stroke="#374151" stroke-width="1"/>
                                <circle cx="8" cy="8" r="1" fill="#374151"/>
                                <circle cx="8" cy="16" r="1" fill="#374151"/>
                                <circle cx="12" cy="12" r="1" fill="#374151"/>
                                <circle cx="16" cy="8" r="1" fill="#374151"/>
                                <circle cx="16" cy="16" r="1" fill="#374151"/>
                            </svg>
                        </div>
                    <button class="control-button" id="rollDiceBtn" onclick="rollDice()">
                            <span id="buttonText">Touch</span>
                    </button>
                </div>
                </div>
            </div>
            
        <!-- 👥 플레이어 정보 패널 -->
        <div class="player-panel">
            <!-- 상단 버튼들 -->
            <!-- 테스트 모드 체크박스 -->
            <div class="test-mode-container">
                <input type="checkbox" id="testModeCheckbox" class="test-mode-checkbox" checked>
                <label for="testModeCheckbox" class="test-mode-label">테스트 모드</label>
            </div>

            <!-- 패널 버튼들 -->
            <div class="panel-buttons">
                <button class="settings-button" id="settingsBtn" onclick="openSettings()" title="게임 설정">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    <span>설정</span>
                </button>

                <button class="fullscreen-button" id="fullscreenBtn" onclick="toggleFullscreen()" title="전체화면 토글">
                    <div class="fullscreen-icon" id="fullscreenIcon">
                        <!-- 확대 아이콘 (기본 상태) -->
                        <svg class="expand-icon" viewBox="0 0 20 20" width="16" height="16">
                            <g transform="translate(10, 10) rotate(45)">
                                <path d="M -1 0 L -13 0" stroke="#333" stroke-width="1.5" fill="none"/>
                                <path d="M -9 -4 L -13 0 L -9 4" stroke="#333" stroke-width="1.5" fill="none" stroke-linejoin="round"/>
                                <path d="M 1 0 L 13 0" stroke="#333" stroke-width="1.5" fill="none"/>
                                <path d="M 9 -4 L 13 0 L 9 4" stroke="#333" stroke-width="1.5" fill="none" stroke-linejoin="round"/>
                            </g>
                        </svg>
                        <!-- 축소 아이콘 (전체화면 상태) -->
                        <svg class="minimize-icon" viewBox="0 0 20 20" width="16" height="16">
                            <g transform="translate(10, 10) rotate(45)">
                                <path d="M 13 0 L 1 0" stroke="#333" stroke-width="1.5" fill="none"/>
                                <path d="M 5 -4 L 1 0 L 5 4" stroke="#333" stroke-width="1.5" fill="none" stroke-linejoin="round"/>
                                <path d="M -13 0 L -1 0" stroke="#333" stroke-width="1.5" fill="none"/>
                                <path d="M -5 -4 L -1 0 L -5 4" stroke="#333" stroke-width="1.5" fill="none" stroke-linejoin="round"/>
                            </g>
                        </svg>
                    </div>
                    <span>전체화면</span>
                </button>
            </div>

            <!-- 플레이어 정보 -->
            <div class="players-section" id="players-section">
                <!-- 플레이어 카드들이 동적으로 생성됩니다 -->
            </div>
        </div>
    </div>

    <!-- 퀴즈 팝업 -->
    <div class="popup-overlay" id="quizPopup">
        <div class="popup-container">
            <h2 class="popup-title">🧠 퀴즈 도전!</h2>
            <div class="popup-content" id="quizContent">
                <p id="quizQuestion">문제가 로드 중입니다...</p>
                <div id="quizOptions"></div>
                <div id="quizTimer">⏰ 남은 시간: <span id="timeLeft">30</span>초</div>
            </div>
        </div>
    </div>

    <!-- 황금 열쇠 팝업 -->
    <div class="popup-overlay" id="goldenKeyPopup">
        <div class="popup-container">
            <h2 class="popup-title" id="eventTitle">✨ 황금 열쇠 이벤트!</h2>
            <div class="popup-content" id="eventContent">
                <p id="eventDescription">이벤트가 로드 중입니다...</p>
            </div>
            <button class="popup-button" onclick="closeGoldenKey()">확인</button>
        </div>
    </div>

    <!-- 황금 열쇠 이벤트 팝업 -->
    <div class="golden-discovery-popup" id="goldenDiscoveryPopup">
        <div class="golden-event-title" id="discoveryEventTitle">✨ 황금 열쇠 이벤트!</div>
        <div class="golden-event-content" id="discoveryEventContent">
            <p id="discoveryEventDescription">이벤트가 로드 중입니다...</p>
            <div class="mystery-box-result" id="mysteryBoxResult" style="display: none;">
                <p id="mysteryBoxResultText"></p>
            </div>
        </div>
        <div class="golden-event-actions">
            <button class="btn-confirm" onclick="closeGoldenDiscovery()">확인</button>
        </div>
    </div>

    <!-- 턴 전환 알림 팝업 -->
    <div class="popup-overlay" id="turnNotificationPopup">
        <div class="popup-container">
            <h2 class="popup-title">🎮 턴 전환</h2>
            <div class="popup-content">
                <p id="turnNotificationText">플레이어 2의 차례입니다.</p>
            </div>
            <button class="popup-button" onclick="closeTurnNotification()">확인</button>
        </div>
    </div>

    <!-- 플레이어 선택 팝업 (위치 교환용) -->
    <div class="popup-overlay" id="playerSelectionPopup">
        <div class="popup-container">
            <h2 class="popup-title">✨ 위치 교환</h2>
            <div class="popup-content">
                <p>위치를 바꿀 플레이어를 선택하세요:</p>
                <div id="playerSelectionList" class="player-selection-list">
                    <!-- 플레이어 목록이 동적으로 생성됩니다 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 위치 선택 팝업 (순간이동용) -->
    <div class="popup-overlay" id="positionSelectionPopup">
        <div class="popup-container">
            <h2 class="popup-title">⚡ 순간이동</h2>
            <div class="popup-content">
                <p>이동할 위치를 선택하세요:</p>
                <div id="positionSelectionGrid" class="position-selection-grid">
                    <!-- 위치 목록이 동적으로 생성됩니다 -->
                </div>
            </div>
        </div>
    </div>


    <!-- 설정 관리 스크립트 -->
    
    <script>
        // 숫자 포맷팅 유틸리티 함수
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // 플레이어 아바타 색상 상수 정의 (모던 라이트 톤)
        const DEFAULT_PLAYER_COLORS = {
            PLAYER1: '#FF5722',  // 딥 오렌지
            PLAYER2: '#4CAF50',  // 그린
            PLAYER3: '#9C27B0',  // 퍼플
            PLAYER4: '#FF9800'   // 오렌지
        };

        // 배열 형태로도 제공 (인덱스 기반 접근용)
        const DEFAULT_PLAYER_COLORS_ARRAY = [
            DEFAULT_PLAYER_COLORS.PLAYER1,
            DEFAULT_PLAYER_COLORS.PLAYER2,
            DEFAULT_PLAYER_COLORS.PLAYER3,
            DEFAULT_PLAYER_COLORS.PLAYER4
        ];

        // 게임 상태 관리 클래스
        class GameStateManager {
            constructor() {
                this.state = {
            players: [
                        { id: 1, name: '플레이어 1', color: DEFAULT_PLAYER_COLORS.PLAYER1, position: 0, score: 1000, isActive: true, isWaitJump: false, hasSuperJumpChance: false, isOnIsland: false, islandTurnCount: 0, islandQuizStreak: 0 },
                        { id: 2, name: '플레이어 2', color: DEFAULT_PLAYER_COLORS.PLAYER2, position: 0, score: 1000, isActive: false, isWaitJump: false, hasSuperJumpChance: false, isOnIsland: false, islandTurnCount: 0, islandQuizStreak: 0 },
                        { id: 3, name: '플레이어 3', color: DEFAULT_PLAYER_COLORS.PLAYER3, position: 0, score: 1000, isActive: false, isWaitJump: false, hasSuperJumpChance: false, isOnIsland: false, islandTurnCount: 0, islandQuizStreak: 0 },
                        { id: 4, name: '플레이어 4', color: DEFAULT_PLAYER_COLORS.PLAYER4, position: 0, score: 1000, isActive: false, isWaitJump: false, hasSuperJumpChance: false, isOnIsland: false, islandTurnCount: 0, islandQuizStreak: 0 }
            ],
            currentPlayer: 1,
            gamePhase: 'waiting',
            diceValue: 0,
                    // 특수 모드 관리
                    modes: {
                        superJump: { active: false, failed: false },
                        goldenKey: { active: false, event: null },
                        island: { active: false, escapePhase: null, justEscaped: false }
                    }
                };
            }

            // 상태 업데이트
            updateState(updates) {
                Object.assign(this.state, updates);
                this.notifyStateChange();
            }

            // 특수 모드 관리
            setMode(modeName, modeData) {
                this.state.modes[modeName] = { ...this.state.modes[modeName], ...modeData };
                this.notifyStateChange();
            }

            // 현재 플레이어 가져오기
            getCurrentPlayer() {
                return this.state.players.find(p => p.id === this.state.currentPlayer);
            }

            // 상태 변경 알림
            notifyStateChange() {
                // UI 업데이트 트리거
                if (window.updateUI) {
                    window.updateUI();
                }
            }
        }

        // 게임 상태 인스턴스
        const gameStateManager = new GameStateManager();
        const gameState = gameStateManager.state; // 기존 코드 호환성을 위한 참조

        // 팝업 관리 시스템
        class PopupManager {
            constructor() {
                this.activePopups = new Set();
                this.popupQueue = [];
            }

            // 팝업 표시
            show(popupId, options = {}) {
                const popup = document.getElementById(popupId);
                if (!popup) return;

                // 기존 팝업이 있으면 큐에 추가
                if (this.activePopups.size > 0) {
                    this.popupQueue.push({ popupId, options });
                    return;
                }

                this.activePopups.add(popupId);
                
                // 스타일 적용
                if (options.theme) {
                    popup.classList.add(`${options.theme}-mode`);
                }

                // 내용 업데이트
                if (options.title) {
                    const titleEl = popup.querySelector('.popup-title');
                    if (titleEl) titleEl.textContent = options.title;
                }
                if (options.content) {
                    const contentEl = popup.querySelector('.popup-content');
                    if (contentEl) contentEl.innerHTML = options.content;
                }

                popup.classList.add('show');
            }

            // 팝업 닫기
            close(popupId, callback = null) {
                const popup = document.getElementById(popupId);
                if (!popup) return;

                popup.classList.remove('show');
                popup.classList.remove('super-jump-mode', 'golden-key-mode');
                this.activePopups.delete(popupId);

                // 콜백 실행
                if (callback) {
                    setTimeout(callback, 300); // 애니메이션 완료 후
                }

                // 큐에서 다음 팝업 처리
                if (this.popupQueue.length > 0) {
                    const next = this.popupQueue.shift();
                    setTimeout(() => this.show(next.popupId, next.options), 100);
                }
            }

            // 모든 팝업 닫기
            closeAll() {
                this.activePopups.forEach(popupId => {
                    const popup = document.getElementById(popupId);
                    if (popup) {
                        popup.classList.remove('show');
                        popup.classList.remove('super-jump-mode', 'golden-key-mode');
                    }
                });
                this.activePopups.clear();
                this.popupQueue = [];
            }
        }

        // 팝업 매니저 인스턴스
        const popupManager = new PopupManager();

        // 이벤트 처리 시스템
        class EventHandler {
            constructor() {
                this.eventHandlers = new Map();
            }

            // 이벤트 등록
            on(eventType, handler) {
                if (!this.eventHandlers.has(eventType)) {
                    this.eventHandlers.set(eventType, []);
                }
                this.eventHandlers.get(eventType).push(handler);
            }

            // 이벤트 발생
            emit(eventType, data = {}) {
                const handlers = this.eventHandlers.get(eventType);
                if (handlers) {
                    handlers.forEach(handler => handler(data));
                }
            }

            // 이벤트 제거
            off(eventType, handler) {
                const handlers = this.eventHandlers.get(eventType);
                if (handlers) {
                    const index = handlers.indexOf(handler);
                    if (index > -1) {
                        handlers.splice(index, 1);
                    }
                }
            }
        }

        // 이벤트 핸들러 인스턴스
        const eventHandler = new EventHandler();

        // 게임 이벤트 정의
        const GAME_EVENTS = {
            TURN_START: 'turnStart',
            TURN_END: 'turnEnd',
            PLAYER_MOVE: 'playerMove',
            QUIZ_START: 'quizStart',
            QUIZ_END: 'quizEnd',
            SUPER_JUMP_START: 'superJumpStart',
            SUPER_JUMP_END: 'superJumpEnd',
            GOLDEN_KEY_FOUND: 'goldenKeyFound',
            SPACE_ACTION: 'spaceAction'
        };

        // 주사위 버튼 상태 관리 (개선된 버전)
        class DiceButtonManager {
            constructor() {
                this.button = document.getElementById('rollDiceBtn');
                this.currentState = 'disabled';
                this.stateClasses = ['dice-button-active', 'dice-button-disabled', 'dice-button-urgent'];
                this.stateRules = new Map([
                    ['superJumpMode', () => this.setState('disabled')],
                    ['teleportMode', () => this.setState('disabled')],
                    ['superJumpFailed', () => this.setState('active', true)],
                    ['waiting', () => this.setState('active')],
                    ['default', () => this.setState('disabled')]
                ]);
            }

            // 버튼 상태 설정 (최적화된 버전)
            setState(state, urgent = false) {
                if (!this.button) return;

                // 기존 상태 클래스 제거 (배치 처리)
                this.button.classList.remove(...this.stateClasses);

                // 새 상태 클래스 추가
                const stateClass = urgent ? 'dice-button-urgent' : `dice-button-${state}`;
                this.button.classList.add(stateClass);
                this.button.disabled = state === 'disabled';
                this.currentState = state;
            }

            // 게임 상태에 따른 자동 상태 설정 (규칙 기반)
            updateFromGameState() {
                const { gamePhase, superJumpMode, teleportMode, superJumpFailed, modes } = gameState;
                const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
                
                // 규칙 우선순위에 따라 실행
                if (superJumpMode) {
                    this.stateRules.get('superJumpMode')();
                } else if (teleportMode) {
                    this.stateRules.get('teleportMode')();
                } else if (currentPlayer && currentPlayer.isOnIsland) {
                    this.setState('disabled'); // 무인도에 갇힌 플레이어는 주사위 비활성화
                } else if (modes.island.justEscaped) {
                    this.setState('active'); // 무인도에서 방금 탈출한 플레이어는 주사위 활성화
                } else if (superJumpFailed) {
                    this.stateRules.get('superJumpFailed')();
                } else if (gamePhase === 'waiting') {
                    this.stateRules.get('waiting')();
                } else {
                    this.stateRules.get('default')();
                }
            }

            // 새로운 상태 규칙 추가 (확장성)
            addStateRule(condition, action) {
                this.stateRules.set(condition, action);
            }

            // 현재 상태 반환
            getCurrentState() {
                return this.currentState;
            }
        }

        // 주사위 버튼 매니저 인스턴스
        const diceButtonManager = new DiceButtonManager();

        // 게임 상태 모니터링 시스템
        class GameStateMonitor {
            constructor() {
                this.lastActionTime = Date.now();
                this.monitorInterval = null;
                this.isMonitoring = false;
                this.stuckThreshold = 5000; // 5초
                this.warningTime = 3000; // 3초 경고
            }

            // 모니터링 시작
            startMonitoring() {
                if (this.monitorInterval) return;
                
                this.isMonitoring = true;
                this.lastActionTime = Date.now();
                
                this.monitorInterval = setInterval(() => {
                    this.checkGameState();
                }, 1000); // 1초마다 체크
            }

            // 모니터링 중지
            stopMonitoring() {
                if (this.monitorInterval) {
                    clearInterval(this.monitorInterval);
                    this.monitorInterval = null;
                }
                this.isMonitoring = false;
            }

            // 게임 액션 발생 시 호출
            recordAction() {
                this.lastActionTime = Date.now();
            }

            // 게임 상태 체크
            checkGameState() {
                if (!this.isMonitoring) return;

                const currentTime = Date.now();
                const timeSinceLastAction = currentTime - this.lastActionTime;

                // 5초 이상 게임이 멈춰있고, 주사위 버튼이 비활성화된 경우
                if (timeSinceLastAction >= this.stuckThreshold) {
                    const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
                    const isStuck = this.isGameStuck(currentPlayer);
                    
                    if (isStuck) {
                        this.showAutoResetWarning();
                    }
                }
            }

            // 게임이 멈춰있는지 확인
            isGameStuck(currentPlayer) {
                // 주사위 버튼이 비활성화되어 있고
                const diceButton = document.getElementById('rollDiceBtn');
                if (!diceButton || diceButton.disabled) {
                    // 슈퍼 점프 모드가 아니고
                    if (!gameState.superJumpMode) {
                        // 무인도에 갇힌 플레이어가 아니거나 3턴째 이상인 경우
                        if (!currentPlayer?.isOnIsland || currentPlayer.islandTurnCount >= 3) {
                            // 게임 페이즈가 waiting이 아닌 경우
                            if (gameState.gamePhase !== 'waiting') {
                                return true;
                            }
                        }
                    }
                }
                return false;
            }

            // 자동 활성화 경고 표시
            showAutoResetWarning() {
                // 이미 경고가 표시 중이면 중복 표시하지 않음
                if (document.querySelector('.auto-reset-warning')) return;

                const warningDiv = document.createElement('div');
                warningDiv.className = 'auto-reset-warning';
                warningDiv.innerHTML = `
                    <div class="warning-content">
                        <h3>⚠️ 게임이 멈춰있습니다</h3>
                        <p>게임을 다시 활성화합니다...</p>
                        <div class="countdown">3</div>
                    </div>
                `;

                // 스타일 적용
                warningDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(135deg, #ff6b6b, #ee5a24);
                    color: white;
                    padding: 30px;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                    z-index: 10000;
                    text-align: center;
                    font-family: inherit;
                `;

                warningDiv.querySelector('.warning-content h3').style.cssText = `
                    margin: 0 0 15px 0;
                    font-size: 1.5em;
                    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
                `;

                warningDiv.querySelector('.warning-content p').style.cssText = `
                    margin: 0 0 20px 0;
                    font-size: 1.1em;
                `;

                warningDiv.querySelector('.countdown').style.cssText = `
                    font-size: 3em;
                    font-weight: bold;
                    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
                    animation: countdownPulse 1s ease-in-out infinite;
                `;

                document.body.appendChild(warningDiv);

                // 카운트다운 애니메이션
                let countdown = 3;
                const countdownElement = warningDiv.querySelector('.countdown');
                const countdownInterval = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        countdownElement.textContent = countdown;
                    } else {
                        clearInterval(countdownInterval);
                        this.performAutoReset();
                        warningDiv.remove();
                    }
                }, 1000);

                // CSS 애니메이션 추가
                if (!document.querySelector('#countdown-animation')) {
                    const style = document.createElement('style');
                    style.id = 'countdown-animation';
                    style.textContent = `
                        @keyframes countdownPulse {
                            0%, 100% { transform: scale(1); }
                            50% { transform: scale(1.2); }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }

            // 자동 활성화 실행
            performAutoReset() {
                
                // 게임 상태 강제 활성화
                gameState.gamePhase = 'waiting';
                gameState.superJumpMode = false;
                gameState.teleportMode = false;
                gameState.superJumpFailed = false;
                
                // 모든 모드 플래그 활성화
                gameState.modes.superJump.active = false;
                gameState.modes.superJump.failed = false;
                gameState.modes.island.justEscaped = false;
                
                // 주사위 버튼 상태 업데이트
                diceButtonManager.updateFromGameState();
                
                // UI 업데이트
                updateUI();
                
                // 액션 기록 (모니터링 재시작)
                this.recordAction();
                
                // 알림 메시지
                showMessage('게임이 다시 활성화되었습니다.');
            }
        }

        // 게임 상태 모니터 인스턴스
        const gameStateMonitor = new GameStateMonitor();

        // 무인도 관리 클래스
        class IslandManager {
            constructor() {
                this.islandIndicator = null;
            }

            // 무인도에 플레이어 투입
            putPlayerOnIsland(playerId) {
                const player = gameState.players.find(p => p.id === playerId);
                if (!player) return;

                player.isOnIsland = true;
                player.islandTurnCount = 0; // 무인도 투입 시 0으로 시작
                player.islandQuizStreak = 0;
                player.position = 12; // 무인도 위치 (12번 칸)

                gameState.modes.island.active = true;
                gameState.modes.island.escapePhase = 'first';

                // this.showIslandIndicator(); // 무인도 모드 배너 제거
                showIslandPopup(player.name);
                updatePlayerPieces();
            }

            // 무인도 탈출 시도
            attemptIslandEscape(playerId) {
                const player = gameState.players.find(p => p.id === playerId);
                if (!player || !player.isOnIsland) {
                    return;
                }

                // 턴 카운트 증가 (한 바퀴 돌아서 자기 차례가 되었을 때)
                player.islandTurnCount++;

                if (player.islandTurnCount === 1) {
                    // 첫 번째 턴: 2문제 연속 정답 필요
                    gameState.modes.island.escapePhase = 'first';
                    this.showIslandQuiz(player, 2);
                } else if (player.islandTurnCount === 2) {
                    // 두 번째 턴: 1문제 정답 필요
                    gameState.modes.island.escapePhase = 'second';
                    this.showIslandQuiz(player, 1);
                } else if (player.islandTurnCount >= 3) {
                    // 세 번째 턴 이상: 주사위로 탈출
                    this.diceEscape(player);
                } else {
                    // 예상치 못한 상황
                }
            }

            // 무인도 퀴즈 표시
            showIslandQuiz(player, requiredStreak) {
                
                // 퀴즈 시작 (showQuiz 함수가 무인도 모드를 자동으로 인식함)
                try {
                    showQuiz();
                } catch (error) {
                }
            }

            // 퀴즈 정답 처리
            handleIslandQuizAnswer(playerId, isCorrect) {
                const player = gameState.players.find(p => p.id === playerId);
                if (!player || !player.isOnIsland) return;

                if (isCorrect) {
                    player.islandQuizStreak++;
                    
                    if (player.islandTurnCount === 1 && player.islandQuizStreak >= 2) {
                        // 첫 번째 턴에서 2문제 연속 정답
                        this.successfulEscape(player);
                    } else if (player.islandTurnCount === 2 && player.islandQuizStreak >= 1) {
                        // 두 번째 턴에서 1문제 정답
                        this.successfulEscape(player);
                    } else if (player.islandTurnCount === 1 && player.islandQuizStreak < 2) {
                        // 첫 번째 턴에서 아직 2문제 미달성
                        showMessage(`정답! ${2 - player.islandQuizStreak}문제 더 맞춰주세요!`);
                        setTimeout(() => showQuiz(), 1000);
                    }
                } else {
                    // 오답 시 연속 정답 활성화 (턴 카운트는 attemptIslandEscape에서 증가)
                    player.islandQuizStreak = 0;
                    showMessage('틀렸습니다! 다음 턴에 다시 도전하세요.');
                    closeQuiz();
                    
                    // 턴 전환
                    setTimeout(() => {
                        endTurn();
                    }, 1500);
                }
            }

            // 성공적인 탈출
            successfulEscape(player) {
                player.isOnIsland = false;
                player.islandTurnCount = 0;
                player.islandQuizStreak = 0;
                
                gameState.modes.island.active = false;
                gameState.modes.island.escapePhase = null;
                gameState.modes.island.justEscaped = true; // 무인도에서 방금 탈출했음을 표시

                // this.hideIslandIndicator(); // 무인도 모드 배너 제거
                closeQuiz();

                // 탈출 성공 안내 팝업 표시
                showIslandEscapeSuccessPopup(player);
            }

            // 주사위 탈출 (3턴째 이상)
            diceEscape(player) {
                player.isOnIsland = false;
                player.islandTurnCount = 0;
                player.islandQuizStreak = 0;
                
                gameState.modes.island.active = false;
                gameState.modes.island.escapePhase = null;
                gameState.modes.island.justEscaped = true; // 무인도에서 방금 탈출했음을 표시

                // this.hideIslandIndicator(); // 무인도 모드 배너 제거
                
                // 주사위 탈출 성공 안내 팝업 표시
                showIslandDiceEscapeSuccessPopup(player);
            }

            // 무인도 표시기 표시
            showIslandIndicator() {
                if (this.jailIndicator) return;
                
                // 무인도에 갇힌 플레이어가 있는지 확인
                if (!this.hasIslandPlayers()) return;

                this.jailIndicator = document.createElement('div');
                this.jailIndicator.className = 'island-mode-indicator';
                this.jailIndicator.textContent = '🏝️ 무인도 모드';
                document.body.appendChild(this.jailIndicator);
            }

            // 무인도 표시기 숨기기
            hideIslandIndicator() {
                if (this.jailIndicator) {
                    this.jailIndicator.remove();
                    this.jailIndicator = null;
                }
            }

                // 무인도에 갇힌 플레이어가 있는지 확인
            hasIslandPlayers() {
                return gameState.players.some(player => player.isOnIsland);
            }

            // 현재 플레이어가 무인도에 있는지 확인
            isCurrentPlayerOnIsland() {
                const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
                return currentPlayer && currentPlayer.isOnIsland;
            }
        }

        // 무인도 매니저 인스턴스
        const islandManager = new IslandManager();

        // 무인도 탈출 성공 팝업 표시
        function showIslandEscapeSuccessPopup(player) {
            const popup = document.getElementById('turnNotificationPopup');
            const titleEl = popup.querySelector('.popup-title');
            const contentEl = popup.querySelector('.popup-content');
            const buttonEl = popup.querySelector('.popup-button');

            titleEl.textContent = '🎉 무인도 탈출 성공!';
            contentEl.innerHTML = `<p>${player.name}이 무인도에서 탈출했습니다!</p><p>주사위를 굴려 이동하세요.</p>`;
            buttonEl.textContent = '확인';
            buttonEl.onclick = () => {
                closeIslandEscapeSuccessPopup();
            };
            // 무인도 색상 테마 제거 (성공 메시지는 일반 색상 사용)
            popup.classList.remove('island-mode');
            popup.classList.add('show');
        }

        // 기부 천사 전용 팝업 표시
        function showAngelPopup(playerCount) {
            const popup = document.getElementById('turnNotificationPopup');
            const titleEl = popup.querySelector('.popup-title');
            const contentEl = popup.querySelector('.popup-content');
            const buttonEl = popup.querySelector('.popup-button');

            titleEl.textContent = '😇 기부 천사!';
            contentEl.innerHTML = `<p>기부 천사가 되어 다른 플레이어 ${playerCount}명에게 각각 200점을 선물했습니다!</p><p>모든 플레이어가 더 행복해졌어요! 💕</p>`;
            
            buttonEl.textContent = '확인';
            buttonEl.onclick = () => {
                closeAngelPopup();
            };
            
            // 기부 천사 색상 테마 적용
            popup.classList.add('donation-mode');
            popup.classList.add('show');
        }

        // 기부 천사 팝업 닫기
        function closeAngelPopup() {
            const popup = document.getElementById('turnNotificationPopup');
            popup.classList.remove('show');
            popup.classList.remove('donation-mode');
            
            // 기부 천사 팝업 확인 후 턴 전환
            setTimeout(() => {
                try {
                    endTurn();
                } catch (error) {
                    console.error('기부 천사 팝업 후 endTurn 에러:', error);
                    // 에러 발생 시 기본 턴 전환 처리
                    const currentPlayerIndex = gameState.players.findIndex(p => p.id === gameState.currentPlayer);
                    if (currentPlayerIndex === -1) {
                        console.error('기부 천사 팝업 에러 처리 중 현재 플레이어를 찾을 수 없습니다:', gameState.currentPlayer);
                        return;
                    }
                    const nextPlayerIndex = (currentPlayerIndex + 1) % gameState.players.length;
                    gameState.currentPlayer = gameState.players[nextPlayerIndex].id;
                    gameState.gamePhase = 'waiting';
                    updateUI();
                }
            }, 500); // 0.5초 후 턴 전환
        }

        // 무인도 전용 팝업 표시
        function showIslandPopup(playerName) {
            const popup = document.getElementById('turnNotificationPopup');
            const titleEl = popup.querySelector('.popup-title');
            const contentEl = popup.querySelector('.popup-content');
            const buttonEl = popup.querySelector('.popup-button');

            titleEl.textContent = '🏝️ 무인도에 갇혔습니다!';
            contentEl.innerHTML = `<p>${playerName}이 무인도에 갇혔습니다!</p><p>무인도에서 탈출하려면 퀴즈를 맞춰야 합니다.</p>`;
            
            buttonEl.textContent = '확인';
            buttonEl.onclick = () => {
                closeIslandPopup();
            };
            
            // 무인도 색상 테마 적용
            popup.classList.add('island-mode');
            popup.classList.add('show');
        }

        // 무인도 팝업 닫기
        function closeIslandPopup() {
            const popup = document.getElementById('turnNotificationPopup');
            popup.classList.remove('island-mode');
            popup.classList.remove('show');
            
            // 무인도 팝업 확인 후 턴 전환
            setTimeout(() => {
                try {
                    endTurn();
                } catch (error) {
                    console.error('무인도 팝업 후 endTurn 에러:', error);
                    // 에러 발생 시 기본 턴 전환 처리
                    const currentPlayerIndex = gameState.players.findIndex(p => p.id === gameState.currentPlayer);
                    if (currentPlayerIndex === -1) {
                        console.error('무인도 팝업 에러 처리 중 현재 플레이어를 찾을 수 없습니다:', gameState.currentPlayer);
                        return;
                    }
                    const nextPlayerIndex = (currentPlayerIndex + 1) % gameState.players.length;
                    gameState.currentPlayer = gameState.players[nextPlayerIndex].id;
                    gameState.gamePhase = 'waiting';
                    updateUI();
                }
            }, 500); // 0.5초 후 턴 전환
        }

        // 슈퍼 점프 전용 팝업 표시
        function showSuperJumpPopup(playerName) {
            const popup = document.getElementById('turnNotificationPopup');
            const titleEl = popup.querySelector('.popup-title');
            const contentEl = popup.querySelector('.popup-content');
            const buttonEl = popup.querySelector('.popup-button');

            titleEl.textContent = '⚡ 슈퍼 점프!';
            contentEl.innerHTML = `<p>${playerName}이 슈퍼 점프 칸에 도착했습니다!</p><p>다음 차례에 퀴즈를 맞춰 원하는 곳으로 이동할 수 있습니다.</p>`;
            
            buttonEl.textContent = '확인';
            buttonEl.onclick = () => {
                closeSuperJumpPopup();
            };
            
            // 슈퍼 점프 색상 테마 적용
            popup.classList.add('super-jump-mode');
            popup.classList.add('show');
        }

        // 슈퍼 점프 팝업 닫기
        function closeSuperJumpPopup() {
            const popup = document.getElementById('turnNotificationPopup');
            popup.classList.remove('super-jump-mode');
            popup.classList.remove('show');
            
            // 슈퍼 점프 팝업 확인 후 턴 전환
            setTimeout(() => {
                try {
                    endTurn();
                } catch (error) {
                    console.error('슈퍼 점프 팝업 후 endTurn 에러:', error);
                    // 에러 발생 시 기본 턴 전환 처리
                    const currentPlayerIndex = gameState.players.findIndex(p => p.id === gameState.currentPlayer);
                    if (currentPlayerIndex === -1) {
                        console.error('슈퍼 점프 팝업 에러 처리 중 현재 플레이어를 찾을 수 없습니다:', gameState.currentPlayer);
                        return;
                    }
                    const nextPlayerIndex = (currentPlayerIndex + 1) % gameState.players.length;
                    gameState.currentPlayer = gameState.players[nextPlayerIndex].id;
                    gameState.gamePhase = 'waiting';
                    updateUI();
                }
            }, 500); // 0.5초 후 턴 전환
        }

        // 무인도 탈출 성공 팝업 닫기
        function closeIslandEscapeSuccessPopup() {
            const popup = document.getElementById('turnNotificationPopup');
            popup.classList.remove('show');
            
            // 무인도 탈출 플래그 활성화 (주사위 굴린 후 턴 전환을 위해)
            gameState.modes.island.justEscaped = false;
            
            // 무인도에서 탈출한 플레이어는 바로 주사위를 굴릴 수 있도록 설정
            gameState.gamePhase = 'waiting';
            diceButtonManager.updateFromGameState();
            updateUI();
        }

        // 무인도 주사위 탈출 성공 팝업 표시
        function showIslandDiceEscapeSuccessPopup(player) {
            const popup = document.getElementById('turnNotificationPopup');
            const titleEl = popup.querySelector('.popup-title');
            const contentEl = popup.querySelector('.popup-content');
            const buttonEl = popup.querySelector('.popup-button');

            titleEl.textContent = '🎲 무인도에서 주사위 탈출!';
            contentEl.innerHTML = `<p>${player.name}이 무인도에서 주사위로 탈출했습니다!</p><p>주사위를 굴려 이동하세요.</p>`;
            buttonEl.textContent = '확인';
            buttonEl.onclick = () => {
                closeIslandEscapeSuccessPopup();
            };

            popup.classList.add('show');
        }


        // 모바일 뷰포트 높이 문제 해결 함수
        function setViewportHeight() {
            // 실제 뷰포트 높이를 가져옵니다 (브라우저 UI 제외)
            const vh = window.innerHeight * 0.01;
            // CSS 변수 --vh에 값을 설정합니다
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }

        // 뷰포트 높이 설정 이벤트 리스너
        window.addEventListener('resize', setViewportHeight);
        window.addEventListener('orientationchange', setViewportHeight);
        window.addEventListener('load', setViewportHeight);
        
        // 페이지 로드 시 즉시 실행
        document.addEventListener('DOMContentLoaded', function() {
            setViewportHeight();
            createPlayerCards(); // 플레이어 카드 생성
        });





        // 7x7 보드 칸 데이터 (스크린샷 기준)
        const boardSpaces = [
            // 시작점 (0) - 우하단
            { id: 0, name: '시작', type: 'start', color: 'space-start' },
            // 하단 변 (1-5) - 오른쪽에서 왼쪽으로
            { id: 1, name: '겸손(1)', type: 'quiz', color: 'space-quiz' },
            { id: 2, name: '노력(2)', type: 'quiz', color: 'space-quiz' },
            { id: 3, name: '황금열쇠', type: 'golden', color: 'space-golden' },
            { id: 4, name: '정직(4)', type: 'quiz', color: 'space-quiz' },
            { id: 5, name: '신뢰(5)', type: 'quiz', color: 'space-quiz' },
            // 좌측 변 (7-11) - 아래에서 위로
            { id: 7, name: '친절(7)', type: 'quiz', color: 'space-quiz' },
            { id: 8, name: '성실(8)', type: 'quiz', color: 'space-quiz' },
            { id: 9, name: '황금열쇠', type: 'golden', color: 'space-golden' },
            { id: 10, name: '열정(10)', type: 'quiz', color: 'space-quiz' },
            { id: 11, name: '협력(11)', type: 'quiz', color: 'space-quiz' },
            // 상단 변 (13-17) - 왼쪽에서 오른쪽으로
            { id: 13, name: '감사(13)', type: 'quiz', color: 'space-quiz' },
            { id: 14, name: '소통(14)', type: 'quiz', color: 'space-quiz' },
            { id: 15, name: '황금열쇠', type: 'golden', color: 'space-golden' },
            { id: 16, name: '용기(16)', type: 'quiz', color: 'space-quiz' },
            { id: 17, name: '배려(17)', type: 'quiz', color: 'space-quiz' },
            // 우측 변 (19-23) - 위에서 아래로
            { id: 19, name: '나눔(19)', type: 'quiz', color: 'space-quiz' },
            { id: 20, name: '화합(20)', type: 'quiz', color: 'space-quiz' },
            { id: 21, name: '황금열쇠', type: 'golden', color: 'space-golden' },
            { id: 22, name: '존중(22)', type: 'quiz', color: 'space-quiz' },
            { id: 23, name: '사랑(23)', type: 'quiz', color: 'space-quiz' },
            // 특별 칸들 (모서리) - BoardColorTest.html과 동일하게 corner 타입으로 변경
            { id: 6, name: '슈퍼 점프', type: 'corner', color: 'space-corner' },
            { id: 12, name: '무인도', type: 'corner', color: 'space-corner' },
            { id: 18, name: '기부 천사', type: 'corner', color: 'space-corner' },
            { id: 24, name: '특별칸', type: 'special', color: 'space-special' }
        ];

        // 퀴즈 데이터
        // 퀴즈 문제 배열 (JSON 파일에서 로드됨)
        let quizQuestions = [];

        // JSON 파일에서 퀴즈 문제 로드
        async function loadQuizQuestions() {
            try {
                const response = await fetch('questions.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                quizQuestions = await response.json();
                console.log('퀴즈 문제 로드 완료:', quizQuestions.length, '개');
            } catch (error) {
                console.error('퀴즈 문제 로드 실패:', error);
                // 기본 문제로 폴백
                quizQuestions = [
                    {
                        question: "1 + 1은?",
                        options: ["1", "2", "3", "4"],
                        correct: 1,
                        points: 100
                    },
                    {
                        question: "태양계에서 가장 큰 행성은?",
                        options: ["지구", "목성", "토성", "화성"],
                        correct: 1,
                        points: 200
                    }
                ];
                console.log('기본 퀴즈 문제로 폴백');
            }
        }

        // 황금 열쇠 이벤트
        const goldenKeyEvents = [
            {
                name: "🚀 로켓 부스터",
                description: "즉시 출발지로 워프 이동! 통과 보너스 400점 획득!",
                effect: () => {
                    const player = gameState.players.find(p => p.id === gameState.currentPlayer);
                    player.position = 0;
                    player.score += 400;
                    
                    // 워프 이동으로 인해 슈퍼 점프 기회 취소 (무인도 상태는 유지)
                    if (player.hasSuperJumpChance) {
                        player.hasSuperJumpChance = false;
                    }
                    
                    updateUI();
                }
            },
            {
                name: "💰 복권 당첨",
                description: "축하합니다! 500점을 획득했습니다!",
                effect: () => {
                    const player = gameState.players.find(p => p.id === gameState.currentPlayer);
                    player.score += 500;
                    updateUI();
                }
            },
            {
                name: "🌪️ 토네이도 습격",
                description: "다른 플레이어들이 랜덤 위치로 흩어지고 50점씩 차감됩니다!",
                effect: () => {
                    const currentPlayerId = gameState.currentPlayer;
                    gameState.players.forEach(player => {
                        // 현재 플레이어(황금 열쇠에 도착한 플레이어)는 제외
                        if (player.id !== currentPlayerId) {
                            // 무인도에 있는 플레이어는 토네이도로 이동하지 않음
                            if (player.isOnIsland) {
                                return;
                            }
                            
                            // 토네이도로 랜덤 위치 이동 (무인도 제외)
                            let newPosition;
                            do {
                                newPosition = Math.floor(Math.random() * 24);
                            } while (newPosition === 12); // 무인도(12번 칸) 제외
                            
                            player.position = newPosition;
                            player.score = Math.max(0, player.score - 50);
                            
                            // 토네이도로 인해 이동한 경우 슈퍼 점프 기회 취소 (무인도 상태는 유지)
                            if (player.hasSuperJumpChance) {
                                player.hasSuperJumpChance = false;
                            }
                            
                        }
                    });
                    updatePlayerPieces();
                    updateUI();
                }
            },
            {
                name: "💎 다이아몬드 발견",
                description: "반짝이는 다이아몬드를 발견했습니다! 1000점을 획득했습니다!",
                effect: () => {
                    const player = gameState.players.find(p => p.id === gameState.currentPlayer);
                    player.score += 1000;
                    updateUI();
                }
            },
            {
                name: "⚡ 번개 이동",
                description: "번개처럼 빠르게 앞으로 10칸 이동합니다!",
                effect: () => {
                    const player = gameState.players.find(p => p.id === gameState.currentPlayer);
                    const currentPosition = player.position;
                    const newPosition = (currentPosition + 10) % 24; // 24칸 보드
                    
                    // 슈퍼 점프 대기 중인 플레이어를 다른 곳으로 이동시키는 경우
                    if (player.isWaitJump && newPosition !== 6) {
                        player.isWaitJump = false; // 슈퍼 점프 대기 상태 해제
                        showMessage(`⚡ 번개 이동! ${player.name}의 슈퍼 점프 대기 상태가 해제되었습니다.`);
                    }
                    
                    // 플레이어 위치 업데이트
                    player.position = newPosition;
                    
                    // 워프 이동으로 인해 슈퍼 점프 기회 취소 (무인도 상태는 유지)
                    if (player.hasSuperJumpChance) {
                        player.hasSuperJumpChance = false;
                    }
                    
                    // UI 업데이트
                    updatePlayerPieces();
                    updateUI();
                    
                    // 이동한 위치에서 이벤트 수행
                    setTimeout(() => {
                        handleSpaceEvent(newPosition);
                    }, 1000); // 1초 후 이벤트 실행
                }
            },
            {
                name: "🔄 위치 교환",
                description: "내가 원하는 다른 플레이어와 위치를 바꿉니다!",
                effect: () => {
                    // 플레이어 선택 UI 표시
                    showPlayerSelectionForPositionSwap();
                }
            },
            {
                name: "💣 폭탄 투척",
                description: "나를 제외한 모든 다른 플레이어들이 300점씩 차감됩니다!",
                effect: () => {
                    const currentPlayerId = gameState.currentPlayer;
                    let affectedPlayers = 0;
                    
                    gameState.players.forEach(player => {
                        // 현재 플레이어는 제외
                        if (player.id !== currentPlayerId) {
                            player.score = Math.max(0, player.score - 300);
                            affectedPlayers++;
                        }
                    });
                    
                    updateUI();
                    showMessage(`💣 폭탄 투척! ${affectedPlayers}명의 플레이어가 300점씩 차감되었습니다!`);
                }
            },
            {
                name: "📈 주식 급등",
                description: "현재 나의 점수가 25%만큼 추가로 증가합니다!",
                effect: () => {
                    const player = gameState.players.find(p => p.id === gameState.currentPlayer);
                    const currentScore = player.score;
                    const bonusPoints = Math.floor(currentScore * 0.25); // 25% 보너스
                    
                    player.score += bonusPoints;
                    updateUI();
                    showMessage(`📈 주식 급등! 현재 점수의 25%인 ${bonusPoints}점을 획득했습니다!`);
                }
            },
            {
                name: "💸 세금 고지서",
                description: "국세청에서 세금 고지서가 도착했습니다! 400점이 차감됩니다.",
                effect: () => {
                    const player = gameState.players.find(p => p.id === gameState.currentPlayer);
                    const deductedPoints = Math.min(400, player.score); // 현재 점수보다 많이 차감되지 않도록
                    player.score = Math.max(0, player.score - 400);
                    
                    updateUI();
                    showMessage(`💸 세금 고지서! ${deductedPoints}점이 차감되었습니다!`);
                }
            },
            {
                name: "🎁 생일 선물",
                description: "오늘이 생일입니다! 모든 플레이어로부터 100점씩 받습니다!",
                effect: () => {
                    const currentPlayerId = gameState.currentPlayer;
                    let totalReceived = 0;
                    
                    gameState.players.forEach(player => {
                        // 현재 플레이어는 제외
                        if (player.id !== currentPlayerId) {
                            const giftAmount = Math.min(100, player.score); // 현재 점수보다 많이 주지 않도록
                            player.score = Math.max(0, player.score - 100);
                            totalReceived += giftAmount;
                        }
                    });
                    
                    // 현재 플레이어가 받은 총 선물
                    const currentPlayer = gameState.players.find(p => p.id === currentPlayerId);
                    currentPlayer.score += totalReceived;
                    
                    updateUI();
                    showMessage(`🎁 생일 선물! 모든 플레이어로부터 총 ${totalReceived}점을 받았습니다!`);
                }
            },
            {
                name: "🌊 대홍수",
                description: "대홍수가 발생했습니다! 모든 플레이어가 시작점으로 이동!",
                effect: () => {
                    gameState.players.forEach(player => {
                        // 모든 플레이어를 시작점(0번)으로 이동
                        player.position = 0;
                        
                        // 특수 상태 초기화
                        player.isOnIsland = false;
                        player.islandTurnCount = 0;
                        player.islandQuizStreak = 0;
                        player.hasSuperJumpChance = false;
                        player.isWaitJump = false;
                    });
                    
                    updatePlayerPieces();
                    updateUI();
                    showMessage(`🌊 대홍수! 모든 플레이어가 시작점으로 이동했습니다!`);
                }
            },
            {
                name: "🎪 마술사의 모자",
                description: "마술사가 모자에서 토끼 대신 돈을 꺼냅니다! 600점 획득!",
                effect: () => {
                    const player = gameState.players.find(p => p.id === gameState.currentPlayer);
                    player.score += 600;
                    updateUI();
                    showMessage(`🎪 마술사의 모자! 토끼 대신 600점을 획득했습니다!`);
                }
            },
            {
                name: "🚂 기차표",
                description: "기차를 타고 여행을 떠납니다! 앞으로 8칸 이동!",
                effect: () => {
                    const player = gameState.players.find(p => p.id === gameState.currentPlayer);
                    const currentPosition = player.position;
                    const newPosition = (currentPosition + 8) % 24; // 24칸 보드
                    
                    // 슈퍼 점프 대기 중인 플레이어를 다른 곳으로 이동시키는 경우
                    if (player.isWaitJump && newPosition !== 6) {
                        player.isWaitJump = false; // 슈퍼 점프 대기 상태 해제
                        showMessage(`🚂 기차표! ${player.name}의 슈퍼 점프 대기 상태가 해제되었습니다.`);
                    }
                    
                    player.position = newPosition;
                    if (player.hasSuperJumpChance) {
                        player.hasSuperJumpChance = false;
                    }
                    updatePlayerPieces();
                    updateUI();
                    setTimeout(() => {
                        handleSpaceEvent(newPosition); // Call event for new position
                    }, 1000);
                }
            },
            {
                name: "🎊 축하 파티",
                description: "축하 파티가 열립니다! 점수가 가장 낮은 플레이어에게 700점 선물!",
                effect: () => {
                    // 점수가 가장 낮은 플레이어 찾기
                    let lowestScorePlayer = gameState.players[0];
                    let lowestScore = lowestScorePlayer.score;
                    
                    gameState.players.forEach(player => {
                        if (player.score < lowestScore) {
                            lowestScore = player.score;
                            lowestScorePlayer = player;
                        }
                    });
                    
                    // 가장 낮은 점수를 가진 플레이어에게 700점 추가
                    lowestScorePlayer.score += 700;
                    updateUI();
                    showMessage(`🎊 축하 파티! ${lowestScorePlayer.name}에게 700점을 선물했습니다!`);
                }
            },
            {
                name: "⚖️ 법정 소송",
                description: "법정 소송에서 승리했습니다! 모든 플레이어로부터 200점씩 받습니다!",
                effect: () => {
                    const currentPlayerId = gameState.currentPlayer;
                    let totalReceived = 0;
                    
                    gameState.players.forEach(player => {
                        // 현재 플레이어는 제외
                        if (player.id !== currentPlayerId) {
                            const compensationAmount = Math.min(200, player.score); // 현재 점수보다 많이 주지 않도록
                            player.score = Math.max(0, player.score - 200);
                            totalReceived += compensationAmount;
                        }
                    });
                    
                    // 현재 플레이어가 받은 총 배상금
                    const currentPlayer = gameState.players.find(p => p.id === currentPlayerId);
                    currentPlayer.score += totalReceived;
                    
                    updateUI();
                    showMessage(`⚖️ 법정 소송 승리! 모든 플레이어로부터 총 ${totalReceived}점의 배상금을 받았습니다!`);
                }
            },
            {
                name: "🎪 광대의 장난",
                description: "광대가 장난을 칩니다! 모든 플레이어의 위치를 섞습니다!",
                effect: () => {
                    // 모든 플레이어의 현재 위치 수집
                    const positions = gameState.players.map(player => player.position);
                    
                    // 위치를 랜덤하게 섞기
                    for (let i = positions.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [positions[i], positions[j]] = [positions[j], positions[i]];
                    }
                    
                    // 섞인 위치를 플레이어들에게 재배치
                    gameState.players.forEach((player, index) => {
                        player.position = positions[index];
                    });
                    
                    updatePlayerPieces();
                    updateUI();
                    showMessage(`🎪 광대의 장난! 모든 플레이어의 위치가 섞였습니다!`);
                }
            },
            {
                name: "⚡ 순간이동",
                description: "마법의 힘으로 순간이동! 원하는 위치로 즉시 이동합니다!",
                effect: () => {
                    enableTeleportMode();
                }
            },
            {
                name: "💎 보석 상자",
                description: "보석 상자를 발견했습니다! 랜덤으로 100~1000점 획득!",
                effect: () => {
                    const player = gameState.players.find(p => p.id === gameState.currentPlayer);
                    // 100점 단위로 100~1000점 랜덤 (100, 200, 300, 400, 500, 600, 700, 800, 900, 1000)
                    const randomMultiplier = Math.floor(Math.random() * 10) + 1; // 1~10
                    const bonusPoints = randomMultiplier * 100; // 100, 200, 300, ..., 1000
                    
                    player.score += bonusPoints;
                    updateUI();
                    showMessage(`💎 보석 상자! ${bonusPoints}점을 획득했습니다!`);
                }
            },
        ];

        // 플레이어 카드 동적 생성 함수
        function createPlayerCards() {
            const playersSection = document.getElementById('players-section');
            if (!playersSection) return;
            
            // 기존 플레이어 카드 제거
            playersSection.innerHTML = '';
            
            // 현재 게임 상태의 플레이어 수만큼 카드 생성
            const gameState = gameStateManager.state;
            gameState.players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = 'player-info';
                playerCard.id = `player${player.id}-info`;
                
                playerCard.innerHTML = `
                    <div class="player-avatar" style="background: ${player.color};">${player.id}</div>
                    <div class="player-details">
                        <div class="player-name">${player.name}</div>
                        <div class="player-score"><span id="score${player.id}">${formatNumber(player.score)}</span>점</div>
                    </div>
                `;
                
                playersSection.appendChild(playerCard);
            });
        }

        // 게임 활성화
        async function initGame() {
            // 뷰포트 높이 설정
            setViewportHeight();
            
            // 퀴즈 문제 로드
            await loadQuizQuestions();
            
            // 슈퍼 점프 관련 상태 활성화
            gameState.superJumpMode = false;
            gameState.superJumpFailed = false;
            
            // 순간이동 관련 상태 활성화
            gameState.teleportMode = false;
            
            gameState.players.forEach(player => {
                player.isWaitJump = false;
                player.hasSuperJumpChance = false;
                player.isOnIsland = false;
                player.islandTurnCount = 0;
                player.islandQuizStreak = 0;
            });
            
            // 무인도 모드 활성화
            gameState.modes.island.active = false;
            gameState.modes.island.escapePhase = null;
            gameState.modes.island.justEscaped = false;
            
            // 무인도 표시기 숨기기 (제거됨)
            // islandManager.hideIslandIndicator();
            
            // 특별 칸 고유 색상 설정
            document.documentElement.style.setProperty('--color-superjump', '#00BFFF');
            document.documentElement.style.setProperty('--color-island', '#616161');
            document.documentElement.style.setProperty('--color-donation', '#FF69B4');
            
            // 플레이어 색상 CSS 변수 설정
            DEFAULT_PLAYER_COLORS_ARRAY.forEach((color, index) => {
                document.documentElement.style.setProperty(`--player-color-${index + 1}`, color);
            });
            
            // 플레이어 색상 업데이트
            DEFAULT_PLAYER_COLORS_ARRAY.forEach((color, index) => {
                if (gameState.players[index]) {
                    gameState.players[index].color = color;
                }
            });
            
            // 플레이어 카드 생성
            createPlayerCards();
            
            // 보드 생성
            createBoard();
            
            // 초기 주사위 값 설정 (5로 시작하여 주사위가 사라지지 않게 함)
            gameState.diceValue = 5;
            updateDiceIcon(5);
            
            // 주사위 버튼 초기 상태 설정
            diceButtonManager.updateFromGameState();
            
            // 게임 상태 모니터링 시작
            gameStateMonitor.startMonitoring();
            
            // 소유권 초기화
            resetSpaceOwners();
            
            
            // 보드 생성 후 땅 소유권 표시 및 UI 업데이트
            setTimeout(() => {
                updateLandOwnership();
                updateStarDisplay(); // 별 표시 활성화
                updateUI(); // 초기값 반영을 위한 UI 업데이트
                addLandClickHandlers(); // 땅 클릭 이벤트 추가
            }, 100);
        }

        // 모노폴리 스타일 보드 생성

        function createBoard() {
            const board = document.getElementById('gameBoard');
            board.innerHTML = '';

            // 7x7 그리드 생성
            for (let row = 0; row < 7; row++) {
                for (let col = 0; col < 7; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'board-space';
                    
                    // 모서리 칸들
                    if ((row === 0 && col === 0) || (row === 0 && col === 6) || 
                        (row === 6 && col === 0) || (row === 6 && col === 6)) {
                        cell.classList.add('corner-space');
                        
                        if (row === 0 && col === 0) {
                            // 무인도 - special 타입
                            const space = boardSpaces.find(s => s.id === 12);
                            if (space) {
                                cell.className = `board-space corner-space ${space.color}`;
                            }
                            cell.innerHTML = '<div class="space-name">   무  인  도   </div>';
                            cell.dataset.spaceId = 12;
                            // onclick 이벤트 제거 - addLandClickHandlers에서 처리
                        } else if (row === 0 && col === 6) {
                            // 기부 천사 - special 타입
                            const space = boardSpaces.find(s => s.id === 18);
                            if (space) {
                                cell.className = `board-space corner-space ${space.color}`;
                            }
                            cell.innerHTML = '<div class="space-name">기부 천사</div>';
                            cell.dataset.spaceId = 18;
                            // onclick 이벤트 제거 - addLandClickHandlers에서 처리
                        } else if (row === 6 && col === 0) {
                            // 슈퍼 점프 - special 타입
                            const space = boardSpaces.find(s => s.id === 6);
                            if (space) {
                                cell.className = `board-space corner-space ${space.color}`;
                            }
                            cell.innerHTML = '<div class="space-name">슈퍼 점프</div>';
                            cell.dataset.spaceId = 6;
                            // onclick 이벤트 제거 - addLandClickHandlers에서 처리
                        } else if (row === 6 && col === 6) {
                            // 시작 - start 타입
                            const space = boardSpaces.find(s => s.id === 0);
                            if (space) {
                                cell.className = `board-space corner-space ${space.color}`;
                            }
                            cell.innerHTML = '<div class="space-name">START</div>';
                            cell.dataset.spaceId = 0;
                            // onclick 이벤트 제거 - addLandClickHandlers에서 처리
                        }
                        
                        // 중앙 패널과 겹치는 모서리 칸들은 호버 효과 비활성화
                        if ((row >= 2 && row <= 4) && (col >= 2 && col <= 4)) {
                            cell.className += ' center-background';
                        }
                    }
                    // 내부 5x5 그리드 (빈칸들)
                    else if (row >= 1 && row <= 5 && col >= 1 && col <= 5) {
                        // 빈칸들 (퀴즈, 마블 글씨 제거)
                        cell.style.background = 'var(--color-center)';
                        cell.style.border = 'none';
                        cell.style.boxShadow = 'none';
                        cell.style.outline = 'none';
                        cell.innerHTML = '';
                        cell.className = 'board-space center-background'; // 호버 효과 비활성화
                        // 클릭 이벤트 제거 (onclick 설정하지 않음)
                    }
                    // 경계 칸들 (외곽 경로)
                    else {
                        const spaceIndex = getSpaceIndex(row, col);
                        if (spaceIndex !== -1) {
                            const space = boardSpaces.find(s => s.id === spaceIndex);
                            if (space) {
                                cell.className = `board-space ${space.color}`;
                                cell.dataset.space = spaceIndex; // 띠지 시스템을 위한 data-space 속성 추가
                                // 황금 열쇠 칸인 경우 특별 처리
                                if (space.type === 'golden') {
                                cell.innerHTML = `
                                        <div class="space-name">황금 열쇠</div>
                                        <div class="space-content">🔑</div>
                                    `;
                                } else {
                                cell.innerHTML = `
                                    <div class="space-content-wrapper">
                                    <div class="space-name">${space.name}</div>
                                    </div>
                                `;
                                }
                                
                                // 중앙 패널과 겹치는 영역의 칸들은 클릭 이벤트 제거
                                if ((row >= 2 && row <= 4) && (col >= 2 && col <= 4)) {
                                    cell.className += ' center-background';
                                    // 클릭 이벤트 제거 (onclick 설정하지 않음)
                                } else {
                                    cell.dataset.spaceId = space.id;
                                    // 땅 칸과 특별 칸은 addLandClickHandlers에서 처리하므로 onclick 이벤트 제거
                                    if (space.type !== 'quiz' && space.type !== 'corner' && space.type !== 'start' && space.type !== 'golden') {
                                        cell.onclick = () => handleSpaceClick(space.id);
                                    }
                                }
                            }
                        } else {
                            cell.style.background = 'transparent';
                            cell.style.border = 'none';
                            // 중앙 패널과 겹치는 영역의 빈 칸들도 호버 효과 비활성화
                            if ((row >= 2 && row <= 4) && (col >= 2 && col <= 4)) {
                                cell.className = 'board-space center-background';
                            }
                        }
                    }
                    
                    board.appendChild(cell);
                }
            }

            // 플레이어 말들 배치
            updatePlayerPieces();
        }

        // 그리드 위치를 보드 칸 인덱스로 변환 (스크린샷 기준)
        function getSpaceIndex(row, col) {
            // 상단 변 (13-17) - 왼쪽에서 오른쪽으로
            if (row === 0 && col >= 1 && col <= 5) {
                return 12 + col; // 13, 14, 15, 16, 17
            }
            // 우측 변 (19-23) - 위에서 아래로
            else if (col === 6 && row >= 1 && row <= 5) {
                return 18 + row; // 19, 20, 21, 22, 23
            }
            // 하단 변 (1-5) - 오른쪽에서 왼쪽으로
            else if (row === 6 && col >= 1 && col <= 5) {
                return 6 - col; // 5, 4, 3, 2, 1
            }
            // 좌측 변 (7-11) - 아래에서 위로
            else if (col === 0 && row >= 1 && row <= 5) {
                return 12 - row; // 11, 10, 9, 8, 7
            }
            return -1;
        }

        // 플레이어 말들 업데이트
        function updatePlayerPieces() {
            // 기존 말들 제거
            document.querySelectorAll('.player-piece').forEach(piece => piece.remove());

            // 각 칸별로 플레이어들을 그룹화
            const playersByPosition = {};
            gameState.players.forEach(player => {
                if (player.position >= 0 && player.position < boardSpaces.length) {
                    if (!playersByPosition[player.position]) {
                        playersByPosition[player.position] = [];
                    }
                    playersByPosition[player.position].push(player);
                }
            });

            // 각 칸에 플레이어 말들 배치
            Object.keys(playersByPosition).forEach(position => {
                const players = playersByPosition[position];
                const gridPos = getGridPosition(parseInt(position));
                
                if (gridPos) {
                    const cellIndex = gridPos.row * 7 + gridPos.col;
                        const spaceElement = document.querySelectorAll('.board-space')[cellIndex];
                    
                        if (spaceElement) {
                        players.forEach((player, index) => {
                            const piece = document.createElement('div');
                            piece.className = 'player-piece';
                            piece.style.background = player.color;
                            piece.textContent = player.id;
                            
                            // 상단 우측 정렬 배치 계산
                            const totalPlayers = players.length;
                            let rightPosition;
                            
                            if (totalPlayers === 1) {
                                rightPosition = '5%';
                            } else if (totalPlayers === 2) {
                                rightPosition = index === 0 ? '20%' : '5%';
                            } else if (totalPlayers === 3) {
                                rightPosition = index === 0 ? '35%' : index === 1 ? '20%' : '5%';
                            } else { // 4명
                                rightPosition = index === 0 ? '50%' : index === 1 ? '35%' : index === 2 ? '20%' : '5%';
                            }
                            
                            piece.style.right = rightPosition;
                            piece.style.left = 'auto'; // left 속성 활성화
                            spaceElement.appendChild(piece);
                        });
                    }
                }
            });
        }

        // 보드 칸 인덱스를 그리드 위치로 변환 (스크린샷 기준)
        function getGridPosition(spaceIndex) {
            if (spaceIndex === 0) return { row: 6, col: 6 }; // 시작 (우하단)
            if (spaceIndex === 6) return { row: 6, col: 0 }; // 슈퍼 점프 (좌하단)
            if (spaceIndex === 12) return { row: 0, col: 0 }; // 무인도 (좌상단)
            if (spaceIndex === 18) return { row: 0, col: 6 }; // 기부 천사 (우상단)
            
            // 상단 변 (13-17) - 왼쪽에서 오른쪽으로
            if (spaceIndex >= 13 && spaceIndex <= 17) {
                return { row: 0, col: spaceIndex - 12 };
            }
            // 우측 변 (19-23) - 위에서 아래로
            else if (spaceIndex >= 19 && spaceIndex <= 23) {
                return { row: spaceIndex - 18, col: 6 };
            }
            // 하단 변 (1-5) - 오른쪽에서 왼쪽으로
            else if (spaceIndex >= 1 && spaceIndex <= 5) {
                return { row: 6, col: 6 - spaceIndex };
            }
            // 좌측 변 (7-11) - 아래에서 위로
            else if (spaceIndex >= 7 && spaceIndex <= 11) {
                return { row: 12 - spaceIndex, col: 0 };
            }
            
            return null;
        }

        // 새로운 SVG 기반 주사위 시스템
        let isRolling = false;
        
        // 퀴즈 타이머 변수
        let quizTimer = null;

        // 소유권 시스템
        let spaceOwners = {
            1: null, 2: null, 4: null, 5: null,      // 1번 지역
            7: null, 8: null, 10: null, 11: null,    // 2번 지역
            13: null, 14: null, 16: null, 17: null,  // 3번 지역
            19: null, 20: null, 22: null, 23: null   // 4번 지역
        };

        // 별 개수 시스템 (땅별 별 개수 저장)
        let spaceStars = {
            1: 0, 2: 0, 4: 0, 5: 0,      // 1번 지역
            7: 0, 8: 0, 10: 0, 11: 0,    // 2번 지역
            13: 0, 14: 0, 16: 0, 17: 0,  // 3번 지역
            19: 0, 20: 0, 22: 0, 23: 0   // 4번 지역
        };

        // 통행세 기준 (1성 기준)
        const tollRates = {
            1: 100, 2: 100, 4: 100, 5: 100,      // 1번 지역
            7: 200, 8: 200, 10: 200, 11: 200,    // 2번 지역
            13: 300, 14: 300, 16: 300, 17: 300,  // 3번 지역
            19: 300, 20: 300, 22: 300, 23: 300   // 4번 지역
        };


        // 땅 소유권 표시 업데이트 함수 (플레이어 색상으로 전체 칸 색상 변경)
        function updateLandOwnership() {
            const spaces = document.querySelectorAll('.board-space[data-space]');
            if (spaces.length === 0) {
                return;
            }
            
            spaces.forEach(space => {
                const spaceNumber = parseInt(space.dataset.space);
                const ownerIndex = spaceOwners[spaceNumber];
                
                if (ownerIndex !== null && ownerIndex !== undefined) {
                    // 현재 게임 상태의 플레이어 색상 사용
                    const owner = gameState.players.find(p => p.id === ownerIndex);
                    const ownerColor = owner ? owner.color : DEFAULT_PLAYER_COLORS.PLAYER1;
                    
                    // owned 클래스 추가 및 색상 설정
                    space.classList.add('owned');
                    space.style.setProperty('--owner-color', ownerColor);
                    
                } else {
                    // 소유자가 없으면 owned 클래스 제거
                    space.classList.remove('owned');
                    space.style.removeProperty('--owner-color');
                }
            });
        }

        // 소유권 활성화 함수
        function resetSpaceOwners() {
            spaceOwners = {
                1: null, 2: null, 4: null, 5: null,      // 1번 지역
                7: null, 8: null, 10: null, 11: null,    // 2번 지역
                13: null, 14: null, 16: null, 17: null,  // 3번 지역
                19: null, 20: null, 22: null, 23: null   // 4번 지역
            };
            
            // 별 개수도 초기화
            spaceStars = {
                1: 0, 2: 0, 4: 0, 5: 0,      // 1번 지역
                7: 0, 8: 0, 10: 0, 11: 0,    // 2번 지역
                13: 0, 14: 0, 16: 0, 17: 0,  // 3번 지역
                19: 0, 20: 0, 22: 0, 23: 0   // 4번 지역
            };
        }

        // 칸 구매 함수 (문제를 맞췄을 때 호출)
        function buySpace(playerIndex, spaceNumber) {
            if (spaceOwners[spaceNumber] === null) {
                spaceOwners[spaceNumber] = playerIndex;
                spaceStars[spaceNumber] = 0; // 첫 구매 시 0성 (별 없음)
                updateLandOwnership();
                updateStarDisplay(); // 별 표시 업데이트
            }
        }

        // 별 개수 증가 함수
        function increaseStar(spaceNumber) {
            if (spaceStars[spaceNumber] < 5) {
                spaceStars[spaceNumber]++;
                updateStarDisplay();
            }
        }

        // 별 개수 감소 함수
        function decreaseStar(spaceNumber) {
            if (spaceStars[spaceNumber] > 0) {
                spaceStars[spaceNumber]--;
                updateStarDisplay();
                // 별이 0개가 되어도 소유권은 유지 (별 0개부터 시작하는 시스템)
            }
        }

        // 통행세 계산 함수 (별 0개부터 5개까지)
        function calculateToll(spaceNumber) {
            const baseRate = tollRates[spaceNumber] || 0;
            const starCount = spaceStars[spaceNumber] || 0;
            // 별 0개일 때는 기본 통행세, 별 1개부터는 2배씩 증가
            return starCount === 0 ? baseRate : baseRate * (starCount + 1);
        }

        // 별 표시 업데이트 함수
        function updateStarDisplay() {
            const spaces = document.querySelectorAll('.board-space[data-space]');
            spaces.forEach(space => {
                const spaceNumber = parseInt(space.dataset.space);
                const starCount = spaceStars[spaceNumber] || 0;
                
                // 기존 별 표시 제거
                const existingStars = space.querySelector('.star-display');
                if (existingStars) {
                    existingStars.remove();
                }
                
                // 별이 있으면 숫자와 함께 표시
                if (starCount > 0) {
                    const wrapper = space.querySelector('.space-content-wrapper');
                    if (wrapper) {
                        const starDisplay = document.createElement('div');
                        starDisplay.className = 'star-display';
                        starDisplay.innerHTML = '⭐'.repeat(starCount);
                        wrapper.appendChild(starDisplay);
                    }
                }
            });
        }

        // 칸 이벤트 처리 함수 (번개 이동 등에서 사용)
        function handleSpaceEvent(position, isFromPositionSwap = false) {
            const space = boardSpaces.find(s => s.id === position);
            if (!space) return;

            // 디버깅용 로그
            console.log('[DEBUG] handleSpaceEvent 호출됨:', {
                position: position,
                spaceType: space.type,
                spaceName: space.name,
                isFromPositionSwap: isFromPositionSwap,
                currentPlayer: gameState.currentPlayer,
                gamePhase: gameState.gamePhase
            });

            let shouldAutoEndTurn = true; // 자동 턴 전환 여부

            switch (space.type) {
                case 'start':
                    // 시작점은 이미 통과 보너스로 처리됨
                    break;
                case 'quiz':
                    gameState.gamePhase = 'quiz'; // 즉시 게임 페이즈를 quiz로 변경하여 턴 전환 방지
                    handleLandQuiz(position);
                    shouldAutoEndTurn = false; // 퀴즈 시작 시 자동 턴 전환 방지
                    return; // 턴 전환 로직 실행 방지
                case 'golden':
                    // 위치 교환으로 황금 열쇠 칸에 도착한 경우 중복 이벤트 방지
                    if (isFromPositionSwap) {
                        showMessage('이미 황금 열쇠를 사용하셨습니다.');
                        break;
                    } else {
                        showGoldenKeyEvent();
                        shouldAutoEndTurn = false; // 황금 열쇠 이벤트는 사용자 확인 후 턴 전환
                        return;
                    }
                case 'corner':
                    // corner 타입 칸들의 이름에 따라 다른 액션 수행
                    if (space.name === '무인도') {
                        const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
                        islandManager.putPlayerOnIsland(currentPlayer.id);
                        shouldAutoEndTurn = false; // 무인도 팝업은 사용자 확인 후 턴 전환
                    } else if (space.name === '슈퍼 점프') {
                        const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
                        // 슈퍼 점프 칸에 도착하면 다음 턴에 슈퍼 점프 기회 부여
                        currentPlayer.hasSuperJumpChance = true; // 슈퍼 점프 기회 플래그 설정
                        showSuperJumpPopup(currentPlayer.name);
                        shouldAutoEndTurn = false; // 슈퍼 점프 팝업은 사용자 확인 후 턴 전환
                    } else if (space.name === '기부 천사') {
                        const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
                        const otherPlayers = gameState.players.filter(p => p.id !== gameState.currentPlayer);
                        
                        // 다른 플레이어들에게 200점씩 지급
                        otherPlayers.forEach(player => {
                            player.score += 200;
                        });
                        
                        // 기부 천사 전용 팝업 표시
                        showAngelPopup(otherPlayers.length);
                        shouldAutoEndTurn = false; // 기부 천사 팝업은 사용자 확인 후 턴 전환
                    } else {
                        // 기타 모서리 칸은 황금열쇠 이벤트로 처리
                        showGoldenKeyEvent();
                        shouldAutoEndTurn = false; // 황금 열쇠 이벤트는 사용자 확인 후 턴 전환
                    }
                    break;
                case 'special':
                    // special 타입 칸들은 황금열쇠 이벤트로 처리
                    showGoldenKeyEvent();
                    shouldAutoEndTurn = false; // 황금 열쇠 이벤트는 사용자 확인 후 턴 전환
                    return;
                case 'finish':
                    const finishPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
                    finishPlayer.score += 500;
                    showMessage('도착점 도달! +500점');
                    break;
            }

            // 자동으로 턴 전환 (턴 종료 버튼 제거)
            if (shouldAutoEndTurn && !gameState.modes.island.justEscaped) {
                console.log('[DEBUG] 자동 턴 전환 예약됨 (2초 후) - shouldAutoEndTurn:', shouldAutoEndTurn, 'justEscaped:', gameState.modes.island.justEscaped);
                setTimeout(() => {
                    console.log('[DEBUG] 자동 턴 전환 실행');
                    endTurn();
                }, 2000); // 2초 후 자동 턴 전환
            } else if (gameState.modes.island.justEscaped) {
                // 무인도에서 방금 탈출한 플레이어의 경우 이벤트 처리 완료 후 턴 전환
                // 플래그는 턴 전환 알림 팝업을 표시한 후 활성화
                console.log('[DEBUG] 무인도 탈출 후 턴 전환 예약됨');
                setTimeout(() => {
                    try {
                        console.log('[DEBUG] 무인도 탈출 후 턴 전환 실행');
                        endTurn();
                    } catch (error) {
                        console.error('턴 전환 중 오류 발생:', error);
                    }
                }, 1500); // 1.5초 후 자동 턴 전환
            }
            // 무인도 퀴즈 중이나 무인도 탈출 성공 시에는 턴 전환하지 않음 (무인도 매니저에서 처리)
        }

        // 땅 퀴즈 처리 함수
        function handleLandQuiz(position) {
            const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
            const ownerIndex = spaceOwners[position];
            const starCount = spaceStars[position] || 0;
            const space = boardSpaces.find(s => s.id === position);
            const landName = space ? space.name : `${position}번`;
            
            // 무소유 땅인 경우
            if (ownerIndex === null) {
                showMessage(`${landName} 땅에 도착했습니다! 퀴즈를 맞춰 땅을 소유하세요!`);
                setTimeout(() => {
                    showQuiz();
                }, 1500);
                return;
            }
            
            // 본인 땅인 경우
            if (ownerIndex === currentPlayer.id) {
                if (starCount >= 5) {
                    showMessage(`${landName} 땅에 도착했습니다! 퀴즈를 맞춰 1,000점을 획득하세요!`);
                } else {
                    showMessage(`${landName} 땅에 도착했습니다! 퀴즈를 맞춰 별을 증가시키세요!`);
                }
                setTimeout(() => {
                    showQuiz();
                }, 1500);
                return;
            }
            
            // 다른 사람 땅인 경우 - 통행세 지불
            const toll = calculateToll(position);
            const owner = gameState.players.find(p => p.id === ownerIndex);
            
            if (!owner || ownerIndex === 0) {
                console.error(`소유자를 찾을 수 없습니다. position: ${position}, ownerIndex: ${ownerIndex}`);
                return;
            }
            
            if (toll > 0) {
                currentPlayer.score -= toll;
                owner.score += toll;
                
                showMessage(`${owner.name}의 ${landName} 땅에 도착! 통행세 ${formatNumber(toll)}점 지불!`);
                
                setTimeout(() => {
                    showMessage('통행세 지불 후 퀴즈를 맞춰 별을 감소시킬 수 있습니다!');
                    setTimeout(() => {
                        showQuiz();
                    }, 1500);
                }, 1500);
            } else {
                showMessage(`${owner.name}의 ${landName} 땅에 도착했습니다!`);
                setTimeout(() => {
                    showQuiz();
                }, 1500);
            }
        }

        // 땅 퀴즈 답변 처리 함수
        function handleLandQuizAnswer(selected, correct, points, spaceNumber) {
            const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
            const ownerIndex = spaceOwners[spaceNumber];
            const starCount = spaceStars[spaceNumber] || 0;
            const space = boardSpaces.find(s => s.id === spaceNumber);
            const landName = space ? space.name : `${spaceNumber}번`;
            
            // 시간 초과 처리
            if (selected === -1) {
                showMessage('시간 초과! 점수 없음');
                closeQuiz();
                updateUI();
                
                // 시간 초과 후 턴 전환
                console.log('[DEBUG] 땅 퀴즈 시간 초과 후 턴 전환 예약됨');
                setTimeout(() => {
                    console.log('[DEBUG] 땅 퀴즈 시간 초과 후 턴 전환 실행');
                    endTurn();
                }, 2000); // 2초 후 턴 전환
                return;
            }
            
            // 정답인 경우
            if (selected === correct) {
                // 기본 점수 부여 (200점 또는 5성 땅은 400점)
                const bonusPoints = starCount >= 5 ? 400 : 200;
                currentPlayer.score += bonusPoints;
                
                // 무소유 땅인 경우 - 땅 구매
                if (ownerIndex === null) {
                    buySpace(currentPlayer.id, spaceNumber);
                    showMessage(`정답! +${formatNumber(bonusPoints)}점 획득! ${landName} 땅을 소유했습니다!`);
                }
                // 본인 땅인 경우 - 별 증가
                else if (ownerIndex === currentPlayer.id) {
                    if (starCount < 5) {
                        increaseStar(spaceNumber);
                        showMessage(`정답! +${formatNumber(bonusPoints)}점 획득! ${landName} 땅의 별이 증가했습니다!`);
                    } else {
                        showMessage(`정답! +${formatNumber(bonusPoints)}점 획득!`);
                    }
                }
                // 다른 사람 땅인 경우 - 별 감소 또는 소유권 제거
                else {
                    if (starCount > 0) {
                        decreaseStar(spaceNumber);
                        showMessage(`정답! +${formatNumber(bonusPoints)}점 획득! ${landName} 땅의 별이 감소했습니다!`);
                    } else {
                        // 별이 0개인 상태에서 퀴즈를 맞추면 소유권 제거
                        spaceOwners[spaceNumber] = null;
                        updateLandOwnership();
                        showMessage(`정답! +${formatNumber(bonusPoints)}점 획득! ${landName} 땅의 소유권이 사라졌습니다!`);
                    }
                }
            } else {
                // 오답인 경우
                showMessage('틀렸습니다.');
            }
            
            closeQuiz();
            updateUI();
            
            // 퀴즈 완료 후 턴 전환 (정답/오답 관계없이)
            console.log('[DEBUG] 땅 퀴즈 완료 후 턴 전환 예약됨');
            setTimeout(() => {
                console.log('[DEBUG] 땅 퀴즈 완료 후 턴 전환 실행');
                endTurn();
            }, 2000); // 2초 후 턴 전환
        }

        // 땅 소유 개수 계산 함수
        function getPlayerLandCount(playerId) {
            let count = 0;
            for (const spaceNumber in spaceOwners) {
                // 숫자 타입으로 변환하여 비교
                if (spaceOwners[spaceNumber] === playerId) {
                    count++;
                }
            }
            return count;
        }

        // 땅 소유 표시 업데이트 함수
        function updateLandOwnershipDisplay() {
            for (let i = 0; i < 4; i++) {
                const landCount = getPlayerLandCount(i + 1); // 플레이어 ID는 1부터 시작
                const landElement = document.getElementById(`lands${i + 1}`);
                if (landElement) {
                    landElement.textContent = landCount;
                }
            }
        }

        // 땅 클릭 이벤트 핸들러 추가
        function addLandClickHandlers() {
            // 모든 보드 칸에 대해 이벤트 핸들러 추가
            const allSpaces = document.querySelectorAll('.board-space');
            allSpaces.forEach(space => {
                // data-space 속성이 있는 칸들 (일반 칸)
                if (space.dataset.space) {
                    const spaceNumber = parseInt(space.dataset.space);
                    const spaceData = boardSpaces.find(s => s.id === spaceNumber);
                    
                    // 땅 칸 클릭 이벤트 추가 (quiz 타입만)
                    if (spaceData && spaceData.type === 'quiz' && spaceOwners[spaceNumber] !== undefined) {
                        space.style.cursor = 'pointer';
                        space.addEventListener('click', () => {
                            
                            // 순간이동 모드인지 확인
                            if (gameState.teleportMode) {
                                performTeleport(spaceNumber);
                                return;
                            }
                            
                            // 슈퍼 점프 모드인지 확인
                            if (gameState.superJumpMode) {
                                // 슈퍼 점프 칸(6)은 선택할 수 없음
                                if (spaceNumber === 6) {
                                    showMessage('슈퍼 점프 칸은 선택할 수 없습니다.');
                                    return;
                                }
                                performSuperJump(spaceNumber);
                            } else {
                                showLandInfoPopup(spaceNumber);
                            }
                        });
                    }
                    // 특별 칸 클릭 이벤트 추가
                    else if (spaceData && (spaceData.type === 'corner' || spaceData.type === 'start')) {
                        space.style.cursor = 'pointer';
                        space.addEventListener('click', () => {
                            
                            // 순간이동 모드인지 확인
                            if (gameState.teleportMode) {
                                performTeleport(spaceNumber);
                                return;
                            }
                            
                            // 슈퍼 점프 모드인지 확인
                            if (gameState.superJumpMode) {
                                // 슈퍼 점프 칸(6)은 선택할 수 없음
                                if (spaceNumber === 6) {
                                    showMessage('슈퍼 점프 칸은 선택할 수 없습니다.');
                                    return;
                                }
                                performSuperJump(spaceNumber);
                            } else {
                                showSpecialSpaceInfoPopup(spaceNumber);
                            }
                        });
                    }
                    // 황금 열쇠 칸 클릭 이벤트 추가
                    else if (spaceData && spaceData.type === 'golden') {
                        space.style.cursor = 'pointer';
                        space.addEventListener('click', () => {
                            
                            // 순간이동 모드인지 확인
                            if (gameState.teleportMode) {
                                performTeleport(spaceNumber);
                                return;
                            }
                            
                            // 슈퍼 점프 모드인지 확인
                            if (gameState.superJumpMode) {
                                // 슈퍼 점프 칸(6)은 선택할 수 없음
                                if (spaceNumber === 6) {
                                    showMessage('슈퍼 점프 칸은 선택할 수 없습니다.');
                                    return;
                                }
                                performSuperJump(spaceNumber);
                            } else {
                                showGoldenKeyInfoPopup(spaceNumber);
                            }
                        });
                    }
                }
                
                // data-spaceId 속성이 있는 칸들 (모서리 칸)
                if (space.dataset.spaceId) {
                    const spaceNumber = parseInt(space.dataset.spaceId);
                    const spaceData = boardSpaces.find(s => s.id === spaceNumber);
                    
                    // 특별 칸 클릭 이벤트 추가
                    if (spaceData && (spaceData.type === 'corner' || spaceData.type === 'start')) {
                        space.style.cursor = 'pointer';
                        space.addEventListener('click', () => {
                            
                            // 순간이동 모드인지 확인
                            if (gameState.teleportMode) {
                                performTeleport(spaceNumber);
                                return;
                            }
                            
                            // 슈퍼 점프 모드인지 확인
                            if (gameState.superJumpMode) {
                                // 슈퍼 점프 칸(6)은 선택할 수 없음
                                if (spaceNumber === 6) {
                                    showMessage('슈퍼 점프 칸은 선택할 수 없습니다.');
                                    return;
                                }
                                performSuperJump(spaceNumber);
                            } else {
                                showSpecialSpaceInfoPopup(spaceNumber);
                            }
                        });
                    }
                }
            });
        }

        // 땅별 명언 데이터
        const landQuotes = {
            1: { quote: "겸손은 진정한 위대함의 기초이다.", author: "윌리엄 셰익스피어" },
            2: { quote: "노력은 결코 배신하지 않는다.", author: "나폴레옹 힐" },
            4: { quote: "정직은 최고의 정책이다.", author: "벤저민 프랭클린" },
            5: { quote: "신뢰는 모든 인간관계의 기초이다.", author: "스티븐 코비" },
            7: { quote: "친절함은 언어를 이해하지 못하는 사람도 이해할 수 있는 언어이다.", author: "마더 테레사" },
            8: { quote: "성실함은 가장 위대한 지혜이다.", author: "토마스 제퍼슨" },
            10: { quote: "열정 없이는 위대한 일이 이루어지지 않는다.", author: "랄프 왈도 에머슨" },
            11: { quote: "협력은 모든 성공의 열쇠이다.", author: "헨리 포드" },
            13: { quote: "감사는 마음의 기억이다.", author: "장 밥티스트 마시용" },
            14: { quote: "소통은 인간관계의 생명선이다.", author: "존 파월" },
            16: { quote: "용기는 공포를 극복하는 것이지, 공포가 없는 것이 아니다.", author: "마크 트웨인" },
            17: { quote: "배려는 사랑의 가장 아름다운 표현이다.", author: "마더 테레사" },
            19: { quote: "나눔은 사랑의 시작이다.", author: "마더 테레사" },
            20: { quote: "화합은 힘이다.", author: "마하트마 간디" },
            22: { quote: "존중은 상대방을 인정하는 마음이다.", author: "스티븐 코비" },
            23: { quote: "사랑은 모든 것을 이긴다.", author: "베르길리우스" }
        };

        // 땅 정보 팝업 표시
        function showLandInfoPopup(spaceNumber) {
            const ownerIndex = spaceOwners[spaceNumber];
            const starCount = spaceStars[spaceNumber] || 0;
            const toll = calculateToll(spaceNumber);
            const space = boardSpaces.find(s => s.id === spaceNumber);
            const landName = space ? space.name : `${spaceNumber}번`;
            const baseRate = tollRates[spaceNumber] || 0;
            const quote = landQuotes[spaceNumber];
            
            // 통행세 범례 생성 (별 0개부터 5개까지)
            const tollLegend = `
                <div class="toll-legend-section">
                    <h5>💰 통행세 범례</h5>
                    <div class="toll-legend-grid">
                        <div class="toll-legend-item">
                            <span class="legend-stars">없음</span>
                            <span class="legend-amount">${formatNumber(baseRate)}점</span>
                        </div>
                        <div class="toll-legend-item">
                            <span class="legend-stars">⭐</span>
                            <span class="legend-amount">${formatNumber(baseRate * 2)}점</span>
                        </div>
                        <div class="toll-legend-item">
                            <span class="legend-stars">⭐⭐</span>
                            <span class="legend-amount">${formatNumber(baseRate * 3)}점</span>
                        </div>
                        <div class="toll-legend-item">
                            <span class="legend-stars">⭐⭐⭐</span>
                            <span class="legend-amount">${formatNumber(baseRate * 4)}점</span>
                        </div>
                        <div class="toll-legend-item">
                            <span class="legend-stars">⭐⭐⭐⭐</span>
                            <span class="legend-amount">${formatNumber(baseRate * 5)}점</span>
                        </div>
                        <div class="toll-legend-item">
                            <span class="legend-stars">⭐⭐⭐⭐⭐</span>
                            <span class="legend-amount">${formatNumber(baseRate * 6)}점</span>
                        </div>
                    </div>
                </div>
            `;
            
            let content = '';
            
            // 명언 섹션 생성
            const quoteSection = quote ? `
                <div class="quote-section">
                    <div class="quote-text">"${quote.quote}"</div>
                    <div class="quote-author">- ${quote.author} -</div>
                </div>
            ` : '';

            if (ownerIndex === null) {
                content = `
                    ${quoteSection}
                    <div class="land-info-section">
                        <div class="info-item">
                            <span class="info-label">소유자:</span>
                            <span class="info-value">없음</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">별 개수:</span>
                            <span class="info-value">0개</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">통행세:</span>
                            <span class="info-value">없음</span>
                        </div>
                    </div>
                    ${tollLegend}
                `;
            } else {
                const owner = gameState.players.find(p => p.id === ownerIndex);
                const starDisplay = '⭐'.repeat(starCount) + '☆'.repeat(5 - starCount);
                content = `
                    ${quoteSection}
                    <div class="land-info-section">
                        <div class="info-item">
                            <span class="info-label">소유자:</span>
                            <span class="info-value owner-name">${owner.name}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">별 개수:</span>
                            <span class="info-value star-count">${starCount}개</span>
                        </div>
                        <div class="star-display">${starDisplay}</div>
                        <div class="info-item">
                            <span class="info-label">통행세:</span>
                            <span class="info-value toll-amount">${formatNumber(toll)}점</span>
                        </div>
                    </div>
                    ${tollLegend}
                `;
            }
            
            // 기존 turnNotificationPopup을 사용하여 표시
            const popup = document.getElementById('turnNotificationPopup');
            const titleEl = popup.querySelector('.popup-title');
            const contentEl = popup.querySelector('.popup-content');
            const buttonEl = popup.querySelector('.popup-button');

            titleEl.textContent = `🏠 ${landName} 땅 정보`;
            contentEl.innerHTML = content;
            buttonEl.textContent = '확인';
            buttonEl.onclick = () => {
                popup.classList.remove('show');
                popup.classList.remove('land-info-mode');
            };
            
            // 땅 정보 팝업 테마 적용
            popup.classList.add('land-info-mode');
            popup.classList.add('show');
        }

        // 황금 열쇠 정보 팝업 표시
        function showGoldenKeyInfoPopup(spaceNumber) {
            const space = boardSpaces.find(s => s.id === spaceNumber);
            if (!space) return;

            const title = '🔑 황금 열쇠';
            const themeClass = 'golden-key-mode';
            const content = `
                <div class="special-space-section">
                    <div class="space-description">
                        <h4>🔑 황금 열쇠란?</h4>
                        <p>이 특별한 칸에 도착하면 랜덤한 이벤트가 발생합니다! 운에 따라 다양한 보상이나 효과를 받을 수 있습니다.</p>
                    </div>
                    <div class="space-features">
                        <h5>✨ 가능한 이벤트들</h5>
                        <div class="feature-item">
                            <span class="feature-icon">🚀</span>
                            <span class="feature-text">로켓 부스터: 즉시 시작점으로 워프 이동</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">💰</span>
                            <span class="feature-text">복권 당첨: 500점 획득</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">🎯</span>
                            <span class="feature-text">정확한 던지기: 다음 주사위가 6이 나옴</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">🌪️</span>
                            <span class="feature-text">토네이도: 다른 플레이어를 무작위로 이동</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">🎁</span>
                            <span class="feature-text">기타 다양한 보상과 효과들</span>
                        </div>
                    </div>
                </div>
            `;

            const popup = document.getElementById('turnNotificationPopup');
            const titleEl = popup.querySelector('.popup-title');
            const contentEl = popup.querySelector('.popup-content');
            const buttonEl = popup.querySelector('.popup-button');

            titleEl.textContent = title;
            contentEl.innerHTML = content;
            buttonEl.textContent = '확인';
            buttonEl.onclick = () => {
                popup.classList.remove('show');
                popup.classList.remove(themeClass);
            };
            popup.classList.add(themeClass);
            popup.classList.add('show');
        }

        // 특별 칸 정보 팝업 표시
        function showSpecialSpaceInfoPopup(spaceNumber) {
            const space = boardSpaces.find(s => s.id === spaceNumber);
            if (!space) return;
            
            let content = '';
            let themeClass = '';
            let title = '';
            
            switch (space.name) {
                case '슈퍼 점프':
                    title = '🚀 슈퍼 점프';
                    themeClass = 'super-jump-mode';
                    content = `
                        <div class="special-space-section">
                            <div class="space-description">
                                <h4>🚀 슈퍼 점프란?</h4>
                                <p>이 특별한 칸에 도착하면 다음 턴에 퀴즈를 맞춰 원하는 곳으로 이동할 수 있는 기회를 얻습니다!</p>
                            </div>
                            <div class="space-features">
                                <h5>✨ 사용 방법</h5>
                                <div class="feature-item">
                                    <span class="feature-icon">🎲</span>
                                    <span class="feature-text">다음 턴에 퀴즈를 풀어 정답을 맞춰야 함</span>
                                </div>
                                <div class="feature-item">
                                    <span class="feature-icon">🎯</span>
                                    <span class="feature-text">퀴즈 성공 시 원하는 칸을 선택하여 즉시 이동</span>
                                </div>
                                <div class="feature-item">
                                    <span class="feature-icon">⚡</span>
                                    <span class="feature-text">주사위 굴리기 없이 바로 이동 가능</span>
                                </div>
                                <div class="feature-item">
                                    <span class="feature-icon">❌</span>
                                    <span class="feature-text">퀴즈 실패 시 일반 주사위로 이동</span>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case '무인도':
                    title = '🏝️ 무인도';
                    themeClass = 'island-mode';
                    content = `
                        <div class="special-space-section">
                            <div class="space-description">
                                <h4>🏝️ 무인도란?</h4>
                                <p>이 특별한 칸에 도착하면 무인도에 갇혀 여러 턴 동안 퀴즈를 풀어야 탈출할 수 있습니다.</p>
                            </div>
                            <div class="space-features">
                                <h5>📅 탈출 조건</h5>
                                <div class="feature-item">
                                    <span class="feature-icon">1️⃣</span>
                                    <span class="feature-text">첫번째 턴: 연속으로 2번의 퀴즈를 맞춰야야 탈출</span>
                                </div>
                                <div class="feature-item">
                                    <span class="feature-icon">2️⃣</span>
                                    <span class="feature-text">두번째 턴: 1번의 퀴즈를 맞춰야 탈출</span>
                                </div>
                                <div class="feature-item">
                                    <span class="feature-icon">3️⃣</span>
                                    <span class="feature-text">세번째 턴: 자동으로 탈출</span>
                                </div>
                                <div class="feature-item">
                                    <span class="feature-icon">⚠️</span>
                                    <span class="feature-text">퀴즈로 탈출 실패 시 세번째 턴까지 기다려야 함</span>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case '기부 천사':
                    title = '😇 기부 천사';
                    themeClass = 'donation-mode';
                    content = `
                        <div class="special-space-section">
                            <div class="space-description">
                                <h4>😇 기부 천사란?</h4>
                                <p>이 칸에 도착하면 기부 천사가 되어 다른 모든 플레이어들에게 선물을 나눠줍니다!</p>
                            </div>
                            <div class="space-features">
                                <h5>💝 기부 천사 효과</h5>
                                <div class="feature-item">
                                    <span class="feature-icon">💝</span>
                                    <span class="feature-text">다른 플레이어들에게 각각 200점 선물</span>
                                </div>
                                <div class="feature-item">
                                    <span class="feature-icon">😊</span>
                                    <span class="feature-text">모든 플레이어가 행복해집니다</span>
                                </div>
                                <div class="feature-item">
                                    <span class="feature-icon">🌟</span>
                                    <span class="feature-text">선행을 통한 따뜻한 마음 전달</span>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case '시작':
                    title = '🏁 시작';
                    themeClass = 'start-mode';
                    content = `
                        <div class="special-space-section">
                            <div class="space-description">
                                <h4>🏁 시작점이란?</h4>
                                <p>게임의 시작점으로, 이곳을 지나갈 때마다 보너스를 받습니다!</p>
                            </div>
                            <div class="space-features">
                                <h5>🎁 보너스</h5>
                                <div class="feature-item">
                                    <span class="feature-icon">💰</span>
                                    <span class="feature-text">통과 보너스: 200점 획득</span>
                                </div>
                                <div class="feature-item">
                                    <span class="feature-icon">🔄</span>
                                    <span class="feature-text">매번 지나갈 때마다 보너스</span>
                                </div>
                                <div class="feature-item">
                                    <span class="feature-icon">🎯</span>
                                    <span class="feature-text">게임의 출발점이자 목표점</span>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                default:
                    return;
            }
            
            // 기존 turnNotificationPopup을 사용하여 표시
            const popup = document.getElementById('turnNotificationPopup');
            const titleEl = popup.querySelector('.popup-title');
            const contentEl = popup.querySelector('.popup-content');
            const buttonEl = popup.querySelector('.popup-button');

            titleEl.textContent = title;
            contentEl.innerHTML = content;
            buttonEl.textContent = '확인';
            buttonEl.onclick = () => {
                popup.classList.remove('show');
                popup.classList.remove(themeClass);
            };
            
            // 특별 칸 팝업 테마 적용
            popup.classList.add(themeClass);
            popup.classList.add('show');
        }

        // 주사위 아이콘 SVG 패턴들 (흰색 배경)
        const dicePatterns = {
            1: `<rect width="18" height="18" x="3" y="3" rx="2" ry="2" fill="white" stroke="#374151" stroke-width="1"/>
                <circle cx="12" cy="12" r="1" fill="#374151"/>`,
            
            2: `<rect width="18" height="18" x="3" y="3" rx="2" ry="2" fill="white" stroke="#374151" stroke-width="1"/>
                <circle cx="8" cy="8" r="1" fill="#374151"/>
                <circle cx="16" cy="16" r="1" fill="#374151"/>`,
            
            3: `<rect width="18" height="18" x="3" y="3" rx="2" ry="2" fill="white" stroke="#374151" stroke-width="1"/>
                <circle cx="8" cy="8" r="1" fill="#374151"/>
                <circle cx="12" cy="12" r="1" fill="#374151"/>
                <circle cx="16" cy="16" r="1" fill="#374151"/>`,
            
            4: `<rect width="18" height="18" x="3" y="3" rx="2" ry="2" fill="white" stroke="#374151" stroke-width="1"/>
                <circle cx="8" cy="8" r="1" fill="#374151"/>
                <circle cx="8" cy="16" r="1" fill="#374151"/>
                <circle cx="16" cy="8" r="1" fill="#374151"/>
                <circle cx="16" cy="16" r="1" fill="#374151"/>`,
            
            5: `<rect width="18" height="18" x="3" y="3" rx="2" ry="2" fill="white" stroke="#374151" stroke-width="1"/>
                <circle cx="8" cy="8" r="1" fill="#374151"/>
                <circle cx="8" cy="16" r="1" fill="#374151"/>
                <circle cx="12" cy="12" r="1" fill="#374151"/>
                <circle cx="16" cy="8" r="1" fill="#374151"/>
                <circle cx="16" cy="16" r="1" fill="#374151"/>`,
            
            6: `<rect width="18" height="18" x="3" y="3" rx="2" ry="2" fill="white" stroke="#374151" stroke-width="1"/>
                <circle cx="8" cy="8" r="1" fill="#374151"/>
                <circle cx="8" cy="12" r="1" fill="#374151"/>
                <circle cx="8" cy="16" r="1" fill="#374151"/>
                <circle cx="16" cy="8" r="1" fill="#374151"/>
                <circle cx="16" cy="12" r="1" fill="#374151"/>
                <circle cx="16" cy="16" r="1" fill="#374151"/>`
        };

        // 주사위 아이콘 업데이트 함수
        function updateDiceIcon(value) {
            const diceIcon = document.getElementById('diceIcon');
            diceIcon.innerHTML = dicePatterns[value];
        }

        // 주사위 굴리기
        function rollDice() {
            if (gameState.gamePhase !== 'waiting' && gameState.gamePhase !== 'rolling') {
                return;
            }
            if (isRolling) {
                return;
            }
            if (gameState.superJumpMode) return; // 슈퍼 점프 모드일 때는 주사위 비활성화
            if (gameState.teleportMode) return; // 순간이동 모드일 때는 주사위 비활성화
            
            // 무인도에 갇힌 플레이어는 3턴째부터만 주사위를 굴릴 수 있음
            const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
            if (currentPlayer && currentPlayer.isOnIsland && currentPlayer.islandTurnCount < 3) {
                return;
            }

            // 게임 액션 기록
            gameStateMonitor.recordAction();
            

            const diceIcon = document.getElementById('diceIcon');
            const rollBtn = document.getElementById('rollDiceBtn');
            
            isRolling = true;
            gameState.gamePhase = 'rolling';
            
            // 애니메이션 시작
            diceIcon.classList.add('spinning');
            
            // 새로운 주사위 버튼 관리 시스템 사용
            diceButtonManager.setState('disabled');
            // 버튼 텍스트는 그대로 유지 (크기 변화 방지)

            // 랜덤 주사위 값 생성 (1-6)
            const finalValue = Math.floor(Math.random() * 6) + 1;
            
            // 애니메이션 효과를 위한 여러 번 값 변경
            let rolls = 0;
            const rollInterval = setInterval(() => {
                // 애니메이션 중에는 랜덤 값 표시
                const tempValue = Math.floor(Math.random() * 6) + 1;
                updateDiceIcon(tempValue);
                rolls++;
                
                // 10번 굴린 후 최종 값으로 설정
                if (rolls > 10) {
                    clearInterval(rollInterval);
                    gameState.diceValue = finalValue;
                    gameState.gamePhase = 'moving';
                    updateDiceIcon(finalValue);
                    
                    
                    diceIcon.classList.remove('spinning');
                rollBtn.disabled = false;
                    isRolling = false;

                // 플레이어 이동
                setTimeout(() => {
                        movePlayer(finalValue);
                    }, 300);
                }
            }, 100); // 100ms마다 주사위 값 변경
        }

        // 플레이어 이동
        function movePlayer(steps) {
            const player = gameState.players.find(p => p.id === gameState.currentPlayer);
            const startPosition = player.position;
            let currentStep = 0;
            
            // 단계별 이동 애니메이션
            const moveStep = () => {
                if (currentStep < steps) {
                    currentStep++;
                    let tempPosition = startPosition + currentStep;
            
            // 보드를 한 바퀴 돌면 시작점 통과 보너스 (24칸 보드)
                    if (tempPosition >= 24) {
                        tempPosition = tempPosition - 24;
                        if (currentStep === steps) { // 마지막 단계에서만 보너스 적용
                player.score += 200;
                showMessage('시작점 통과 보너스! +200점');
                        }
            }
            
                    // 임시 위치로 플레이어 이동 (애니메이션용)
                    player.position = tempPosition;
            updatePlayerPieces();
                    
                    // 이동 애니메이션 효과
                    const playerPiece = document.querySelector(`.player-piece[style*="background: ${player.color}"]`);
                    if (playerPiece) {
                        playerPiece.classList.add('moving');
                        setTimeout(() => {
                            playerPiece.classList.remove('moving');
                        }, 600);
                    }
                    
                    // 다음 단계로 이동 (0.4초 간격)
                    setTimeout(moveStep, 400);
                } else {
                    // 최종 위치 설정 및 착지 애니메이션
                    let finalPosition = startPosition + steps;
                    if (finalPosition >= 24) {
                        finalPosition = finalPosition - 24;
                    }
                    player.position = finalPosition;
                    
                    // 착지 애니메이션
                    const playerPiece = document.querySelector(`.player-piece[style*="background: ${player.color}"]`);
                    if (playerPiece) {
                        playerPiece.classList.add('landing');
                        setTimeout(() => {
                            playerPiece.classList.remove('landing');
                        }, 400);
                    }
                    
            updateUI();

            // 도착한 칸의 액션 처리
            setTimeout(() => {
                        handleSpaceAction(finalPosition);
            }, 500);
                }
            };
            
            // 첫 번째 단계 시작
            moveStep();
        }

        // 칸 액션 처리
        function handleSpaceAction(position) {
            const space = boardSpaces.find(s => s.id === position);
            if (!space) return;


            let shouldAutoEndTurn = true; // 자동 턴 전환 여부

            switch (space.type) {
                case 'start':
                    // 시작점은 이미 통과 보너스로 처리됨
                    break;
                case 'quiz':
                    handleLandQuiz(position);
                    return;
                case 'golden':
                    showGoldenKeyEvent();
                    shouldAutoEndTurn = false; // 황금 열쇠 이벤트는 사용자 확인 후 턴 전환
                    return;
                case 'corner':
                    // corner 타입 칸들의 이름에 따라 다른 액션 수행
                    if (space.name === '무인도') {
                        const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
                        islandManager.putPlayerOnIsland(currentPlayer.id);
                        shouldAutoEndTurn = false; // 무인도 팝업은 사용자 확인 후 턴 전환
                    } else if (space.name === '슈퍼 점프') {
                        const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
                        currentPlayer.hasSuperJumpChance = true; // 슈퍼 점프 기회 플래그 설정
                        showSuperJumpPopup(currentPlayer.name);
                        shouldAutoEndTurn = false; // 슈퍼 점프 팝업은 사용자 확인 후 턴 전환
                    } else if (space.name === '기부 천사') {
                        const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
                        const otherPlayers = gameState.players.filter(p => p.id !== gameState.currentPlayer);
                        
                        // 다른 플레이어들에게 200점씩 지급
                        otherPlayers.forEach(player => {
                            player.score += 200;
                        });
                        
                        // 기부 천사 전용 팝업 표시
                        showAngelPopup(otherPlayers.length);
                        shouldAutoEndTurn = false; // 기부 천사 팝업은 사용자 확인 후 턴 전환
                    } else {
                        // 기타 모서리 칸은 황금열쇠 이벤트로 처리
                        showGoldenKeyEvent();
                    }
                    break;
                case 'special':
                    // special 타입 칸들은 황금열쇠 이벤트로 처리
                    showGoldenKeyEvent();
                    shouldAutoEndTurn = false; // 황금 열쇠 이벤트는 사용자 확인 후 턴 전환
                    return;
                case 'finish':
                    const finishPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
                    finishPlayer.score += 500;
                    showMessage('도착점 도달! +500점');
                    break;
            }

            // 자동으로 턴 전환 (턴 종료 버튼 제거)
            if (shouldAutoEndTurn && !gameState.modes.island.justEscaped) {
                console.log('[DEBUG] 두 번째 자동 턴 전환 예약됨 (2초 후) - shouldAutoEndTurn:', shouldAutoEndTurn);
                setTimeout(() => {
                    console.log('[DEBUG] 두 번째 자동 턴 전환 실행');
                    endTurn();
                }, 2000); // 2초 후 자동 턴 전환
            } else if (gameState.modes.island.justEscaped) {
                // 무인도에서 방금 탈출한 플레이어의 경우 이벤트 처리 완료 후 턴 전환
                // 플래그는 턴 전환 알림 팝업을 표시한 후 활성화
                console.log('[DEBUG] 두 번째 무인도 탈출 후 턴 전환 예약됨');
                setTimeout(() => {
                    try {
                        console.log('[DEBUG] 두 번째 무인도 탈출 후 턴 전환 실행');
                        endTurn();
                        updateUI();
                    } catch (error) {
                        console.error('endTurn 에러:', error);
                        // 에러 발생 시 기본 턴 전환 처리
                        const currentPlayerIndex = gameState.players.findIndex(p => p.id === gameState.currentPlayer);
                        if (currentPlayerIndex === -1) {
                            console.error('endTurn 에러 처리 중 현재 플레이어를 찾을 수 없습니다:', gameState.currentPlayer);
                            return;
                        }
                        const nextPlayerIndex = (currentPlayerIndex + 1) % gameState.players.length;
                        gameState.currentPlayer = gameState.players[nextPlayerIndex].id;
                        gameState.gamePhase = 'waiting';
                        updateUI();
                    }
                }, 2000); // 2초 후 턴 전환
            }
            updateUI();
        }

        // 퀴즈 표시
        function showQuiz() {
            
            // 디버깅용 로그
            const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
            console.log('[DEBUG] showQuiz 호출됨:', {
                currentPlayer: currentPlayer?.id,
                superJumpMode: gameState.superJumpMode,
                isOnIsland: currentPlayer?.isOnIsland,
                justEscaped: gameState.modes.island.justEscaped,
                gamePhase: gameState.gamePhase
            });
            
            try {
            // 퀴즈 문제가 로드되지 않았으면 에러 처리
            if (!quizQuestions || quizQuestions.length === 0) {
                console.error('퀴즈 문제가 로드되지 않았습니다.');
                showMessage('퀴즈 문제를 불러오는 중입니다. 잠시 후 다시 시도해주세요.');
                return;
            }
            
            const question = quizQuestions[Math.floor(Math.random() * quizQuestions.length)];
            const popup = document.getElementById('quizPopup');
            const questionEl = document.getElementById('quizQuestion');
            const optionsEl = document.getElementById('quizOptions');
            const titleEl = document.querySelector('#quizPopup .popup-title');

                if (!popup || !questionEl || !optionsEl) {
                    return;
                }

            // 현재 플레이어 정보로 제목 업데이트
            const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
            const playerName = currentPlayer ? currentPlayer.name : `플레이어 ${gameState.currentPlayer}`;
            
            if (titleEl) {
                if (gameState.superJumpMode) {
                    titleEl.textContent = `🚀 ${playerName} - 슈퍼 점프 퀴즈!`;
                    popup.classList.add('super-jump-mode');
                } else if (currentPlayer && currentPlayer.isOnIsland) {
                    // 무인도 퀴즈인 경우
                    const requiredStreak = currentPlayer.islandTurnCount === 1 ? 2 : 1;
                    titleEl.textContent = `🏝️ ${playerName} - 무인도 탈출 퀴즈!`;
                    popup.classList.add('island-mode');
                } else {
                    titleEl.textContent = `🧠 ${playerName} - 퀴즈 도전!`;
                    popup.classList.remove('super-jump-mode');
                    popup.classList.remove('island-mode');
                }
                }

            questionEl.textContent = question.question;
            optionsEl.innerHTML = '';

            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'popup-button';
                button.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
                button.onclick = () => answerQuiz(index, question.correct, question.points);
                optionsEl.appendChild(button);
            });

            // 무인도 퀴즈인 경우 진행 상황 표시
            if (currentPlayer && currentPlayer.isOnIsland) {
                const requiredStreak = currentPlayer.islandTurnCount === 1 ? 2 : 1;
                const progressEl = document.createElement('div');
                progressEl.style.cssText = 'margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center;';
                progressEl.innerHTML = `
                    <p style="margin: 5px 0; font-size: 14px;">문제를 ${requiredStreak}개 연속으로 맞춰 탈출하세요!</p>
                    <p style="margin: 5px 0; font-size: 16px; font-weight: bold;">현재 연속 정답: ${currentPlayer.islandQuizStreak}/${requiredStreak}</p>
                `;
                optionsEl.appendChild(progressEl);
            }

            popup.classList.add('show');
            startQuizTimer();
            
            // 무인도 퀴즈인 경우 현재 플레이어 하이라이트 설정
            if (currentPlayer && currentPlayer.isOnIsland) {
                updatePlayerHighlightForIsland(currentPlayer);
            }
            } catch (error) {
                showMessage('퀴즈를 불러올 수 없습니다.');
            }
        }

        // 퀴즈 타이머
        function startQuizTimer() {
            // 기존 타이머가 있다면 정리
            if (quizTimer) {
                clearInterval(quizTimer);
                quizTimer = null;
            }
            
            let timeLeft = 30;
            const timerEl = document.getElementById('timeLeft');
            
            // 초기 시간 표시
            if (timerEl) {
                timerEl.textContent = timeLeft;
            }
            
            quizTimer = setInterval(() => {
                timeLeft--;
                if (timerEl) {
                timerEl.textContent = timeLeft;
                }
                
                if (timeLeft <= 0) {
                    clearInterval(quizTimer);
                    quizTimer = null;
                    answerQuiz(-1, 0, 0); // 시간 초과
                }
            }, 1000);
        }

        // 퀴즈 답변
        function answerQuiz(selected, correct, points) {
            const player = gameState.players.find(p => p.id === gameState.currentPlayer);
            const currentSpace = player.position;
            
            // 무인도 퀴즈인지 확인
            if (player.isOnIsland) {
                const isCorrect = selected === correct;
                islandManager.handleIslandQuizAnswer(player.id, isCorrect);
                return;
            }
            
            // 슈퍼 점프 모드인지 확인
            if (gameState.superJumpMode) {
                if (selected === -1) {
                    gameState.superJumpMode = false;
                    player.isWaitJump = false;
                    gameState.gamePhase = 'waiting'; // 퀴즈 실패 후 waiting 상태
                    gameState.superJumpFailed = true; // 슈퍼 점프 실패 플래그 설정
                    
                    // 슈퍼 점프 시간 초과 시 턴 전환 알림 팝업 표시
                    showTurnNotification('도전 실패! 주사위를 굴려 이동하세요.');
                } else if (selected === correct) {
                    showMessage('정답! 슈퍼 점프하고 싶은 지역을 터치하세요.');
                    enableSuperJumpMode();
                } else {
                    gameState.superJumpMode = false;
                    player.isWaitJump = false;
                    gameState.gamePhase = 'waiting'; // 퀴즈 실패 후 waiting 상태
                    gameState.superJumpFailed = true; // 슈퍼 점프 실패 플래그 설정
                    
                    // 슈퍼 점프 실패 시 턴 전환 알림 팝업 표시
                    showTurnNotification('도전 실패! 주사위를 굴려 이동하세요.');
                }
                closeQuiz();
                return;
            }
            
            // 땅 퀴즈 처리
            if (spaceOwners[currentSpace] !== undefined) {
                handleLandQuizAnswer(selected, correct, points, currentSpace);
                return;
            }
            
            // 일반 퀴즈 처리
            // 시간 초과 처리
            if (selected === -1) {
                showMessage('시간 초과! 점수 없음');
            } else if (selected === correct) {
                player.score += points;
                
                // 퀴즈 칸이고 아직 소유자가 없다면 구매
                if (boardSpaces.find(s => s.id === currentSpace)?.type === 'quiz' && 
                    spaceOwners[currentSpace] === null) {
                    // 플레이어 ID를 그대로 사용 (1, 2, 3, 4)
                    const playerIndex = gameState.currentPlayer;
                    buySpace(playerIndex, currentSpace);
                    showMessage(`정답! +${formatNumber(points)}점 획득! 칸 ${currentSpace}을 구매했습니다!`);
                } else {
                    showMessage(`정답! +${formatNumber(points)}점 획득!`);
                }
            } else {
                showMessage('틀렸습니다.');
            }
            closeQuiz();
            updateUI();
            
            // 일반 퀴즈 완료 후 턴 전환 (정답/오답 관계없이)
            console.log('[DEBUG] 일반 퀴즈 완료 후 턴 전환 예약됨');
            setTimeout(() => {
                console.log('[DEBUG] 일반 퀴즈 완료 후 턴 전환 실행');
                endTurn();
            }, 2000); // 2초 후 턴 전환
        }

        // 퀴즈 닫기
        function closeQuiz() {
            
            // 타이머 정리
            if (quizTimer) {
                clearInterval(quizTimer);
                quizTimer = null;
            }
            
            const popup = document.getElementById('quizPopup');
            popup.classList.remove('show');
            
            // 퀴즈 완료 후 게임 페이즈를 waiting으로 복원
            if (gameState.gamePhase === 'quiz') {
                gameState.gamePhase = 'waiting';
            }
            
            // 슈퍼 점프 모드가 아닐 때는 슈퍼 점프 모드 클래스 제거
            if (!gameState.superJumpMode) {
                popup.classList.remove('super-jump-mode');
            }
            
            // 무인도 모드 클래스 제거
            popup.classList.remove('island-mode');
            
            // 슈퍼 점프 모드가 아니고 슈퍼 점프 실패가 아니고 무인도 모드가 아니고 무인도 탈출 성공이 아니고 게임 페이즈가 waiting일 때만 턴 전환
            const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
            if (!gameState.superJumpMode && !gameState.superJumpFailed && !(currentPlayer && currentPlayer.isOnIsland) && !gameState.modes.island.justEscaped && gameState.gamePhase === 'waiting') {
                console.log('[DEBUG] 퀴즈 종료 후 턴 전환 예약됨');
                setTimeout(() => {
                    try {
                        console.log('[DEBUG] 퀴즈 종료 후 턴 전환 실행');
                        endTurn();
                    } catch (error) {
                        console.error('closeQuiz에서 endTurn 에러:', error);
                        // 에러 발생 시 기본 턴 전환 처리
                        const currentPlayerIndex = gameState.players.findIndex(p => p.id === gameState.currentPlayer);
                        if (currentPlayerIndex === -1) {
                            console.error('closeQuiz 에러 처리 중 현재 플레이어를 찾을 수 없습니다:', gameState.currentPlayer);
                            return;
                        }
                        const nextPlayerIndex = (currentPlayerIndex + 1) % gameState.players.length;
                        gameState.currentPlayer = gameState.players[nextPlayerIndex].id;
                        gameState.gamePhase = 'waiting';
                        updateUI();
                    }
                }, 1500); // 1.5초 후 자동 턴 전환
            }
            // 무인도 퀴즈 중이나 무인도 탈출 성공 시에는 턴 전환하지 않음 (무인도 매니저에서 처리)
        }

        // 현재 황금 열쇠 이벤트 저장 변수
        let currentGoldenKeyEvent = null;

        // 황금 열쇠 이벤트 표시 (간소화 버전)
        function showGoldenDiscoveryMessage() {
            
            // 모든 황금 열쇠 이벤트에서 랜덤 선택
            const event = goldenKeyEvents[Math.floor(Math.random() * goldenKeyEvents.length)];
            currentGoldenKeyEvent = event;
            
            const popup = document.getElementById('goldenDiscoveryPopup');
            const eventTitleEl = document.getElementById('discoveryEventTitle');
            const eventDescriptionEl = document.getElementById('discoveryEventDescription');
            const mysteryBoxResultEl = document.getElementById('mysteryBoxResult');
            const mysteryBoxResultTextEl = document.getElementById('mysteryBoxResultText');

            if (!popup || !eventTitleEl || !eventDescriptionEl) {
                console.error('황금 열쇠 팝업 요소를 찾을 수 없습니다:', {
                    popup: !!popup,
                    eventTitleEl: !!eventTitleEl,
                    eventDescriptionEl: !!eventDescriptionEl
                });
                return;
            }

            eventTitleEl.textContent = event.name;
            eventDescriptionEl.textContent = event.description;
            
            // 신비한 상자 결과 숨기기 (이제 사용하지 않음)
            if (mysteryBoxResultEl) {
                mysteryBoxResultEl.style.display = 'none';
            }
            
            // 황금 열쇠 모드 클래스 추가
            popup.classList.add('golden-key-mode');
            
            // 팝업 표시
            popup.classList.add('show');
        }

        // 플레이어 선택 UI 표시 (위치 교환용)
        function showPlayerSelectionForPositionSwap() {
            const popup = document.getElementById('playerSelectionPopup');
            const playerList = document.getElementById('playerSelectionList');
            
            if (!popup || !playerList) return;
            
            // 황금 열쇠 모드 스타일 적용
            popup.classList.add('golden-key-mode');
            
            // 현재 플레이어 제외한 다른 플레이어들만 표시
            const currentPlayerId = gameState.currentPlayer;
            const otherPlayers = gameState.players.filter(p => p.id !== currentPlayerId);
            
            playerList.innerHTML = '';
            
            otherPlayers.forEach(player => {
                const playerItem = document.createElement('div');
                playerItem.className = 'player-selection-item';
                playerItem.onclick = () => performPositionSwap(player.id);
                
                // 플레이어 상태 정보 생성
                let statusText = '';
                let positionText = '';
                
                if (player.isOnIsland) {
                    statusText = '🏝️ 무인도에 갇힘';
                    positionText = `탈출 시도: ${player.islandTurnCount}턴째`;
                } else if (player.hasSuperJumpChance) {
                    statusText = '🚀 슈퍼 점프 대기 중';
                    positionText = `위치: ${player.position}번 칸`;
            } else {
                    statusText = '🆓 자유롭게 이동 중';
                    positionText = `위치: ${player.position}번 칸`;
                }
                
                playerItem.innerHTML = `
                    <div class="player-selection-avatar" style="background: ${player.color};">${player.id}</div>
                    <div class="player-selection-info">
                        <div class="player-selection-name">${player.name}</div>
                        <div class="player-selection-status">${statusText}</div>
                        <div class="player-selection-position">${positionText}</div>
                    </div>
                `;
                
                playerList.appendChild(playerItem);
            });
            
            popup.classList.add('show');
        }

        // 위치 교환 실행
        function performPositionSwap(targetPlayerId) {
            const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
            const targetPlayer = gameState.players.find(p => p.id === targetPlayerId);
            
            if (!currentPlayer || !targetPlayer) return;
            
            // 위치 교환
            const currentPosition = currentPlayer.position;
            const targetPosition = targetPlayer.position;
            
            currentPlayer.position = targetPosition;
            targetPlayer.position = currentPosition;
            
            // 특별 상태 처리
            if (targetPlayer.isOnIsland) {
                // 무인도에 있던 플레이어 구출
                targetPlayer.isOnIsland = false;
                targetPlayer.islandTurnCount = 0;
                targetPlayer.islandQuizStreak = 0;
                
                // 현재 플레이어를 무인도에 넣기
                currentPlayer.isOnIsland = true;
                currentPlayer.islandTurnCount = 0;
                currentPlayer.islandQuizStreak = 0;
                currentPlayer.position = 12; // 무인도 위치
                
                // 무인도 모드 활성화
                gameState.modes.island.active = true;
                gameState.modes.island.escapePhase = 'first';
                
                showMessage(`${targetPlayer.name}을(를) 구출했습니다! ${currentPlayer.name}이(가) 무인도에 갇혔습니다.`);
                
            } else if (targetPlayer.hasSuperJumpChance) {
                // 슈퍼 점프 대기 중이던 플레이어의 기회 취소
                targetPlayer.hasSuperJumpChance = false;
                targetPlayer.isWaitJump = false;
                
                // 현재 플레이어에게 슈퍼 점프 기회 부여 (다음 턴에서 사용)
                currentPlayer.hasSuperJumpChance = true;
                // isWaitJump는 다음 턴에서 설정되도록 하지 않음
                
                showMessage(`${targetPlayer.name}의 슈퍼 점프 기회를 가져왔습니다! ${currentPlayer.name}이(가) 다음 턴에 슈퍼 점프를 할 수 있습니다.`);
                
            } else {
                // 일반적인 위치 교환
                showMessage(`${currentPlayer.name}과(와) ${targetPlayer.name}의 위치가 바뀌었습니다!`);
                
                // 슈퍼 점프 대기 중인 플레이어를 다른 곳으로 이동시키는 경우 상태 해제
                if (currentPlayer.isWaitJump && currentPlayer.position !== 6) {
                    currentPlayer.isWaitJump = false;
                    showMessage(`🔄 위치 교환! ${currentPlayer.name}의 슈퍼 점프 대기 상태가 해제되었습니다.`);
                }
                if (targetPlayer.isWaitJump && targetPlayer.position !== 6) {
                    targetPlayer.isWaitJump = false;
                    showMessage(`🔄 위치 교환! ${targetPlayer.name}의 슈퍼 점프 대기 상태가 해제되었습니다.`);
                }
                
                // 도착한 위치에서 이벤트 실행 (턴 전환은 handleSpaceEvent에서 처리)
                setTimeout(() => {
                    handleSpaceEvent(targetPosition, true); // 위치 교환으로 도착했음을 표시
                }, 1000); // 1초 후 이벤트 실행
                
                // UI 업데이트
                updatePlayerPieces();
                updateUI();
                
                // 팝업 닫기
                closePlayerSelection();
                
                // 턴 전환은 handleSpaceEvent에서 처리하므로 여기서는 하지 않음
                return; // 함수 종료
            }
            
            // UI 업데이트 (무인도, 슈퍼점프 교환의 경우)
            updatePlayerPieces();
            updateUI();
            
            // 팝업 닫기
            closePlayerSelection();
            
            // 턴 전환 (무인도, 슈퍼점프 교환의 경우)
            setTimeout(() => {
                endTurn();
            }, 2000);
        }

        // 플레이어 선택 팝업 닫기
        function closePlayerSelection() {
            const popup = document.getElementById('playerSelectionPopup');
            if (popup) {
                popup.classList.remove('show');
                popup.classList.remove('golden-key-mode');
            }
        }

        // 위치 선택 UI 표시 (순간이동용)
        function showPositionSelectionForTeleport() {
            const popup = document.getElementById('positionSelectionPopup');
            const positionGrid = document.getElementById('positionSelectionGrid');
            
            if (!popup || !positionGrid) return;

            // 기존 내용 초기화
            positionGrid.innerHTML = '';

            // 24개 위치 생성 (0-23)
            for (let i = 0; i < 24; i++) {
                const space = boardSpaces[i];
                const positionItem = document.createElement('div');
                positionItem.className = 'position-selection-item';
                positionItem.dataset.position = i;
                
                positionItem.innerHTML = `
                    <div class="position-number">${i}</div>
                    <div class="position-name">${space.name}</div>
                `;
                
                positionItem.addEventListener('click', () => {
                    performTeleport(i);
                });
                
                positionGrid.appendChild(positionItem);
            }

            // 황금 열쇠 스타일 적용
            popup.classList.add('golden-key-mode');
            
            // 팝업 표시
            popup.classList.add('show');
        }

        // 순간이동 실행
        function performTeleport(targetPosition) {
                    const player = gameState.players.find(p => p.id === gameState.currentPlayer);
            const currentPosition = player.position;
            
            // 슈퍼 점프 대기 중인 플레이어를 다른 곳으로 이동시키는 경우
            if (player.isWaitJump && targetPosition !== 6) {
                player.isWaitJump = false; // 슈퍼 점프 대기 상태 해제
                showMessage(`⚡ 순간이동! ${player.name}의 슈퍼 점프 대기 상태가 해제되었습니다.`);
            }
            
            // 플레이어를 선택한 위치로 이동
            player.position = targetPosition;
            
            // 슈퍼점프 상태 해제
            if (player.hasSuperJumpChance) {
                player.hasSuperJumpChance = false;
            }
            
            // 순간이동 모드 비활성화
            disableTeleportMode();
            
            // UI 업데이트
            updatePlayerPieces();
                updateUI();
            
            // 도착한 위치에서 이벤트 실행
            setTimeout(() => {
                handleSpaceEvent(targetPosition, true); // 순간이동으로 도착했음을 표시
            }, 1000);
        }

        // 위치 선택 팝업 닫기
        function closePositionSelection() {
            const popup = document.getElementById('positionSelectionPopup');
            if (popup) {
                popup.classList.remove('show');
                popup.classList.remove('golden-key-mode');
            }
        }











        // 통합된 황금 열쇠 팝업 닫기
        function closeGoldenDiscovery() {
            const popup = document.getElementById('goldenDiscoveryPopup');
            if (popup) {
            popup.classList.remove('show');
            popup.classList.remove('golden-key-mode');
            }
            
            // 황금 카드 효과 적용
            if (currentGoldenKeyEvent && currentGoldenKeyEvent.effect) {
                currentGoldenKeyEvent.effect();
            }
            
            // 위치 교환이나 순간이동 카드의 경우 턴 전환하지 않음 (선택 후 턴 전환)
            const isPositionSwap = currentGoldenKeyEvent && currentGoldenKeyEvent.name === "🔄 위치 교환";
            const isTeleport = currentGoldenKeyEvent && currentGoldenKeyEvent.name === "⚡ 순간이동";
            
            // 이벤트 활성화
            currentGoldenKeyEvent = null;
            
            // 위치 교환이나 순간이동이 아닌 경우에만 턴 전환
            if (!isPositionSwap && !isTeleport) {
            // 다음 플레이어로 턴 전환
            setTimeout(() => {
            endTurn();
            }, 1000);
            }
        }

        // 황금 열쇠 이벤트 표시 (통합 버전 사용)
        function showGoldenKeyEvent() {
            // 통합된 황금 열쇠 발견 메시지 표시
            showGoldenDiscoveryMessage();
        }

        // 황금 열쇠 효과 적용
        function applyGoldenKeyEffect(event) {
            if (event && event.effect) {
                event.effect();
            }
        }

        // 황금 열쇠 닫기
        function closeGoldenKey() {
            const goldenKeyPopup = document.getElementById('goldenKeyPopup');
            if (goldenKeyPopup) {
                goldenKeyPopup.classList.remove('show');
            }
            
            // 황금 카드 효과 적용
            if (currentGoldenKeyEvent && currentGoldenKeyEvent.effect) {
                    currentGoldenKeyEvent.effect();
            }
            
            // 이벤트 활성화
            currentGoldenKeyEvent = null;
            
            // 다음 플레이어로 턴 전환
                setTimeout(() => {
                    endTurn();
            }, 1000);
        }

        // 턴 전환 알림 표시
        function showTurnNotification(message) {
            try {
                // DOM이 완전히 로드되었는지 확인
                if (document.readyState !== 'complete') {
                    console.warn('DOM이 완전히 로드되지 않았습니다. 잠시 후 다시 시도합니다.');
                    setTimeout(() => showTurnNotification(message), 100);
                    return;
                }
                
            const popup = document.getElementById('turnNotificationPopup');
                if (!popup) {
                    console.error('턴 전환 알림 팝업을 찾을 수 없습니다');
                    return;
                }
                
                // 팝업 내부에서 요소를 찾기
                const contentEl = popup.querySelector('.popup-content');
                const titleEl = popup.querySelector('.popup-title');
                const buttonEl = popup.querySelector('.popup-button');
                
                // 요소가 존재하지 않으면 에러 처리
                if (!contentEl || !titleEl || !buttonEl) {
                    console.error('턴 전환 알림 팝업 내부 요소를 찾을 수 없습니다:', { contentEl, titleEl, buttonEl });
                    return;
                }
                
                // 확인 버튼의 onclick 이벤트 명시적으로 설정
                buttonEl.onclick = closeTurnNotification;
            
            // 슈퍼 점프 모드일 때는 제목과 메시지를 다르게 표시
            if (gameState.superJumpMode) {
                const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
                const playerName = currentPlayer ? currentPlayer.name : `플레이어 ${gameState.currentPlayer}`;
                    titleEl.innerHTML = '🚀 슈퍼 점프 도전!';
                contentEl.innerHTML = `<p>${playerName} - 문제를 풀어 슈퍼 점프에 도전하세요!</p>`;
                    popup.classList.add('super-jump-mode');
            } else {
                // 무인도에 갇힌 플레이어의 턴인지 확인
                    const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
                if (currentPlayer && currentPlayer.isOnIsland) {
                    titleEl.innerHTML = '🏝️ 무인도 탈출 도전!';
                    contentEl.innerHTML = `<p>${currentPlayer.name}의 무인도 탈출 도전!</p>`;
                    popup.classList.add('island-mode');
                } else if (message && message.includes('도전 실패')) {
                    const playerName = currentPlayer ? currentPlayer.name : `플레이어 ${gameState.currentPlayer}`;
                    titleEl.innerHTML = '❌ 도전 실패!';
                    contentEl.innerHTML = `<p>${playerName} - 주사위를 굴려 이동하세요.</p>`;
                    popup.classList.remove('island-mode');
                } else {
                    titleEl.innerHTML = '🎮 턴 전환';
                    contentEl.innerHTML = `<p>${message || '턴이 전환되었습니다.'}</p>`;
                    popup.classList.remove('island-mode');
                }
                popup.classList.remove('super-jump-mode');
            }
                
                popup.classList.add('show');
            } catch (error) {
                console.error('showTurnNotification 에러:', error);
                // 에러 발생 시 기본 메시지 표시
                const popup = document.getElementById('turnNotificationPopup');
                if (popup) {
            popup.classList.add('show');
                }
            }
        }

        // 턴 전환 알림 닫기
        function closeTurnNotification() {
            const popup = document.getElementById('turnNotificationPopup');
            popup.classList.remove('show');
            
            // 게임 액션 기록
            gameStateMonitor.recordAction();
            
            // 현재 플레이어가 무인도에 갇혀있는지 확인
            const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
            
            // 디버깅용 로그
            console.log('[DEBUG] closeTurnNotification 호출됨:', {
                currentPlayer: currentPlayer?.id,
                isOnIsland: currentPlayer?.isOnIsland,
                superJumpMode: gameState.superJumpMode,
                justEscaped: gameState.modes.island.justEscaped
            });
            
            if (currentPlayer && currentPlayer.isOnIsland) {
                // 무인도에 갇힌 플레이어의 퀴즈 시작
                try {
                    islandManager.attemptIslandEscape(currentPlayer.id);
                } catch (error) {
                    console.error('attemptIslandEscape 에러:', error);
                }
                return; // 무인도 퀴즈 시작 후 다른 로직 실행 방지
            } else if (gameState.superJumpMode) {
                showQuiz();
            } else {
                // 슈퍼 점프 모드가 아닐 때는 슈퍼 점프 모드 클래스 제거
                popup.classList.remove('super-jump-mode');
                
                // 무인도에서 탈출한 플레이어가 턴 전환 알림을 확인한 경우
                if (gameState.modes.island.justEscaped) {
                    // 플래그 활성화
                    gameState.modes.island.justEscaped = false;
                    // 주사위 버튼 활성화
                    diceButtonManager.updateFromGameState();
                    // 턴 전환은 이미 endTurn()에서 완료되었으므로 UI만 업데이트
                    updateUI();
                    return;
                }
                
                // 무인도에 갇힌 플레이어의 턴 전환 알림 확인 시
                const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
                if (currentPlayer && currentPlayer.isOnIsland) {
                    try {
                        islandManager.attemptIslandEscape(currentPlayer.id);
                    } catch (error) {
                        console.error('무인도 탈출 로직 에러:', error);
                    }
                    return;
                }
                
                // 일반적인 턴 전환 알림 확인 시
                diceButtonManager.updateFromGameState();
                
                if (gameState.superJumpFailed) {
                    gameState.superJumpFailed = false;
                }
                
                if (gameState.gamePhase !== 'waiting') {
                    gameState.gamePhase = 'waiting';
                }
                
                // UI 업데이트
                updateUI();
            }
        }

        // 턴 종료 (자동 턴 전환)
        function endTurn() {
            console.log('[DEBUG] ===== endTurn 함수 시작 =====');
            try {
            const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
            
            // 디버깅용 로그
            console.log('[DEBUG] endTurn 호출됨:', {
                currentPlayer: currentPlayer?.id,
                currentPlayerName: currentPlayer?.name,
                isWaitJump: currentPlayer?.isWaitJump,
                superJumpMode: gameState.superJumpMode,
                gamePhase: gameState.gamePhase,
                playersCount: gameState.players.length,
                allPlayers: gameState.players.map(p => ({ id: p.id, name: p.name, position: p.position }))
            });
            
            // 퀴즈 중일 때는 턴 전환하지 않음
            if (gameState.gamePhase === 'quiz') {
                console.log('[DEBUG] 퀴즈 중이므로 턴 전환하지 않음');
                return;
            }
            
            // 슈퍼 점프 대기 상태인지 확인
                if (currentPlayer && currentPlayer.isWaitJump) {
                gameState.gamePhase = 'superJumping';
                gameState.superJumpMode = true;
                showMessage('문제를 맞춰 원하는 곳으로 이동하세요.');
                showQuiz(); // 슈퍼 점프용 퀴즈
                return; // 턴 전환하지 않음
            }
            
            // 게임 액션 기록
            gameStateMonitor.recordAction();
            
            // 동적 턴 전환 로직 (플레이어 수에 따라 자동 조정)
            const previousPlayer = gameState.currentPlayer;
            const currentPlayerIndex = gameState.players.findIndex(p => p.id === gameState.currentPlayer);
            
            console.log('[DEBUG] 턴 전환 로직 시작:', {
                previousPlayer: previousPlayer,
                currentPlayerIndex: currentPlayerIndex,
                totalPlayers: gameState.players.length
            });
            
            // 현재 플레이어를 찾지 못한 경우 에러 처리
            if (currentPlayerIndex === -1) {
                console.error('[DEBUG] 현재 플레이어를 찾을 수 없습니다:', gameState.currentPlayer);
                console.error('[DEBUG] 사용 가능한 플레이어들:', gameState.players.map(p => p.id));
                return;
            }
            
            const nextPlayerIndex = (currentPlayerIndex + 1) % gameState.players.length;
            const nextPlayer = gameState.players[nextPlayerIndex];
            
            console.log('[DEBUG] 턴 전환 계산:', {
                currentPlayerIndex: currentPlayerIndex,
                nextPlayerIndex: nextPlayerIndex,
                nextPlayer: nextPlayer?.id,
                nextPlayerName: nextPlayer?.name
            });
            
            gameState.currentPlayer = gameState.players[nextPlayerIndex].id;
            gameState.gamePhase = 'waiting';
            gameState.diceValue = 0;
            
            console.log('[DEBUG] 턴 전환 완료:', {
                newCurrentPlayer: gameState.currentPlayer,
                newGamePhase: gameState.gamePhase
            });


            // 물음표로 바꾸지 않고 현재 주사위 값 유지
                diceButtonManager.updateFromGameState();

            const newCurrentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
                
                if (!newCurrentPlayer) {
                    console.error('newCurrentPlayer를 찾을 수 없습니다:', gameState.currentPlayer);
                    return;
                }
                
                // 무인도에 갇힌 플레이어의 턴 처리
                if (newCurrentPlayer.isOnIsland) {
                    
                    // 무인도에 갇힌 플레이어에게도 턴 전환 메시지 표시
                    showTurnNotification(`${newCurrentPlayer.name}의 차례입니다.`);
                    return;
                }
                
                // 무인도에 갇힌 플레이어가 없으면 무인도 표시기 숨기기 (제거됨)
                // if (!islandManager.hasIslandPlayers()) {
                //     islandManager.hideIslandIndicator();
                // }
                
            // 턴 전환 후 현재 플레이어의 슈퍼 점프 기회 확인
            if (newCurrentPlayer.hasSuperJumpChance) {
                // 현재 위치가 슈퍼 점프 칸인지 확인
                const currentSpace = boardSpaces.find(s => s.id === newCurrentPlayer.position);
                if (currentSpace && currentSpace.name === '슈퍼 점프') {
                    newCurrentPlayer.hasSuperJumpChance = false; // 기회 사용
                    newCurrentPlayer.isWaitJump = true; // 슈퍼 점프 대기 상태로 설정
                    gameState.gamePhase = 'superJumping';
                    gameState.superJumpMode = true;
                    
                    // 턴 알림 팝업으로 슈퍼 점프 시작 알림
                    showTurnNotification('슈퍼 점프 도전');
                } else {
                    newCurrentPlayer.hasSuperJumpChance = false; // 기회 취소
                    showTurnNotification(`플레이어 ${gameState.currentPlayer}의 차례입니다.`);
                }
            } else {
                // 일반 턴 전환 팝업 표시
                showTurnNotification(`플레이어 ${gameState.currentPlayer}의 차례입니다.`);
            }

                // 턴 전환 완료 후 UI 업데이트
                // updateUI()는 endTurn() 함수 끝에서 호출하지 않고, 호출하는 곳에서 처리
                console.log('[DEBUG] ===== endTurn 함수 정상 완료 =====');
            } catch (error) {
                console.error('[DEBUG] ===== endTurn 함수 에러 발생 =====');
                console.error('endTurn 함수 에러:', error);
                console.error('에러 발생 시 게임 상태:', {
                    currentPlayer: gameState.currentPlayer,
                    gamePhase: gameState.gamePhase,
                    players: gameState.players.map(p => ({ id: p.id, name: p.name }))
                });
                
                // 에러 발생 시 기본 턴 전환 처리
                const currentPlayerIndex = gameState.players.findIndex(p => p.id === gameState.currentPlayer);
                if (currentPlayerIndex === -1) {
                    console.error('endTurn 함수 에러 처리 중 현재 플레이어를 찾을 수 없습니다:', gameState.currentPlayer);
                    return;
                }
                const nextPlayerIndex = (currentPlayerIndex + 1) % gameState.players.length;
                gameState.currentPlayer = gameState.players[nextPlayerIndex].id;
                gameState.gamePhase = 'waiting';
                console.log('[DEBUG] 에러 복구 후 턴 전환:', {
                    newCurrentPlayer: gameState.currentPlayer,
                    newGamePhase: gameState.gamePhase
                });
                updateUI();
            }
        }

        // 플레이어 점수 현황 패널 업데이트
        function updatePlayerScorePanel() {
            const playerScoreList = document.getElementById('playerScoreList');
            if (!playerScoreList) return;

            // 플레이어들을 점수 순으로 정렬 (높은 점수부터)
            const sortedPlayers = [...gameState.players].sort((a, b) => b.score - a.score);

            const playerItems = sortedPlayers.map(player => {
                const isCurrentPlayer = player.id === gameState.currentPlayer;
                return `
                    <div class="player-score-item ${isCurrentPlayer ? 'current-player' : ''}">
                        <div class="player-mini-avatar" style="background-color: ${player.color};">
                            ${player.id}
                        </div>
                        <div class="player-score-value">${formatNumber(player.score)}점</div>
                    </div>
                `;
            });

            // 각 플레이어 사이에 투명한 구분자 추가
            const itemsWithSeparators = [];
            playerItems.forEach((item, index) => {
                itemsWithSeparators.push(item);
                if (index < playerItems.length - 1) {
                    itemsWithSeparators.push('<div class="player-separator"></div>');
                }
            });

            playerScoreList.innerHTML = itemsWithSeparators.join('');
        }

        // UI 업데이트
        function updateUI() {
            // 플레이어 정보 업데이트
            gameState.players.forEach(player => {
                const scoreElement = document.getElementById(`score${player.id}`);
                if (scoreElement) {
                    scoreElement.textContent = formatNumber(player.score);
                }
            });

            // 플레이어 점수 현황 패널 업데이트
            updatePlayerScorePanel();

            // 현재 플레이어 하이라이트
            updatePlayerHighlight();

            // 주사위 표시 (새로운 SVG 시스템)
            if (gameState.diceValue) {
                updateDiceIcon(gameState.diceValue);
            }

            updatePlayerPieces();
        }

        // 플레이어 하이라이트 업데이트
        function updatePlayerHighlight() {
            // 모든 플레이어 카드에서 active 클래스 제거 (항상 먼저 제거)
            document.querySelectorAll('.player-info').forEach(card => {
                card.classList.remove('active');
            });

            // 무인도에 갇힌 플레이어도 하이라이트 처리
            const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
            
            if (currentPlayer && currentPlayer.isOnIsland) {
                updatePlayerHighlightForIsland(currentPlayer);
                return;
            }

            // 현재 플레이어 카드에 active 클래스 추가
            const currentPlayerCard = document.getElementById(`player${gameState.currentPlayer}-info`);
            
            if (currentPlayerCard) {
                currentPlayerCard.classList.add('active');
            } else {
                console.error('플레이어', gameState.currentPlayer, '카드를 찾을 수 없음');
            }
        }

        // 무인도 퀴즈 중 플레이어 하이라이트 업데이트
        function updatePlayerHighlightForIsland(player) {
            // 모든 플레이어 카드에서 active 클래스 제거
            document.querySelectorAll('.player-info').forEach(card => {
                card.classList.remove('active');
            });

            // 무인도에 갇힌 플레이어 카드에 active 클래스 추가
            const playerCard = document.getElementById(`player${player.id}-info`);
            
            if (playerCard) {
                playerCard.classList.add('active');
            } else {
                console.error('무인도 플레이어', player.id, '카드를 찾을 수 없음');
            }
        }

        // 메시지 표시 (개선된 알림)
        function showMessage(message) {
            // 기존 알림 제거
            const existingNotification = document.querySelector('.game-notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // 슈퍼 점프 관련 메시지인지 확인
            const isSuperJumpMessage = message.includes('슈퍼 점프') || 
                                     message.includes('정답! 슈퍼 점프') || 
                                     message.includes('문제를 맞춰 원하는 곳으로') ||
                                     gameState.superJumpMode;

            // 황금 카드 관련 메시지인지 확인
            const isGoldenKeyMessage = message.includes('대박! 황금 보물을 발견했습니다!') ||
                                     message.includes('빈 상자였습니다') ||
                                     message.includes('함정이었습니다') ||
                                     message.includes('로켓 부스터') ||
                                     message.includes('복권 당첨') ||
                                     message.includes('황금') ||
                                     message.includes('보물') ||
                                     message.includes('축하합니다!') ||
                                     message.includes('획득했습니다!');

            // 무인도 관련 메시지인지 확인 (성공 메시지는 제외)
            const isIslandMessage = (message.includes('무인도에 갇혔습니다') ||
                                 message.includes('무인도에서 탈출') ||
                                 message.includes('무인도 탈출') ||
                                 message.includes('무인도에서 나갈 수 있습니다') ||
                                 message.includes('틀렸습니다! 다음 턴에 다시 도전하세요') ||
                                 (message.includes('정답!') && message.includes('문제 더 맞춰주세요'))) &&
                                 !message.includes('무인도 탈출 성공') &&
                                 !message.includes('무인도에서 탈출했습니다');

            // 기부 천사 관련 메시지인지 확인
            const isDonationMessage = message.includes('기부 천사') ||
                                     message.includes('기부') ||
                                     message.includes('선물') ||
                                     message.includes('수령');

            // 새로운 알림 생성
            const notification = document.createElement('div');
            notification.className = 'game-notification';
            notification.textContent = message;
            
            if (isSuperJumpMessage) {
                // 슈퍼 점프 관련 메시지 스타일
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #00BFFF, #00CED1, #9370DB);
                    color: #fff;
                    padding: 15px 25px;
                    border-radius: 25px;
                    font-size: 16px;
                    font-weight: bold;
                    border: 3px solid #00BFFF;
                    box-shadow: 0 0 30px rgba(0, 191, 255, 0.6);
                    z-index: 2000;
                    animation: slideDown 0.3s ease-out;
                    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
                `;
            } else if (isGoldenKeyMessage) {
                // 황금 카드 관련 메시지 스타일
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #FFD700, #FFA500, #FF6347);
                    color: #fff;
                    padding: 15px 25px;
                    border-radius: 25px;
                    font-size: 16px;
                    font-weight: bold;
                    border: 3px solid #FFD700;
                    box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
                    z-index: 2000;
                    animation: slideDown 0.3s ease-out;
                    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
                `;
            } else if (isIslandMessage) {
                // 무인도 관련 메시지 스타일
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #424242, #616161, #757575);
                    color: #fff;
                    padding: 15px 25px;
                    border-radius: 25px;
                    font-size: 16px;
                    font-weight: bold;
                    border: 3px solid #424242;
                    box-shadow: 0 0 30px rgba(66, 66, 66, 0.6);
                    z-index: 2000;
                    animation: slideDown 0.3s ease-out;
                    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
                `;
            } else if (isDonationMessage) {
                // 기부 천사 관련 메시지 스타일 (핫핑크 계열)
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #FF69B4, #FF1493, #FFB6C1);
                    color: #fff;
                    padding: 15px 25px;
                    border-radius: 25px;
                    font-size: 16px;
                    font-weight: bold;
                    border: 3px solid #FF69B4;
                    box-shadow: 0 0 30px rgba(255, 105, 180, 0.6);
                    z-index: 2000;
                    animation: slideDown 0.3s ease-out;
                    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
                `;
            } else {
                // 일반 메시지 스타일
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 15px 25px;
                border-radius: 25px;
                font-size: 16px;
                font-weight: bold;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                z-index: 2000;
                animation: slideDown 0.3s ease-out;
            `;
            }

            // CSS 애니메이션 추가
            if (!document.querySelector('#notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideDown {
                        from { 
                            opacity: 0; 
                            transform: translateX(-50%) translateY(-20px); 
                        }
                        to { 
                            opacity: 1; 
                            transform: translateX(-50%) translateY(0); 
                        }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(notification);

            // 3초 후 자동 제거
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideDown 0.3s ease-out reverse';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 3000);
        }

        // 칸 클릭 처리
        function handleSpaceClick(spaceId) {
            // 순간이동 모드인지 확인
            if (gameState.teleportMode) {
                performTeleport(spaceId);
                return;
            }
            
            // 슈퍼 점프 모드인지 확인
            if (gameState.superJumpMode) {
                if (spaceId === 6) {
                    showMessage('슈퍼 점프 칸은 선택할 수 없습니다.');
                    return;
                }
                // 슈퍼 점프 이동 처리
                performSuperJump(spaceId);
                return;
            }
            
            // 일반 모드: 칸 클릭 시 정보 표시 (선택사항)
            const space = boardSpaces.find(s => s.id === spaceId);
            if (space) {
                showMessage(`${space.name} (${space.type})`);
            }
        }

        // 슈퍼 점프 모드 활성화
        function enableSuperJumpMode() {
            // 슈퍼 점프 모드 표시기 추가
            showSuperJumpIndicator();
            
            // 슈퍼 점프 칸 제외한 모든 칸에 클릭 가능 표시
            document.querySelectorAll('.board-space').forEach(cell => {
                const spaceId = parseInt(cell.dataset.spaceId);
                if (spaceId !== 6 && spaceId !== undefined) { // 슈퍼 점프 칸(6) 제외
                    cell.classList.add('super-jump-target');
                    cell.style.cursor = 'pointer';
                }
            });
            
            // 슈퍼 점프 칸 비활성화
            const superJumpCell = document.querySelector('[data-space-id="6"]');
            if (superJumpCell) {
                superJumpCell.classList.add('super-jump-disabled');
            }
            
            // 주사위 버튼 비활성화
            diceButtonManager.setState('disabled');
        }

        // 슈퍼 점프 모드 비활성화
        function disableSuperJumpMode() {
            // 슈퍼 점프 모드 표시기 제거
            hideSuperJumpIndicator();
            
            // 모든 슈퍼 점프 관련 클래스 제거
            document.querySelectorAll('.board-space').forEach(cell => {
                cell.classList.remove('super-jump-target', 'super-jump-disabled');
                cell.style.cursor = '';
            });
            
            // 주사위 버튼 활성화
            diceButtonManager.updateFromGameState();
        }

        // 슈퍼 점프 실행
        function performSuperJump(targetSpaceId) {
            const player = gameState.players.find(p => p.id === gameState.currentPlayer);
            const currentPosition = player.position;
            const targetSpace = boardSpaces.find(s => s.id === targetSpaceId);
            
            if (!targetSpace) {
                showMessage('선택할 수 없는 칸입니다.');
                return;
            }
            
            // 슈퍼 점프 모드 비활성화
            disableSuperJumpMode();
            
            // 플레이어 이동
            player.position = targetSpaceId;
            
            // 시작점을 돌았다면 추가 점수 부여
            if (currentPosition > targetSpaceId) {
                player.score += 200;
                showMessage(`슈퍼 점프! 시작점을 돌아 +200점 보너스!`);
            } else {
                showMessage(`슈퍼 점프! ${targetSpace.name}으로 이동!`);
            }
            
            // 슈퍼 점프 상태 활성화
            player.isWaitJump = false;
            gameState.superJumpMode = false;
            gameState.gamePhase = 'waiting';
            
            // UI 업데이트
            updatePlayerPieces();
            updateUI();
            
            // 도착한 칸의 액션 처리
            setTimeout(() => {
                handleSpaceAction(targetSpaceId);
            }, 1000);
        }

        // 슈퍼 점프 모드 표시기 표시
        function showSuperJumpIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'superJumpIndicator';
            indicator.className = 'super-jump-mode-indicator';
            indicator.textContent = '🚀 슈퍼 점프 모드 - 원하는 칸을 클릭하세요!';
            document.body.appendChild(indicator);
        }

        // 슈퍼 점프 모드 표시기 숨기기
        function hideSuperJumpIndicator() {
            const indicator = document.getElementById('superJumpIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // 순간이동 모드 활성화
        function enableTeleportMode() {
            // 순간이동 모드 표시기 추가
            showTeleportIndicator();
            
            // 모든 칸에 클릭 가능 표시
            document.querySelectorAll('.board-space').forEach(cell => {
                const spaceId = parseInt(cell.dataset.spaceId || cell.dataset.space);
                if (spaceId !== undefined) {
                    cell.classList.add('teleport-target');
                    cell.style.cursor = 'pointer';
                }
            });
            
            // 순간이동 모드 활성화
            gameState.teleportMode = true;
        }

        // 순간이동 모드 비활성화
        function disableTeleportMode() {
            // 순간이동 모드 표시기 숨기기
            hideTeleportIndicator();
            
            // 모든 칸에서 클릭 가능 표시 제거
            document.querySelectorAll('.board-space').forEach(cell => {
                cell.classList.remove('teleport-target');
                cell.style.cursor = '';
            });
            
            // 순간이동 모드 비활성화
            gameState.teleportMode = false;
        }

        // 순간이동 모드 표시기 표시
        function showTeleportIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'teleportIndicator';
            indicator.className = 'teleport-mode-indicator';
            indicator.textContent = '⚡ 순간이동 모드 - 원하는 칸을 클릭하세요!';
            document.body.appendChild(indicator);
        }

        // 순간이동 모드 표시기 숨기기
        function hideTeleportIndicator() {
            const indicator = document.getElementById('teleportIndicator');
            if (indicator) {
                indicator.remove();
            }
        }


        // 전체화면 토글 함수
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                // 전체화면 진입
                document.documentElement.requestFullscreen().then(() => {
                    document.body.classList.add('fullscreen-mode');
                    document.getElementById('fullscreenIcon').classList.add('minimize');
                    document.getElementById('fullscreenBtn').title = '전체화면 해제';
                }).catch(err => {
                    // 전체화면 진입 실패
                });
            } else {
                // 전체화면 해제
                document.exitFullscreen().then(() => {
                    document.body.classList.remove('fullscreen-mode');
                    document.getElementById('fullscreenIcon').classList.remove('minimize');
                    document.getElementById('fullscreenBtn').title = '전체화면 토글';
                }).catch(err => {
                    // 전체화면 해제 실패
                });
            }
        }

        // 설정 창 열기 함수
        function openSettings() {
            const modal = document.getElementById('settingsModal');
            if (modal) {
                modal.style.display = 'flex';
            } else {
                createSettingsModal();
            }
        }

        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function createSettingsModal() {
            const modal = document.createElement('div');
            modal.id = 'settingsModal';
            modal.className = 'settings-modal';
            modal.innerHTML = `
                <div class="settings-container">
                    <div class="settings-header">
                        <h2>⚙️ 게임 설정</h2>
                        <button class="close-btn" onclick="closeSettings()">✕</button>
                    </div>
                    <div class="settings-content">
                        <div class="settings-sidebar">
                            <div class="sidebar-item active" onclick="selectSettingsTab('sound')">
                                🔊 사운드
                            </div>
                            <div class="sidebar-item" onclick="selectSettingsTab('game')">
                                🎮 게임
                            </div>
                            <div class="sidebar-item" onclick="selectSettingsTab('display')">
                                📱 화면
                            </div>
                        </div>
                        <div class="settings-main">
                            <div class="settings-panel active" id="sound-panel">
                                <h3>🔊 사운드 설정</h3>
                                <div class="setting-group">
                                    <label>효과음 볼륨</label>
                                    <input type="range" min="0" max="100" value="80" class="volume-slider">
                                    <span class="volume-value">80%</span>
                                </div>
                                <div class="setting-group">
                                    <label>배경음악 볼륨</label>
                                    <input type="range" min="0" max="100" value="60" class="volume-slider">
                                    <span class="volume-value">60%</span>
                                </div>
                                <div class="setting-group">
                                    <label><input type="checkbox"> 음소거</label>
                                </div>
                            </div>
                            <div class="settings-panel" id="game-panel">
                                <h3>🎮 게임 설정</h3>
                                <div class="setting-group">
                                    <label><input type="checkbox"> 애니메이션 효과</label>
                                </div>
                                <div class="setting-group">
                                    <label><input type="checkbox"> 자동 턴 전환</label>
                                </div>
                            </div>
                            <div class="settings-panel" id="display-panel">
                                <h3>📱 화면 설정</h3>
                                <div class="setting-group">
                                    <label><input type="checkbox"> 전체화면 모드</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            // DOM이 완전히 렌더링된 후 팔레트 로드
            setTimeout(() => {
                // 팔레트 로딩 제거됨
                const newModal = document.getElementById('settingsModal');
                if (newModal) {
                    newModal.style.display = 'flex';
                }
            }, 100);
        }

        function selectSettingsTab(tabName) {
            // 모든 탭 비활성화
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.settings-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // 선택된 탭 활성화
            event.target.classList.add('active');
            document.getElementById(tabName + '-panel').classList.add('active');
        }

        // 팔레트 시스템 제거됨




        // 전체화면 상태 변화 감지 (ESC 키 등으로 해제될 때)
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                document.body.classList.remove('fullscreen-mode');
                document.getElementById('fullscreenIcon').classList.remove('minimize');
                document.getElementById('fullscreenBtn').title = '전체화면 토글';
            }
        });

        // F11 키 지원 (선택사항)
        document.addEventListener('keydown', (event) => {
            if (event.key === 'F11') {
                event.preventDefault();
                toggleFullscreen();
            }
        });

        // 게임 시작
        window.onload = function() {
            initGame();
        };
    </script>
</body>
</html>
