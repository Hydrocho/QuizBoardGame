<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>모바일 보드게임</title>
    <meta name="description" content="친구들과 함께 즐기는 재미있는 모바일 보드게임">
    <meta name="theme-color" content="#4CAF50">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            margin: 0 !important;
            padding: 0 !important;
            width: 100%;
            height: 100%;
        }

        :root {
            --color-start: #FF7F50;
            --color-quiz: #00CED1;
            --color-golden: #FFD700;
            --color-special: #6495ED;
            --color-corner: #4682B4;
            --color-center: #E0F6FF;
            --color-background: #F0F8FF;
            --color-normal: #B0E0E6;
            
            /* 특별 칸별 고유 색상 */
            --color-superjump: #00BFFF;
            --color-island: #616161;
            --color-donation: #FF69B4;
            
            /* 주사위 버튼 색상 시스템 */
            --dice-primary: #10B981;
            --dice-secondary: #059669;
            --dice-dark: #047857;
            --dice-glow: rgba(16, 185, 129, 0.6);
            --dice-glow-strong: rgba(16, 185, 129, 0.9);
            --dice-glow-urgent: rgba(16, 185, 129, 0.8);
            --dice-glow-max: rgba(16, 185, 129, 1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--color-background) 0%, var(--color-normal) 100%);
            min-height: calc(var(--vh, 1vh) * 100);
            overflow: hidden;
        }

        .game-container {
            width: 100vw;
            height: calc(var(--vh, 1vh) * 100);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* 중앙 UI 패널 */
        .center-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: calc(85vw * 4.5 / 7);
            max-width: calc(85vw * 4.5 / 7);
            min-width: calc(85vw * 4.5 / 7);
            box-sizing: border-box;
            z-index: 5;
        }


        .players-section {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .player-info {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 12px 14px;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            min-width: 150px;
            flex: 1 1 calc(50% - 7.5px);
            max-width: calc(50% - 7.5px);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .player-info.active {
            border: 2px solid #FFD700;
            animation: playerBlink 1s infinite;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        @keyframes playerBlink {
            0% { 
                border-color: #FFD700;
                box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            }
            50% { 
                border-color: #FFA500;
                box-shadow: 0 0 15px rgba(255, 165, 0, 0.8);
            }
            100% { 
                border-color: #FFD700;
                box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            }
        }

        .controls-section {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
            width: 100%;
            margin-top: 10px;
        }

        .dice-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-avatar {
            width: 45px;
            height: 45px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }

        .player-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
            align-items: flex-start;
            flex: 1;
        }

        .player-name {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .player-score {
            font-size: 12px;
            color: #666;
        }

        .player-lands {
            font-size: 11px;
            color: #888;
        }

        .golden-keys {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #FFD700;
        }

        .game-status {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .phase-badge {
            background: rgba(76, 175, 80, 0.9);
            color: white;
        }

        .turn-badge {
            background: rgba(255, 193, 7, 0.9);
            color: #333;
        }

        /* 게임 보드 */
        .board-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: stretch;
            padding: 2px 5vw;
            overflow: hidden;
            position: relative;
            clip-path: inset(0);
        }

        .game-board {
            width: 85vw;
            height: calc(100% - 4px);
            max-width: 85vw;
            aspect-ratio: 1.4 / 1;
            border: 4px solid var(--color-corner);
            border-radius: 20px;
            background: var(--color-center);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(7, 1fr);
            gap: 0px;
            padding: 0px;
            overflow: hidden;
            clip-path: inset(0);
        }

        .board-space {
            border-radius: 0px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: none;
            min-height: 25px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            overflow: hidden;
            contain: layout;
        }

        .board-space:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }


        /* 내부 빈칸들을 위한 특별 스타일 - 모든 그림자와 테두리 제거 */
        .board-space.center-background {
            border: none !important;
            box-shadow: none !important;
            outline: none !important;
        }

        .board-space.center-background:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        /* 중앙 배경 칸들 - 호버 효과 비활성화 */
        .board-space.center-background {
            cursor: default !important;
            pointer-events: none !important; /* 마우스 이벤트 완전 차단 */
        }

        .board-space.center-background:hover {
            transform: none !important;
            box-shadow: none !important;
            cursor: default !important;
        }

        /* 중앙 패널과 겹치는 영역의 모든 칸들 - 호버 효과 비활성화 */
        .board-space:nth-child(16),  /* (2,2) */
        .board-space:nth-child(17),  /* (2,3) */
        .board-space:nth-child(18),  /* (2,4) */
        .board-space:nth-child(23),  /* (3,2) */
        .board-space:nth-child(24),  /* (3,3) */
        .board-space:nth-child(25),  /* (3,4) */
        .board-space:nth-child(30),  /* (4,2) */
        .board-space:nth-child(31),  /* (4,3) */
        .board-space:nth-child(32) { /* (4,4) */
            cursor: default !important;
        }

        .board-space:nth-child(16):hover,
        .board-space:nth-child(17):hover,
        .board-space:nth-child(18):hover,
        .board-space:nth-child(23):hover,
        .board-space:nth-child(24):hover,
        .board-space:nth-child(25):hover,
        .board-space:nth-child(30):hover,
        .board-space:nth-child(31):hover,
        .board-space:nth-child(32):hover {
            transform: none !important;
            box-shadow: none !important;
            cursor: default !important;
        }

        /* 모노폴리 스타일 지역별 색상 띠 */
        .board-space::after {
            content: '';
            position: absolute;
            background: var(--ribbon-color, transparent);
            z-index: 2; /* 플레이어 말(z-index: 10)보다 아래, 칸 배경보다 위 */
            transition: background-color 0.3s ease;
        }

        /* 1번 플레이어 지역 (칸 1, 2, 4, 5) - 상단 띠 */
        .board-space[data-space="1"]::after,
        .board-space[data-space="2"]::after,
        .board-space[data-space="4"]::after,
        .board-space[data-space="5"]::after {
            top: 0;
            left: 0;
            right: 0;
            height: 18px; /* 높이를 2배로 증가 */
            border-radius: 9px 9px 0 0;
        }

        /* 2번 플레이어 지역 (칸 7, 8, 10, 11) - 오른쪽 띠 */
        .board-space[data-space="7"]::after,
        .board-space[data-space="8"]::after,
        .board-space[data-space="10"]::after,
        .board-space[data-space="11"]::after {
            top: 0;
            right: 0;
            bottom: 0;
            width: 18px; /* 너비를 2배로 증가 */
            border-radius: 0 9px 9px 0;
        }

        /* 3번 플레이어 지역 (칸 13, 14, 16, 17) - 하단 띠 */
        .board-space[data-space="13"]::after,
        .board-space[data-space="14"]::after,
        .board-space[data-space="16"]::after,
        .board-space[data-space="17"]::after {
            bottom: 0;
            left: 0;
            right: 0;
            height: 18px; /* 높이를 2배로 증가 */
            border-radius: 0 0 9px 9px;
        }

        /* 4번 플레이어 지역 (칸 19, 20, 22, 23) - 왼쪽 띠 */
        .board-space[data-space="19"]::after,
        .board-space[data-space="20"]::after,
        .board-space[data-space="22"]::after,
        .board-space[data-space="23"]::after {
            top: 0;
            left: 0;
            bottom: 0;
            width: 18px; /* 너비를 2배로 증가 */
            border-radius: 9px 0 0 9px;
        }

        .space-number {
            font-size: clamp(12px, 3vw, 24px);
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            text-align: center;
            line-height: 1;
        }

        .space-name {
            font-size: clamp(8px, 2vw, 16px);
            color: white;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            margin-top: 1px;
            line-height: 1;
            font-weight: bold;
        }

        /* 특별 칸들의 글자 크기를 더 크게 */
        .corner-space .space-name {
            font-size: clamp(8px, 2.2vw, 16px);
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }


        /* 시작 칸 텍스트 스타일 */
        .space-start .space-name {
            font-size: clamp(10px, 2.8vw, 20px) !important;
            font-weight: 900 !important;
            color: #000000 !important;
            text-shadow: none !important;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: #FFFFFF !important;
            padding: 4px 6px !important;
            border-radius: 8px !important;
            border: 2px solid #000000 !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
            width: 90% !important;
            height: 80% !important;
            text-align: center !important;
            box-sizing: border-box !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        /* 슈퍼 점프 칸 텍스트 스타일 (전기 파란색 테마) */
        .corner-space[data-space-id="6"] .space-name {
            font-size: clamp(8px, 2.2vw, 16px) !important;
            font-weight: 900 !important;
            color: #FFFFFF !important;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8) !important;
            background: var(--color-superjump) !important;
            padding: 4px 6px !important;
            border-radius: 8px !important;
            border: 2px solid var(--color-superjump) !important;
            box-shadow: 0 2px 4px rgba(0, 191, 255, 0.4) !important;
            width: 90% !important;
            height: 80% !important;
            text-align: center !important;
            box-sizing: border-box !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        /* 무인도 칸 텍스트 스타일 (어두운 회색 테마) */
        .corner-space[data-space-id="12"] .space-name {
            font-size: clamp(8px, 2.2vw, 16px) !important;
            font-weight: 900 !important;
            color: #FFFFFF !important;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8) !important;
            background: var(--color-island) !important;
            padding: 4px 6px !important;
            border-radius: 8px !important;
            border: 2px solid var(--color-island) !important;
            box-shadow: 0 2px 4px rgba(66, 66, 66, 0.4) !important;
            width: 90% !important;
            height: 80% !important;
            text-align: center !important;
            box-sizing: border-box !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        /* 기부금 모금 칸 텍스트 스타일 (핫핑크 테마) */
        .corner-space[data-space-id="18"] .space-name {
            font-size: clamp(8px, 2.2vw, 16px) !important;
            font-weight: 900 !important;
            color: #FFFFFF !important;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8) !important;
            background: var(--color-donation) !important;
            padding: 4px 6px !important;
            border-radius: 8px !important;
            border: 2px solid var(--color-donation) !important;
            box-shadow: 0 2px 4px rgba(255, 105, 180, 0.4) !important;
            width: 90% !important;
            height: 80% !important;
            text-align: center !important;
            box-sizing: border-box !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            flex-direction: column !important;
        }

        /* 기부금 금액 스타일 */
        .corner-space[data-space-id="18"] .donation-amount {
            font-size: clamp(8px, 2.2vw, 16px) !important;
            font-weight: bold !important;
            color: #FFD700 !important;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8) !important;
            margin-top: 2px !important;
        }


        /* 모노폴리 스타일 보드 칸 배치 */
        .corner-space {
            background: var(--color-corner) !important;
            color: white;
            font-weight: bold;
            border: 2px solid var(--color-corner) !important;
            font-size: 12px;
        }

        .side-space {
            min-height: 20px;
        }

        .center-space {
            background: var(--color-center) !important;
            color: #000;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            border: 2px solid var(--color-corner);
        }

        .player-piece {
            position: absolute;
            width: 25px;
            height: 25px;
            border-radius: 8px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.5s ease;
            top: 8%; /* 띠지와 겹치지 않도록 위치 조정 */
            background: rgba(0, 0, 0, 0.2); /* 배경을 조금 더 진하게 하여 가시성 향상 */
            z-index: 10; /* 띠지(z-index: 2)보다 위에 표시 */
        }

        .player-piece.moving {
            animation: bounceMove 0.6s ease-in-out;
            z-index: 20;
        }

        @keyframes bounceMove {
            0% {
                transform: translateY(0px) scale(1);
            }
            25% { 
                transform: translateY(-15px) scale(1.1);
            }
            50% { 
                transform: translateY(0px) scale(1);
            }
            75% { 
                transform: translateY(-8px) scale(1.05);
            }
            100% { 
                transform: translateY(0px) scale(1);
            }
        }

        .player-piece.landing {
            animation: landingBounce 0.4s ease-out;
        }

        @keyframes landingBounce {
            0% {
                transform: translateY(0px) scale(1);
            }
            50% {
                transform: translateY(-10px) scale(1.15);
            }
            100% {
                transform: translateY(0px) scale(1);
            }
        }

        /* 전체화면 버튼 */
        .fullscreen-button {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 45px;
            height: 45px;
            background: rgba(255, 255, 255, 0.98);
            border: 3px solid #333;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            color: #333;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        /* 설정 버튼 */
        .settings-button {
            position: absolute;
            top: 70px;
            right: 15px;
            width: 45px;
            height: 45px;
            background: rgba(255, 255, 255, 0.98);
            border: 3px solid #333;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            color: #333;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .fullscreen-button:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* 설정 모달 스타일 */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .settings-container {
            background: white;
            border-radius: 8px;
            width: 95%;
            max-width: 900px;
            height: 85%;
            max-height: 650px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }

        .settings-header h2 {
            margin: 0;
            color: #333;
            font-size: 18px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .close-btn:hover {
            background: #e9ecef;
        }

        .settings-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .settings-sidebar {
            width: 160px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            padding: 8px 0;
            overflow-y: auto;
        }

        .sidebar-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            font-size: 13px;
        }

        .sidebar-item:hover {
            background: #e3f2fd;
        }

        .sidebar-item.active {
            background: #bbdefb;
            border-left-color: #2196f3;
            font-weight: bold;
        }

        .settings-main {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
        }

        .settings-panel {
            display: none;
        }

        .settings-panel.active {
            display: block;
        }

        .settings-panel h3 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 16px;
        }

        .setting-group {
            margin: 4px 0;
            padding: 6px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .setting-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .volume-slider {
            width: 100%;
            margin: 6px 0;
        }

        .volume-value {
            color: #666;
            font-size: 14px;
        }

        .palette-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 4px;
        }

        .palette-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            min-height: 32px;
        }

        .palette-item:hover {
            background: #e3f2fd;
        }

        .palette-item.active {
            border-color: #2196f3;
            background: #bbdefb;
        }

        .palette-name {
            font-weight: 500;
            color: #333;
            font-size: 14px;
            line-height: 1.2;
            width: 100%;
        }

        /* 색상 설정 2단 레이아웃 */
        .color-settings-layout {
            display: flex;
            gap: 12px;
            height: 100%;
        }

        .palette-selection {
            flex: 1;
            min-width: 0;
        }

        .palette-preview {
            flex: 2;
            min-width: 0;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .palette-preview h4 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 14px;
        }

        .mini-board-container {
            background: white;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .mini-board {
            width: 200px;
            height: 150px;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(7, 1fr);
            gap: 1px;
            background: #333;
            border-radius: 6px;
            padding: 2px;
        }

        .mini-space {
            background: #fff;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: bold;
            color: #333;
        }

        .palette-info {
            margin-bottom: 15px;
        }

        .palette-info .palette-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .palette-info .palette-theme {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            font-style: italic;
        }

        .palette-colors {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .color-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .color-swatch {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .preview-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-apply, .btn-cancel {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-apply {
            background: #2196f3;
            color: white;
        }

        .btn-apply:hover {
            background: #1976d2;
        }

        .btn-cancel {
            background: #f5f5f5;
            color: #666;
        }

        .btn-cancel:hover {
            background: #e0e0e0;
        }

        /* 모바일 반응형 */
        @media (max-width: 768px) {
            .settings-container {
                width: 95%;
                height: 90%;
            }
            
            .settings-content {
                flex-direction: column;
            }
            
            .settings-sidebar {
                width: 100%;
                height: auto;
                max-height: 120px;
                flex-direction: row;
                overflow-x: auto;
                padding: 10px;
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }
            
            .sidebar-item {
                min-width: 80px;
                text-align: center;
                padding: 10px 5px;
                border-left: none;
                border-bottom: 3px solid transparent;
            }
            
            .sidebar-item.active {
                border-left: none;
                border-bottom-color: #2196f3;
            }
            
            
            .color-settings-layout {
                flex-direction: column;
            }
            
            .palette-preview {
                width: 100%;
                min-width: auto;
            }
            
            .mini-board {
                width: 150px;
                height: 120px;
            }
        }

        .fullscreen-button:active {
            transform: scale(0.95);
        }

        .settings-button:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .settings-button:active {
            transform: scale(0.95);
        }

        .fullscreen-icon {
            position: relative;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 기본 상태: 확대 아이콘 표시, 축소 아이콘 숨김 */
        .fullscreen-icon .expand-icon {
            display: block;
        }

        .fullscreen-icon .minimize-icon {
            display: none;
        }

        /* 전체화면 상태: 확대 아이콘 숨김, 축소 아이콘 표시 */
        .fullscreen-icon.minimize .expand-icon {
            display: none;
        }

        .fullscreen-icon.minimize .minimize-icon {
            display: block;
        }

        /* SVG 아이콘 스타일 */
        .fullscreen-icon svg {
            transition: all 0.2s ease;
        }

        .fullscreen-button:hover .fullscreen-icon svg {
            transform: scale(1.1);
        }

        /* 전체화면 모드일 때 */
        .fullscreen-mode {
            margin: 0 !important;
            padding: 0 !important;
        }

        .fullscreen-mode .board-container {
            padding: 2px 2vw !important;
            margin: 0 !important;
            overflow: hidden !important;
            clip-path: inset(0) !important;
        }

        .fullscreen-mode .game-board {
            width: 95vw;
            height: calc(100% - 4px);
            margin: 0 !important;
            overflow: hidden !important;
            clip-path: inset(0) !important;
        }

        .fullscreen-mode .center-panel {
            width: calc(95vw * 4.5 / 7);
            max-width: calc(95vw * 4.5 / 7);
            min-width: calc(95vw * 4.5 / 7);
            box-sizing: border-box;
        }


        /* 새로운 SVG 기반 주사위 스타일 */
        .dice-display {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dice-icon {
            width: 64px;
            height: 64px;
            fill: #374151;
        }

        /* 주사위 표시 영역의 주사위 아이콘 스타일 */
        #diceIcon {
            fill: #374151;
        }

        .dice-icon.spinning {
            animation: spin 0.1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .control-button {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
            border: 2px solid #B8860B;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
            transition: all 0.3s ease;
        }

        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.6);
            background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
        }

        .control-button:active {
            transform: translateY(0);
        }

        .control-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* 팝업 스타일 */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        /* 황금 열쇠 팝업은 어두운 배경 없이 */
        #goldenKeyPopup {
            background: transparent;
        }

        .popup-overlay.show {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .popup-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 90vw;
            max-height: calc(var(--vh, 1vh) * 80);
            width: 500px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
            overflow-y: auto;
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(50px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .popup-title {
            color: white;
            text-align: center;
            margin: 0 0 20px 0;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .popup-content {
            color: white;
            text-align: center;
            margin: 0 0 25px 0;
            font-size: 16px;
            line-height: 1.5;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .popup-button {
            background: white;
            color: #333;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .popup-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            background: #f8f9fa;
        }

        /* 반응형 디자인 */
        
        /* 전체화면 버튼 반응형 */
        @media (max-width: 768px) {
            .fullscreen-button {
                width: 35px;
                height: 35px;
                font-size: 16px;
                top: 8px;
                right: 8px;
            }
            .settings-button {
                width: 35px;
                height: 35px;
                font-size: 16px;
                top: 50px;
                right: 8px;
            }
        }

        @media (max-width: 480px) {
            .fullscreen-button {
                width: 30px;
                height: 30px;
                font-size: 14px;
                top: 5px;
                right: 5px;
            }
            .settings-button {
                width: 30px;
                height: 30px;
                font-size: 14px;
                top: 40px;
                right: 5px;
            }
        }
        
        /* 중간 크기 화면 - 2줄 배치 (2x2) */
        @media (max-width: 900px) {
            .center-panel {
                padding: 15px 20px;
                gap: 12px;
                width: calc(85vw * 4.5 / 7);
                max-width: calc(85vw * 4.5 / 7);
                min-width: calc(85vw * 4.5 / 7);
                box-sizing: border-box;
            }
            
            .players-section {
                gap: 8px;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .player-info {
                min-width: 180px;
                padding: 10px 12px;
                gap: 10px;
                flex: 1 1 calc(50% - 4px);
                max-width: calc(50% - 4px);
            }
            
            .player-avatar {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            .player-name {
                font-size: 13px;
            }
            
            .player-score {
                font-size: 12px;
            }
            
            .player-lands {
                font-size: 11px;
            }
            
            .controls-section {
                gap: 10px;
            }
            
            .game-board {
                width: 85vw;
                height: calc(100% - 4px);
                aspect-ratio: 1.4 / 1;
            }
        }

        /* 태블릿 크기 - 2줄 배치 유지 */
        @media (max-width: 768px) {
            .center-panel {
                padding: 15px 18px;
                gap: 10px;
                width: calc(85vw * 4.5 / 7);
                max-width: calc(85vw * 4.5 / 7);
                min-width: calc(85vw * 4.5 / 7);
                box-sizing: border-box;
            }
            
            .players-section {
                gap: 6px;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .player-info {
                min-width: 160px;
                padding: 8px 10px;
                gap: 8px;
                flex: 1 1 calc(50% - 3px);
                max-width: calc(50% - 3px);
            }
            
            .player-avatar {
                width: 36px;
                height: 36px;
                font-size: 15px;
            }
            
            .player-name {
                font-size: 12px;
            }
            
            .player-score {
                font-size: 11px;
            }
            
            .player-lands {
                font-size: 10px;
            }
            
            .controls-section {
                gap: 8px;
            }
            
            .game-board {
                width: 85vw;
                height: calc(100% - 4px);
                aspect-ratio: 1.4 / 1;
            }
        }

        /* 작은 화면 - 4줄 배치 (세로) */
        @media (max-width: 600px) {
            .center-panel {
                padding: 12px 15px;
                gap: 8px;
                width: calc(90vw * 4.5 / 7);
                max-width: calc(90vw * 4.5 / 7);
                min-width: calc(90vw * 4.5 / 7);
                box-sizing: border-box;
            }
            
            .players-section {
                gap: 6px;
                flex-wrap: wrap;
                flex-direction: column;
                align-items: center;
            }
            
            .player-info {
                min-width: 220px;
                padding: 8px 12px;
                gap: 10px;
                flex: none;
                width: 100%;
                max-width: 250px;
            }
            
            .player-avatar {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            
            .player-name {
                font-size: 12px;
            }
            
            .player-score {
                font-size: 11px;
            }
            
            .controls-section {
                gap: 8px;
            }
            
            .game-board {
                width: 90vw;
                height: calc(100% - 4px);
                aspect-ratio: 1.4 / 1;
            }
        }

        @media (max-width: 480px) {
            .center-panel {
                padding: 10px 12px;
                gap: 6px;
                width: calc(90vw * 4.5 / 7);
                max-width: calc(90vw * 4.5 / 7);
                min-width: calc(90vw * 4.5 / 7);
                box-sizing: border-box;
            }
            
            .players-section {
                gap: 4px;
                flex-wrap: wrap;
                flex-direction: column;
                align-items: center;
            }
            
            .player-info {
                min-width: 200px;
                padding: 6px 10px;
                gap: 8px;
                flex: none;
                width: 100%;
                max-width: 230px;
            }
            
            .player-avatar {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
            
            .player-name {
                font-size: 11px;
            }
            
            .player-score {
                font-size: 10px;
            }
            
            .player-lands {
                font-size: 9px;
            }
            
            .controls-section {
                gap: 8px;
            }
            
            .player-avatar {
                width: 30px;
                height: 30px;
                font-size: 12px;
            }
            
            .player-name {
                font-size: 12px;
            }
            
            .player-score {
                font-size: 10px;
            }
            
            .golden-keys {
                font-size: 10px;
            }
            
            .controls-section {
                gap: 8px;
            }
            
            .game-board {
                width: 90vw;
                height: calc(100% - 4px);
                aspect-ratio: 1.4 / 1;
            }
            
            .space-number {
                font-size: clamp(6px, 3vw, 14px);
            }
            
            .space-name {
                font-size: clamp(5px, 2.5vw, 10px);
            }
        }



        /* 황금 열쇠 발견 메시지 팝업 */
        .golden-discovery-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #FFD700, #FFA500, #FFD700);
            border: 4px solid #B8860B;
            border-radius: 20px;
            padding: 30px 40px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8), 0 0 60px rgba(255, 165, 0, 0.6);
            z-index: 1000;
            text-align: center;
            font-family: 'Arial', sans-serif;
            min-width: 300px;
            max-width: 500px;
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .golden-discovery-popup.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        /* 슈퍼 점프 모드 스타일 */
        .super-jump-target {
            border: 3px solid #FFD700 !important;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            cursor: pointer !important;
            animation: superJumpPulse 1.5s infinite;
        }

        .super-jump-disabled {
            opacity: 0.3 !important;
            cursor: not-allowed !important;
            filter: grayscale(50%);
        }

        @keyframes superJumpPulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 0 25px rgba(255, 215, 0, 1);
            }
        }

        .super-jump-mode-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #00BFFF, #00CED1, #9370DB);
            color: #fff;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 16px;
            border: 3px solid #00BFFF;
            box-shadow: 0 0 30px rgba(0, 191, 255, 0.6);
            z-index: 1000;
            animation: superJumpIndicatorPulse 2s infinite;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        @keyframes superJumpIndicatorPulse {
            0%, 100% { 
                opacity: 1;
                box-shadow: 0 0 30px rgba(0, 191, 255, 0.6);
            }
            50% { 
                opacity: 0.8;
                box-shadow: 0 0 40px rgba(0, 191, 255, 0.8);
            }
        }

        /* 주사위 버튼 활성화 효과 */
        .dice-button-active {
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            border: 3px solid #FFD700;
            transform: scale(1.05);
            background: linear-gradient(135deg, #FFD700, #FFA500);
        }

        /* 황금 텍스트 효과 */
        .dice-button-active #buttonText,
        .dice-button-urgent #buttonText {
            background: linear-gradient(90deg, 
                #2F1B14, #5D4E37, #8B7355, #5D4E37, #2F1B14);
            background-size: 300% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbowText 2s ease-in-out infinite;
            font-weight: bold;
            text-shadow: none;
        }

        @keyframes rainbowText {
            0% { background-position: 0% 0%; }
            50% { background-position: 100% 0%; }
            100% { background-position: 0% 0%; }
        }

        .dice-button-active:hover {
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            transform: scale(1.1);
            background: linear-gradient(135deg, #FFA500, #FF8C00);
        }



        /* 주사위 버튼 비활성화 상태 */
        .dice-button-disabled {
            opacity: 0.5;
            cursor: not-allowed;
            animation: none;
            box-shadow: none;
            transform: scale(1);
        }

        /* 주사위 버튼 긴급 상태 (턴 대기) */
        .dice-button-urgent {
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.8);
            border: 3px solid #FFD700;
            background: linear-gradient(135deg, #FFD700, #FFA500);
        }


        /* 슈퍼 점프 모드 팝업 스타일 */
        .super-jump-mode .popup-container {
            background: linear-gradient(135deg, #00BFFF, #00CED1, #9370DB);
            border: 3px solid #00BFFF;
            box-shadow: 0 0 30px rgba(0, 191, 255, 0.6);
        }

        .super-jump-mode .popup-title {
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .super-jump-mode .popup-content {
            color: #fff;
        }

        .super-jump-mode .popup-button {
            background: linear-gradient(135deg, #9370DB, #00CED1);
            color: #fff;
            border: 2px solid #00BFFF;
            box-shadow: 0 4px 15px rgba(147, 112, 219, 0.4);
        }

        .super-jump-mode .popup-button:hover {
            background: linear-gradient(135deg, #00CED1, #00BFFF);
            box-shadow: 0 6px 20px rgba(0, 191, 255, 0.6);
        }

        /* 황금 열쇠 모드 팝업 스타일 */
        .golden-key-mode .popup-container {
            background: linear-gradient(135deg, #FFD700, #FFA500, #FF6347);
            border: 3px solid #FFD700;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
        }

        .golden-key-mode .popup-title {
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .golden-key-mode .popup-content {
            color: #fff;
        }

        .golden-key-mode .popup-button {
            background: linear-gradient(135deg, #FF6347, #FFA500);
            color: #fff;
            border: 2px solid #FFD700;
            box-shadow: 0 4px 15px rgba(255, 99, 71, 0.4);
        }

        .golden-key-mode .popup-button:hover {
            background: linear-gradient(135deg, #FFA500, #FFD700);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
        }

        /* 무인도 모드 팝업 스타일 */
        .island-mode .popup-container {
            background: linear-gradient(135deg, #424242, #616161, #757575);
            border: 3px solid #424242;
            box-shadow: 0 0 30px rgba(66, 66, 66, 0.6);
        }

        .island-mode .popup-title {
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .island-mode .popup-content {
            color: #fff;
        }

        .island-mode .popup-button {
            background: linear-gradient(135deg, #616161, #757575);
            color: #fff;
            border: 2px solid #424242;
            box-shadow: 0 4px 15px rgba(97, 97, 97, 0.4);
        }

        .island-mode .popup-button:hover {
            background: linear-gradient(135deg, #757575, #424242);
            box-shadow: 0 6px 20px rgba(66, 66, 66, 0.6);
        }

        /* 기부금 모드 팝업 스타일 */
        .donation-mode .popup-container {
            background: linear-gradient(135deg, #FF69B4, #FF1493, #FFB6C1);
            border: 3px solid #FF69B4;
            box-shadow: 0 0 30px rgba(255, 105, 180, 0.6);
        }

        .donation-mode .popup-title {
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .donation-mode .popup-content {
            color: #fff;
        }

        .donation-mode .popup-button {
            background: linear-gradient(135deg, #FF1493, #FF69B4);
            color: #fff;
            border: 2px solid #FF69B4;
            box-shadow: 0 4px 15px rgba(255, 20, 147, 0.4);
        }

        .donation-mode .popup-button:hover {
            background: linear-gradient(135deg, #FF69B4, #FF1493);
            box-shadow: 0 6px 20px rgba(255, 105, 180, 0.6);
        }

        /* 무인도 모드 표시기 (제거됨) */
        /*
        .island-mode-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #8B0000, #DC143C, #B22222);
            color: #fff;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 16px;
            border: 3px solid #8B0000;
            box-shadow: 0 0 30px rgba(139, 0, 0, 0.6);
            z-index: 1000;
            animation: islandIndicatorPulse 2s infinite;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        @keyframes islandIndicatorPulse {
            0%, 100% { 
                opacity: 1;
                box-shadow: 0 0 30px rgba(139, 0, 0, 0.6);
            }
            50% { 
                opacity: 0.8;
                box-shadow: 0 0 40px rgba(139, 0, 0, 0.8);
            }
        }
        */


        .golden-event-title {
            font-size: 1.8em;
            font-weight: bold;
            color: #8B4513;
            margin: 0 0 15px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .golden-event-content {
            font-size: 1.2em;
            color: #8B4513;
            margin: 0 0 20px 0;
            font-weight: 500;
        }

        .mystery-box-result {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 215, 0, 0.2);
            border-radius: 8px;
            border: 1px solid #B8860B;
        }

        .mystery-box-result p {
            font-size: 1.1em;
            font-weight: bold;
            color: #8B4513;
            margin: 0;
            text-align: center;
        }

        .golden-event-actions {
            text-align: center;
        }

        .golden-event-actions .btn-confirm {
            background: linear-gradient(135deg, #B8860B, #DAA520, #B8860B);
            color: #fff;
            border: 2px solid #8B4513;
            border-radius: 10px;
            padding: 12px 30px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .golden-event-actions .btn-confirm:hover {
            background: linear-gradient(135deg, #DAA520, #FFD700, #DAA520);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        @keyframes goldenTextShine {
            0%, 100% { 
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            }
            50% { 
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3), 0 0 10px #FFD700, 0 0 20px #FFD700;
            }
        }

        /* 보드 칸 색상 - CSS 변수 사용 */
        .space-start { background: var(--color-start); color: #fff; }
        .space-quiz { background: var(--color-quiz); color: #fff; }
        .space-golden { background: var(--color-golden); color: #000; }
        .space-special { background: var(--color-special); color: #fff; }
        .space-corner { background: var(--color-corner); color: #fff; }
        .space-finish { background: var(--color-start); color: #fff; }
        .space-island { background: var(--color-corner); color: #fff; }
        .space-free { background: var(--color-corner); color: #fff; }
        .space-goto { background: var(--color-corner); color: #fff; }
        
        .donation-amount {
            font-size: 10px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            margin-top: 2px;
        }

        /* 황금 열쇠 칸 스타일 */
        .space-content {
            font-size: 24px;
            text-align: center;
            margin-top: 5px;
            line-height: 1;
        }

        /* 땅 내용 래퍼 스타일 */
        .space-content-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
        }

        /* 별 표시 스타일 */
        .star-display {
            font-size: clamp(11px, 2.8vw, 22px);
            line-height: 1;
            text-align: center;
            margin-top: 5px;
        }

        /* 황금 열쇠 칸 텍스트 스타일 (슈퍼 점프와 동일한 글자체 및 크기) */
        .board-space[data-space="3"] .space-name,
        .board-space[data-space="9"] .space-name,
        .board-space[data-space="15"] .space-name,
        .board-space[data-space="21"] .space-name {
            font-family: inherit !important;
            font-size: clamp(8px, 2.2vw, 16px) !important;
            font-weight: bold !important;
            color: #8B4513 !important;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3) !important;
            text-align: center !important;
            line-height: 1.2 !important;
            letter-spacing: 0.5px !important;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- 게임 보드 -->
        <div class="board-container">
            <!-- 전체화면 버튼 -->
            <button class="fullscreen-button" id="fullscreenBtn" onclick="toggleFullscreen()" title="전체화면 토글">
                <div class="fullscreen-icon" id="fullscreenIcon">
                    <!-- 확대 아이콘 (기본 상태) - 서로 멀어지는 화살표 -->
                    <svg class="expand-icon" viewBox="0 0 20 20" width="20" height="20">
                        <g transform="translate(10, 10) rotate(45)">
                            <!-- 왼쪽으로 향하는 화살표 (길이 2배) -->
                            <path d="M -1 0 L -13 0" stroke="#333" stroke-width="1.5" fill="none"/>
                            <path d="M -9 -4 L -13 0 L -9 4" stroke="#333" stroke-width="1.5" fill="none" stroke-linejoin="round"/>
                            
                            <!-- 오른쪽으로 향하는 화살표 (길이 2배) -->
                            <path d="M 1 0 L 13 0" stroke="#333" stroke-width="1.5" fill="none"/>
                            <path d="M 9 -4 L 13 0 L 9 4" stroke="#333" stroke-width="1.5" fill="none" stroke-linejoin="round"/>
                        </g>
                    </svg>
                    <!-- 축소 아이콘 (전체화면 상태) - 서로를 향하는 화살표 -->
                    <svg class="minimize-icon" viewBox="0 0 20 20" width="20" height="20">
                        <g transform="translate(10, 10) rotate(45)">
                            <!-- 오른쪽에서 왼쪽으로 향하는 화살표 (길이 2배) -->
                            <path d="M 13 0 L 1 0" stroke="#333" stroke-width="1.5" fill="none"/>
                            <path d="M 5 -4 L 1 0 L 5 4" stroke="#333" stroke-width="1.5" fill="none" stroke-linejoin="round"/>
                            
                            <!-- 왼쪽에서 오른쪽으로 향하는 화살표 (길이 2배) -->
                            <path d="M -13 0 L -1 0" stroke="#333" stroke-width="1.5" fill="none"/>
                            <path d="M -5 -4 L -1 0 L -5 4" stroke="#333" stroke-width="1.5" fill="none" stroke-linejoin="round"/>
                        </g>
                    </svg>
            </div>
            </button>

            <!-- 설정 버튼 -->
            <button class="settings-button" id="settingsBtn" onclick="openSettings()" title="게임 설정">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
            </button>

            <!-- 중앙 UI 패널 -->
            <div class="center-panel">
            <!-- 플레이어 정보 -->
            <div class="players-section" id="players-section">
                <!-- 플레이어 카드들이 동적으로 생성됩니다 -->
            </div>
            
            <!-- 게임 컨트롤 -->
            <div class="controls-section">
                <div class="dice-controls">
                        <div class="dice-display" id="diceDisplay">
                            <svg class="dice-icon" id="diceIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect width="18" height="18" x="3" y="3" rx="2" ry="2"/>
                                <circle cx="12" cy="12" r="1"/>
                            </svg>
                        </div>
                    <button class="control-button" id="rollDiceBtn" onclick="rollDice()">
                            <span id="buttonText">Touch</span>
                    </button>
                </div>
                </div>
            </div>
            
            <div class="game-board" id="gameBoard">
                <!-- 보드 칸들이 JavaScript로 동적 생성됩니다 -->
            </div>
        </div>
    </div>

    <!-- 퀴즈 팝업 -->
    <div class="popup-overlay" id="quizPopup">
        <div class="popup-container">
            <h2 class="popup-title">🧠 퀴즈 도전!</h2>
            <div class="popup-content" id="quizContent">
                <p id="quizQuestion">문제가 로드 중입니다...</p>
                <div id="quizOptions"></div>
                <div id="quizTimer">⏰ 남은 시간: <span id="timeLeft">30</span>초</div>
            </div>
        </div>
    </div>

    <!-- 황금 열쇠 팝업 -->
    <div class="popup-overlay" id="goldenKeyPopup">
        <div class="popup-container">
            <h2 class="popup-title" id="eventTitle">✨ 황금 열쇠 이벤트!</h2>
            <div class="popup-content" id="eventContent">
                <p id="eventDescription">이벤트가 로드 중입니다...</p>
            </div>
            <button class="popup-button" onclick="closeGoldenKey()">확인</button>
        </div>
    </div>

    <!-- 황금 열쇠 이벤트 팝업 -->
    <div class="golden-discovery-popup" id="goldenDiscoveryPopup">
        <div class="golden-event-title" id="discoveryEventTitle">✨ 황금 열쇠 이벤트!</div>
        <div class="golden-event-content" id="discoveryEventContent">
            <p id="discoveryEventDescription">이벤트가 로드 중입니다...</p>
            <div class="mystery-box-result" id="mysteryBoxResult" style="display: none;">
                <p id="mysteryBoxResultText"></p>
            </div>
        </div>
        <div class="golden-event-actions">
            <button class="btn-confirm" onclick="closeGoldenDiscovery()">확인</button>
        </div>
    </div>

    <!-- 턴 전환 알림 팝업 -->
    <div class="popup-overlay" id="turnNotificationPopup">
        <div class="popup-container">
            <h2 class="popup-title">🎮 턴 전환</h2>
            <div class="popup-content">
                <p id="turnNotificationText">플레이어 2의 차례입니다.</p>
            </div>
            <button class="popup-button" onclick="closeTurnNotification()">확인</button>
        </div>
    </div>

    <!-- 설정 관리 스크립트 -->
    
    <script>
        // 숫자 포맷팅 유틸리티 함수
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // 게임 상태 관리 클래스
        class GameStateManager {
            constructor() {
                this.state = {
            players: [
                        { id: 1, name: '플레이어 1', color: '#1976D2', position: 0, score: 1000, isActive: true, isWaitJump: false, hasSuperJumpChance: false, isOnIsland: false, islandTurnCount: 0, islandQuizStreak: 0 },
                        { id: 2, name: '플레이어 2', color: '#E65100', position: 0, score: 1000, isActive: false, isWaitJump: false, hasSuperJumpChance: false, isOnIsland: false, islandTurnCount: 0, islandQuizStreak: 0 },
                        { id: 3, name: '플레이어 3', color: '#388E3C', position: 0, score: 1000, isActive: false, isWaitJump: false, hasSuperJumpChance: false, isOnIsland: false, islandTurnCount: 0, islandQuizStreak: 0 },
                        { id: 4, name: '플레이어 4', color: '#7B1FA2', position: 0, score: 1000, isActive: false, isWaitJump: false, hasSuperJumpChance: false, isOnIsland: false, islandTurnCount: 0, islandQuizStreak: 0 }
            ],
            currentPlayer: 1,
            gamePhase: 'waiting',
            diceValue: 0,
                    donationFund: 0,
                    // 특수 모드 관리
                    modes: {
                        superJump: { active: false, failed: false },
                        goldenKey: { active: false, event: null },
                        island: { active: false, escapePhase: null, justEscaped: false }
                    }
                };
            }

            // 상태 업데이트
            updateState(updates) {
                Object.assign(this.state, updates);
                this.notifyStateChange();
            }

            // 특수 모드 관리
            setMode(modeName, modeData) {
                this.state.modes[modeName] = { ...this.state.modes[modeName], ...modeData };
                this.notifyStateChange();
            }

            // 현재 플레이어 가져오기
            getCurrentPlayer() {
                return this.state.players.find(p => p.id === this.state.currentPlayer);
            }

            // 상태 변경 알림
            notifyStateChange() {
                // UI 업데이트 트리거
                if (window.updateUI) {
                    window.updateUI();
                }
            }
        }

        // 게임 상태 인스턴스
        const gameStateManager = new GameStateManager();
        const gameState = gameStateManager.state; // 기존 코드 호환성을 위한 참조

        // 팝업 관리 시스템
        class PopupManager {
            constructor() {
                this.activePopups = new Set();
                this.popupQueue = [];
            }

            // 팝업 표시
            show(popupId, options = {}) {
                const popup = document.getElementById(popupId);
                if (!popup) return;

                // 기존 팝업이 있으면 큐에 추가
                if (this.activePopups.size > 0) {
                    this.popupQueue.push({ popupId, options });
                    return;
                }

                this.activePopups.add(popupId);
                
                // 스타일 적용
                if (options.theme) {
                    popup.classList.add(`${options.theme}-mode`);
                }

                // 내용 업데이트
                if (options.title) {
                    const titleEl = popup.querySelector('.popup-title');
                    if (titleEl) titleEl.textContent = options.title;
                }
                if (options.content) {
                    const contentEl = popup.querySelector('.popup-content');
                    if (contentEl) contentEl.innerHTML = options.content;
                }

                popup.classList.add('show');
            }

            // 팝업 닫기
            close(popupId, callback = null) {
                const popup = document.getElementById(popupId);
                if (!popup) return;

                popup.classList.remove('show');
                popup.classList.remove('super-jump-mode', 'golden-key-mode');
                this.activePopups.delete(popupId);

                // 콜백 실행
                if (callback) {
                    setTimeout(callback, 300); // 애니메이션 완료 후
                }

                // 큐에서 다음 팝업 처리
                if (this.popupQueue.length > 0) {
                    const next = this.popupQueue.shift();
                    setTimeout(() => this.show(next.popupId, next.options), 100);
                }
            }

            // 모든 팝업 닫기
            closeAll() {
                this.activePopups.forEach(popupId => {
                    const popup = document.getElementById(popupId);
                    if (popup) {
                        popup.classList.remove('show');
                        popup.classList.remove('super-jump-mode', 'golden-key-mode');
                    }
                });
                this.activePopups.clear();
                this.popupQueue = [];
            }
        }

        // 팝업 매니저 인스턴스
        const popupManager = new PopupManager();

        // 이벤트 처리 시스템
        class EventHandler {
            constructor() {
                this.eventHandlers = new Map();
            }

            // 이벤트 등록
            on(eventType, handler) {
                if (!this.eventHandlers.has(eventType)) {
                    this.eventHandlers.set(eventType, []);
                }
                this.eventHandlers.get(eventType).push(handler);
            }

            // 이벤트 발생
            emit(eventType, data = {}) {
                const handlers = this.eventHandlers.get(eventType);
                if (handlers) {
                    handlers.forEach(handler => handler(data));
                }
            }

            // 이벤트 제거
            off(eventType, handler) {
                const handlers = this.eventHandlers.get(eventType);
                if (handlers) {
                    const index = handlers.indexOf(handler);
                    if (index > -1) {
                        handlers.splice(index, 1);
                    }
                }
            }
        }

        // 이벤트 핸들러 인스턴스
        const eventHandler = new EventHandler();

        // 게임 이벤트 정의
        const GAME_EVENTS = {
            TURN_START: 'turnStart',
            TURN_END: 'turnEnd',
            PLAYER_MOVE: 'playerMove',
            QUIZ_START: 'quizStart',
            QUIZ_END: 'quizEnd',
            SUPER_JUMP_START: 'superJumpStart',
            SUPER_JUMP_END: 'superJumpEnd',
            GOLDEN_KEY_FOUND: 'goldenKeyFound',
            SPACE_ACTION: 'spaceAction'
        };

        // 주사위 버튼 상태 관리 (개선된 버전)
        class DiceButtonManager {
            constructor() {
                this.button = document.getElementById('rollDiceBtn');
                this.currentState = 'disabled';
                this.stateClasses = ['dice-button-active', 'dice-button-disabled', 'dice-button-urgent'];
                this.stateRules = new Map([
                    ['superJumpMode', () => this.setState('disabled')],
                    ['superJumpFailed', () => this.setState('active', true)],
                    ['waiting', () => this.setState('active')],
                    ['default', () => this.setState('disabled')]
                ]);
            }

            // 버튼 상태 설정 (최적화된 버전)
            setState(state, urgent = false) {
                if (!this.button) return;

                // 기존 상태 클래스 제거 (배치 처리)
                this.button.classList.remove(...this.stateClasses);

                // 새 상태 클래스 추가
                const stateClass = urgent ? 'dice-button-urgent' : `dice-button-${state}`;
                this.button.classList.add(stateClass);
                this.button.disabled = state === 'disabled';
                this.currentState = state;
            }

            // 게임 상태에 따른 자동 상태 설정 (규칙 기반)
            updateFromGameState() {
                const { gamePhase, superJumpMode, superJumpFailed, modes } = gameState;
                const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
                
                // 규칙 우선순위에 따라 실행
                if (superJumpMode) {
                    this.stateRules.get('superJumpMode')();
                } else if (currentPlayer && currentPlayer.isOnIsland) {
                    this.setState('disabled'); // 무인도에 갇힌 플레이어는 주사위 비활성화
                } else if (modes.island.justEscaped) {
                    this.setState('active'); // 무인도에서 방금 탈출한 플레이어는 주사위 활성화
                } else if (superJumpFailed) {
                    this.stateRules.get('superJumpFailed')();
                } else if (gamePhase === 'waiting') {
                    this.stateRules.get('waiting')();
                } else {
                    this.stateRules.get('default')();
                }
            }

            // 새로운 상태 규칙 추가 (확장성)
            addStateRule(condition, action) {
                this.stateRules.set(condition, action);
            }

            // 현재 상태 반환
            getCurrentState() {
                return this.currentState;
            }
        }

        // 주사위 버튼 매니저 인스턴스
        const diceButtonManager = new DiceButtonManager();

        // 게임 상태 모니터링 시스템
        class GameStateMonitor {
            constructor() {
                this.lastActionTime = Date.now();
                this.monitorInterval = null;
                this.isMonitoring = false;
                this.stuckThreshold = 5000; // 5초
                this.warningTime = 3000; // 3초 경고
            }

            // 모니터링 시작
            startMonitoring() {
                if (this.monitorInterval) return;
                
                this.isMonitoring = true;
                this.lastActionTime = Date.now();
                
                this.monitorInterval = setInterval(() => {
                    this.checkGameState();
                }, 1000); // 1초마다 체크
            }

            // 모니터링 중지
            stopMonitoring() {
                if (this.monitorInterval) {
                    clearInterval(this.monitorInterval);
                    this.monitorInterval = null;
                }
                this.isMonitoring = false;
            }

            // 게임 액션 발생 시 호출
            recordAction() {
                this.lastActionTime = Date.now();
            }

            // 게임 상태 체크
            checkGameState() {
                if (!this.isMonitoring) return;

                const currentTime = Date.now();
                const timeSinceLastAction = currentTime - this.lastActionTime;

                // 5초 이상 게임이 멈춰있고, 주사위 버튼이 비활성화된 경우
                if (timeSinceLastAction >= this.stuckThreshold) {
                    const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
                    const isStuck = this.isGameStuck(currentPlayer);
                    
                    if (isStuck) {
                        this.showAutoResetWarning();
                    }
                }
            }

            // 게임이 멈춰있는지 확인
            isGameStuck(currentPlayer) {
                // 주사위 버튼이 비활성화되어 있고
                const diceButton = document.getElementById('rollDiceBtn');
                if (!diceButton || diceButton.disabled) {
                    // 슈퍼 점프 모드가 아니고
                    if (!gameState.superJumpMode) {
                        // 무인도에 갇힌 플레이어가 아니거나 3턴째 이상인 경우
                        if (!currentPlayer?.isOnIsland || currentPlayer.islandTurnCount >= 3) {
                            // 게임 페이즈가 waiting이 아닌 경우
                            if (gameState.gamePhase !== 'waiting') {
                                return true;
                            }
                        }
                    }
                }
                return false;
            }

            // 자동 활성화 경고 표시
            showAutoResetWarning() {
                // 이미 경고가 표시 중이면 중복 표시하지 않음
                if (document.querySelector('.auto-reset-warning')) return;

                const warningDiv = document.createElement('div');
                warningDiv.className = 'auto-reset-warning';
                warningDiv.innerHTML = `
                    <div class="warning-content">
                        <h3>⚠️ 게임이 멈춰있습니다</h3>
                        <p>게임을 다시 활성화합니다...</p>
                        <div class="countdown">3</div>
                    </div>
                `;

                // 스타일 적용
                warningDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(135deg, #ff6b6b, #ee5a24);
                    color: white;
                    padding: 30px;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                    z-index: 10000;
                    text-align: center;
                    font-family: inherit;
                `;

                warningDiv.querySelector('.warning-content h3').style.cssText = `
                    margin: 0 0 15px 0;
                    font-size: 1.5em;
                    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
                `;

                warningDiv.querySelector('.warning-content p').style.cssText = `
                    margin: 0 0 20px 0;
                    font-size: 1.1em;
                `;

                warningDiv.querySelector('.countdown').style.cssText = `
                    font-size: 3em;
                    font-weight: bold;
                    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
                    animation: countdownPulse 1s ease-in-out infinite;
                `;

                document.body.appendChild(warningDiv);

                // 카운트다운 애니메이션
                let countdown = 3;
                const countdownElement = warningDiv.querySelector('.countdown');
                const countdownInterval = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        countdownElement.textContent = countdown;
                    } else {
                        clearInterval(countdownInterval);
                        this.performAutoReset();
                        warningDiv.remove();
                    }
                }, 1000);

                // CSS 애니메이션 추가
                if (!document.querySelector('#countdown-animation')) {
                    const style = document.createElement('style');
                    style.id = 'countdown-animation';
                    style.textContent = `
                        @keyframes countdownPulse {
                            0%, 100% { transform: scale(1); }
                            50% { transform: scale(1.2); }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }

            // 자동 활성화 실행
            performAutoReset() {
                console.log('🔄 자동 게임 상태 활성화 실행');
                
                // 게임 상태 강제 활성화
                gameState.gamePhase = 'waiting';
                gameState.superJumpMode = false;
                gameState.superJumpFailed = false;
                
                // 모든 모드 플래그 활성화
                gameState.modes.superJump.active = false;
                gameState.modes.superJump.failed = false;
                gameState.modes.island.justEscaped = false;
                
                // 주사위 버튼 상태 업데이트
                diceButtonManager.updateFromGameState();
                
                // UI 업데이트
                updateUI();
                
                // 액션 기록 (모니터링 재시작)
                this.recordAction();
                
                // 알림 메시지
                showMessage('게임이 다시 활성화되었습니다.');
            }
        }

        // 게임 상태 모니터 인스턴스
        const gameStateMonitor = new GameStateMonitor();

        // 무인도 관리 클래스
        class IslandManager {
            constructor() {
                this.islandIndicator = null;
            }

            // 무인도에 플레이어 투입
            putPlayerOnIsland(playerId) {
                const player = gameState.players.find(p => p.id === playerId);
                if (!player) return;

                player.isOnIsland = true;
                player.islandTurnCount = 0; // 무인도 투입 시 0으로 시작
                player.islandQuizStreak = 0;
                player.position = 12; // 무인도 위치 (12번 칸)

                gameState.modes.island.active = true;
                gameState.modes.island.escapePhase = 'first';

                // this.showIslandIndicator(); // 무인도 모드 배너 제거
                showIslandPopup(player.name);
                updatePlayerPieces();
            }

            // 무인도 탈출 시도
            attemptIslandEscape(playerId) {
                const player = gameState.players.find(p => p.id === playerId);
                if (!player || !player.isOnIsland) {
                    return;
                }

                // 턴 카운트 증가 (한 바퀴 돌아서 자기 차례가 되었을 때)
                player.islandTurnCount++;

                if (player.islandTurnCount === 1) {
                    // 첫 번째 턴: 2문제 연속 정답 필요
                    console.log('[DEBUG] 첫 번째 턴 - 2문제 연속 정답 필요');
                    gameState.modes.island.escapePhase = 'first';
                    this.showIslandQuiz(player, 2);
                } else if (player.islandTurnCount === 2) {
                    // 두 번째 턴: 1문제 정답 필요
                    console.log('[DEBUG] 두 번째 턴 - 1문제 정답 필요');
                    gameState.modes.island.escapePhase = 'second';
                    this.showIslandQuiz(player, 1);
                } else if (player.islandTurnCount >= 3) {
                    // 세 번째 턴 이상: 주사위로 탈출
                    console.log('[DEBUG] 세 번째 턴 - 주사위로 탈출');
                    this.diceEscape(player);
                } else {
                    // 예상치 못한 상황
                    console.error('[DEBUG] 예상치 못한 무인도 턴 카운트:', player.islandTurnCount);
                }
            }

            // 무인도 퀴즈 표시
            showIslandQuiz(player, requiredStreak) {
                console.log('[DEBUG] showIslandQuiz 호출됨 - 플레이어:', player.name, '필요 연속 정답:', requiredStreak);
                
                // 퀴즈 시작 (showQuiz 함수가 무인도 모드를 자동으로 인식함)
                try {
                    showQuiz();
                    console.log('[DEBUG] showQuiz 호출 완료');
                } catch (error) {
                    console.error('[DEBUG] showQuiz 호출 에러:', error);
                }
            }

            // 퀴즈 정답 처리
            handleIslandQuizAnswer(playerId, isCorrect) {
                const player = gameState.players.find(p => p.id === playerId);
                if (!player || !player.isOnIsland) return;

                if (isCorrect) {
                    player.islandQuizStreak++;
                    
                    if (player.islandTurnCount === 1 && player.islandQuizStreak >= 2) {
                        // 첫 번째 턴에서 2문제 연속 정답
                        this.successfulEscape(player);
                    } else if (player.islandTurnCount === 2 && player.islandQuizStreak >= 1) {
                        // 두 번째 턴에서 1문제 정답
                        this.successfulEscape(player);
                    } else if (player.islandTurnCount === 1 && player.islandQuizStreak < 2) {
                        // 첫 번째 턴에서 아직 2문제 미달성
                        showMessage(`정답! ${2 - player.islandQuizStreak}문제 더 맞춰주세요!`);
                        setTimeout(() => showQuiz(), 1000);
                    }
                } else {
                    // 오답 시 연속 정답 활성화 (턴 카운트는 attemptIslandEscape에서 증가)
                    player.islandQuizStreak = 0;
                    console.log('[DEBUG] 퀴즈 실패 - 연속 정답 활성화');
                    showMessage('틀렸습니다! 다음 턴에 다시 도전하세요.');
                    closeQuiz();
                    
                    // 턴 전환
                    setTimeout(() => {
                        endTurn();
                    }, 1500);
                }
            }

            // 성공적인 탈출
            successfulEscape(player) {
                player.isOnIsland = false;
                player.islandTurnCount = 0;
                player.islandQuizStreak = 0;
                
                gameState.modes.island.active = false;
                gameState.modes.island.escapePhase = null;
                gameState.modes.island.justEscaped = true; // 무인도에서 방금 탈출했음을 표시

                // this.hideIslandIndicator(); // 무인도 모드 배너 제거
                closeQuiz();

                // 탈출 성공 안내 팝업 표시
                showIslandEscapeSuccessPopup(player);
            }

            // 주사위 탈출 (3턴째 이상)
            diceEscape(player) {
                player.isOnIsland = false;
                player.islandTurnCount = 0;
                player.islandQuizStreak = 0;
                
                gameState.modes.island.active = false;
                gameState.modes.island.escapePhase = null;
                gameState.modes.island.justEscaped = true; // 무인도에서 방금 탈출했음을 표시

                // this.hideIslandIndicator(); // 무인도 모드 배너 제거
                
                // 주사위 탈출 성공 안내 팝업 표시
                showIslandDiceEscapeSuccessPopup(player);
            }

            // 무인도 표시기 표시
            showIslandIndicator() {
                if (this.jailIndicator) return;
                
                // 무인도에 갇힌 플레이어가 있는지 확인
                if (!this.hasIslandPlayers()) return;

                this.jailIndicator = document.createElement('div');
                this.jailIndicator.className = 'island-mode-indicator';
                this.jailIndicator.textContent = '🏝️ 무인도 모드';
                document.body.appendChild(this.jailIndicator);
            }

            // 무인도 표시기 숨기기
            hideIslandIndicator() {
                if (this.jailIndicator) {
                    this.jailIndicator.remove();
                    this.jailIndicator = null;
                }
            }

                // 무인도에 갇힌 플레이어가 있는지 확인
            hasIslandPlayers() {
                return gameState.players.some(player => player.isOnIsland);
            }

            // 현재 플레이어가 무인도에 있는지 확인
            isCurrentPlayerOnIsland() {
                const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
                return currentPlayer && currentPlayer.isOnIsland;
            }
        }

        // 무인도 매니저 인스턴스
        const islandManager = new IslandManager();

        // 무인도 탈출 성공 팝업 표시
        function showIslandEscapeSuccessPopup(player) {
            const popup = document.getElementById('turnNotificationPopup');
            const titleEl = popup.querySelector('.popup-title');
            const contentEl = popup.querySelector('.popup-content');
            const buttonEl = popup.querySelector('.popup-button');

            titleEl.textContent = '🎉 무인도 탈출 성공!';
            contentEl.innerHTML = `<p>${player.name}이 무인도에서 탈출했습니다!</p><p>주사위를 굴려 이동하세요.</p>`;
            buttonEl.textContent = '확인';
            buttonEl.onclick = () => {
                closeIslandEscapeSuccessPopup();
            };
            // 무인도 색상 테마 제거 (성공 메시지는 일반 색상 사용)
            popup.classList.remove('island-mode');
            popup.classList.add('show');
        }

        // 기부금 전용 팝업 표시
        function showDonationPopup(donationAmount, totalFund) {
            const popup = document.getElementById('turnNotificationPopup');
            const titleEl = popup.querySelector('.popup-title');
            const contentEl = popup.querySelector('.popup-content');
            const buttonEl = popup.querySelector('.popup-button');

            if (donationAmount > 0) {
                titleEl.textContent = '💕 기부금 모금!';
                contentEl.innerHTML = `<p>기부금 모금에 ${formatNumber(donationAmount)}점을 기부했습니다!</p><p>총 모금액: ${formatNumber(totalFund)}점</p>`;
            } else {
                titleEl.textContent = '💔 기부금 모금';
                contentEl.innerHTML = `<p>점수가 부족하여 기부할 수 없습니다.</p><p>총 모금액: ${formatNumber(totalFund)}점</p>`;
            }
            
            buttonEl.textContent = '확인';
            buttonEl.onclick = () => {
                closeDonationPopup();
            };
            
            // 기부금 색상 테마 적용
            popup.classList.add('donation-mode');
            popup.classList.add('show');
        }

        // 기부금 팝업 닫기
        function closeDonationPopup() {
            const popup = document.getElementById('turnNotificationPopup');
            popup.classList.remove('show');
            popup.classList.remove('donation-mode');
            
            // 기부금 팝업 확인 후 턴 전환
            setTimeout(() => {
                try {
                    endTurn();
                } catch (error) {
                    console.error('기부금 팝업 후 endTurn 에러:', error);
                    // 에러 발생 시 기본 턴 전환 처리
                    const currentPlayerIndex = gameState.players.findIndex(p => p.id === gameState.currentPlayer);
                    if (currentPlayerIndex === -1) {
                        console.error('기부금 팝업 에러 처리 중 현재 플레이어를 찾을 수 없습니다:', gameState.currentPlayer);
                        return;
                    }
                    const nextPlayerIndex = (currentPlayerIndex + 1) % gameState.players.length;
                    gameState.currentPlayer = gameState.players[nextPlayerIndex].id;
                    gameState.gamePhase = 'waiting';
                    updateUI();
                }
            }, 500); // 0.5초 후 턴 전환
        }

        // 무인도 전용 팝업 표시
        function showIslandPopup(playerName) {
            const popup = document.getElementById('turnNotificationPopup');
            const titleEl = popup.querySelector('.popup-title');
            const contentEl = popup.querySelector('.popup-content');
            const buttonEl = popup.querySelector('.popup-button');

            titleEl.textContent = '🏝️ 무인도에 갇혔습니다!';
            contentEl.innerHTML = `<p>${playerName}이 무인도에 갇혔습니다!</p><p>무인도에서 탈출하려면 퀴즈를 맞춰야 합니다.</p>`;
            
            buttonEl.textContent = '확인';
            buttonEl.onclick = () => {
                closeIslandPopup();
            };
            
            // 무인도 색상 테마 적용
            popup.classList.add('island-mode');
            popup.classList.add('show');
        }

        // 무인도 팝업 닫기
        function closeIslandPopup() {
            const popup = document.getElementById('turnNotificationPopup');
            popup.classList.remove('island-mode');
            popup.classList.remove('show');
            
            // 무인도 팝업 확인 후 턴 전환
            setTimeout(() => {
                try {
                    endTurn();
                } catch (error) {
                    console.error('무인도 팝업 후 endTurn 에러:', error);
                    // 에러 발생 시 기본 턴 전환 처리
                    const currentPlayerIndex = gameState.players.findIndex(p => p.id === gameState.currentPlayer);
                    if (currentPlayerIndex === -1) {
                        console.error('무인도 팝업 에러 처리 중 현재 플레이어를 찾을 수 없습니다:', gameState.currentPlayer);
                        return;
                    }
                    const nextPlayerIndex = (currentPlayerIndex + 1) % gameState.players.length;
                    gameState.currentPlayer = gameState.players[nextPlayerIndex].id;
                    gameState.gamePhase = 'waiting';
                    updateUI();
                }
            }, 500); // 0.5초 후 턴 전환
        }

        // 슈퍼 점프 전용 팝업 표시
        function showSuperJumpPopup(playerName) {
            const popup = document.getElementById('turnNotificationPopup');
            const titleEl = popup.querySelector('.popup-title');
            const contentEl = popup.querySelector('.popup-content');
            const buttonEl = popup.querySelector('.popup-button');

            titleEl.textContent = '⚡ 슈퍼 점프!';
            contentEl.innerHTML = `<p>${playerName}이 슈퍼 점프 칸에 도착했습니다!</p><p>다음 차례에 퀴즈를 맞춰 원하는 곳으로 이동할 수 있습니다.</p>`;
            
            buttonEl.textContent = '확인';
            buttonEl.onclick = () => {
                closeSuperJumpPopup();
            };
            
            // 슈퍼 점프 색상 테마 적용
            popup.classList.add('super-jump-mode');
            popup.classList.add('show');
        }

        // 슈퍼 점프 팝업 닫기
        function closeSuperJumpPopup() {
            const popup = document.getElementById('turnNotificationPopup');
            popup.classList.remove('super-jump-mode');
            popup.classList.remove('show');
            
            // 슈퍼 점프 팝업 확인 후 턴 전환
            setTimeout(() => {
                try {
                    endTurn();
                } catch (error) {
                    console.error('슈퍼 점프 팝업 후 endTurn 에러:', error);
                    // 에러 발생 시 기본 턴 전환 처리
                    const currentPlayerIndex = gameState.players.findIndex(p => p.id === gameState.currentPlayer);
                    if (currentPlayerIndex === -1) {
                        console.error('슈퍼 점프 팝업 에러 처리 중 현재 플레이어를 찾을 수 없습니다:', gameState.currentPlayer);
                        return;
                    }
                    const nextPlayerIndex = (currentPlayerIndex + 1) % gameState.players.length;
                    gameState.currentPlayer = gameState.players[nextPlayerIndex].id;
                    gameState.gamePhase = 'waiting';
                    updateUI();
                }
            }, 500); // 0.5초 후 턴 전환
        }

        // 무인도 탈출 성공 팝업 닫기
        function closeIslandEscapeSuccessPopup() {
            const popup = document.getElementById('turnNotificationPopup');
            popup.classList.remove('show');
            
            // 무인도 탈출 플래그 활성화 (주사위 굴린 후 턴 전환을 위해)
            gameState.modes.island.justEscaped = false;
            
            // 무인도에서 탈출한 플레이어는 바로 주사위를 굴릴 수 있도록 설정
            gameState.gamePhase = 'waiting';
            diceButtonManager.updateFromGameState();
            updateUI();
        }

        // 무인도 주사위 탈출 성공 팝업 표시
        function showIslandDiceEscapeSuccessPopup(player) {
            const popup = document.getElementById('turnNotificationPopup');
            const titleEl = popup.querySelector('.popup-title');
            const contentEl = popup.querySelector('.popup-content');
            const buttonEl = popup.querySelector('.popup-button');

            titleEl.textContent = '🎲 무인도에서 주사위 탈출!';
            contentEl.innerHTML = `<p>${player.name}이 무인도에서 주사위로 탈출했습니다!</p><p>주사위를 굴려 이동하세요.</p>`;
            buttonEl.textContent = '확인';
            buttonEl.onclick = () => {
                closeIslandEscapeSuccessPopup();
            };

            popup.classList.add('show');
        }


        // 모바일 뷰포트 높이 문제 해결 함수
        function setViewportHeight() {
            // 실제 뷰포트 높이를 가져옵니다 (브라우저 UI 제외)
            const vh = window.innerHeight * 0.01;
            // CSS 변수 --vh에 값을 설정합니다
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }

        // 뷰포트 높이 설정 이벤트 리스너
        window.addEventListener('resize', setViewportHeight);
        window.addEventListener('orientationchange', setViewportHeight);
        window.addEventListener('load', setViewportHeight);
        
        // 페이지 로드 시 즉시 실행
        document.addEventListener('DOMContentLoaded', function() {
            setViewportHeight();
            createPlayerCards(); // 플레이어 카드 생성
        });

        // 기부금 모금 표시 업데이트 함수
        function updateDonationDisplay() {
            const donationElement = document.getElementById('donationAmount');
            if (donationElement) {
                donationElement.textContent = `${formatNumber(gameState.donationFund)}점`;
            }
        }




        // 7x7 보드 칸 데이터 (스크린샷 기준)
        const boardSpaces = [
            // 시작점 (0) - 우하단
            { id: 0, name: '시작', type: 'start', color: 'space-start' },
            // 하단 변 (1-5) - 오른쪽에서 왼쪽으로
            { id: 1, name: '사랑(1)', type: 'quiz', color: 'space-quiz' },
            { id: 2, name: '존중(2)', type: 'quiz', color: 'space-quiz' },
            { id: 3, name: '황금열쇠', type: 'golden', color: 'space-golden' },
            { id: 4, name: '화합(4)', type: 'quiz', color: 'space-quiz' },
            { id: 5, name: '나눔(5)', type: 'quiz', color: 'space-quiz' },
            // 좌측 변 (7-11) - 아래에서 위로
            { id: 7, name: '배려(7)', type: 'quiz', color: 'space-quiz' },
            { id: 8, name: '용기(8)', type: 'quiz', color: 'space-quiz' },
            { id: 9, name: '황금열쇠', type: 'golden', color: 'space-golden' },
            { id: 10, name: '소통(10)', type: 'quiz', color: 'space-quiz' },
            { id: 11, name: '감사(11)', type: 'quiz', color: 'space-quiz' },
            // 상단 변 (13-17) - 왼쪽에서 오른쪽으로
            { id: 13, name: '협력(13)', type: 'quiz', color: 'space-quiz' },
            { id: 14, name: '열정(14)', type: 'quiz', color: 'space-quiz' },
            { id: 15, name: '황금열쇠', type: 'golden', color: 'space-golden' },
            { id: 16, name: '성실(16)', type: 'quiz', color: 'space-quiz' },
            { id: 17, name: '친절(17)', type: 'quiz', color: 'space-quiz' },
            // 우측 변 (19-23) - 위에서 아래로
            { id: 19, name: '신뢰(19)', type: 'quiz', color: 'space-quiz' },
            { id: 20, name: '정직(20)', type: 'quiz', color: 'space-quiz' },
            { id: 21, name: '황금열쇠', type: 'golden', color: 'space-golden' },
            { id: 22, name: '노력(22)', type: 'quiz', color: 'space-quiz' },
            { id: 23, name: '겸손(23)', type: 'quiz', color: 'space-quiz' },
            // 특별 칸들 (모서리) - BoardColorTest.html과 동일하게 corner 타입으로 변경
            { id: 6, name: '슈퍼 점프', type: 'corner', color: 'space-corner' },
            { id: 12, name: '무인도', type: 'corner', color: 'space-corner' },
            { id: 18, name: '기부금 모금', type: 'corner', color: 'space-corner' },
            { id: 24, name: '특별칸', type: 'special', color: 'space-special' }
        ];

        // 퀴즈 데이터
        const quizQuestions = [
            {
                question: "1 + 1은?",
                options: ["1", "2", "3", "4"],
                correct: 1,
                points: 100
            },
            {
                question: "태양계에서 가장 큰 행성은?",
                options: ["지구", "목성", "토성", "화성"],
                correct: 1,
                points: 200
            },
            {
                question: "한국의 수도는?",
                options: ["부산", "서울", "대구", "인천"],
                correct: 1,
                points: 100
            },
            {
                question: "2 × 3은?",
                options: ["5", "6", "7", "8"],
                correct: 1,
                points: 150
            },
            {
                question: "지구에서 가장 큰 대륙은?",
                options: ["아시아", "아프리카", "유럽", "북아메리카"],
                correct: 0,
                points: 200
            }
        ];

        // 황금 열쇠 이벤트
        const goldenKeyEvents = [
            {
                name: "🚀 로켓 부스터",
                description: "즉시 출발지로 워프 이동! 통과 보너스 400점 획득!",
                effect: () => {
                    const player = gameState.players.find(p => p.id === gameState.currentPlayer);
                    player.position = 0;
                    player.score += 400;
                    
                    // 워프 이동으로 인해 슈퍼 점프 기회 취소 (무인도 상태는 유지)
                    if (player.hasSuperJumpChance) {
                        player.hasSuperJumpChance = false;
                    }
                    
                    updateUI();
                }
            },
            {
                name: "💰 복권 당첨",
                description: "축하합니다! 500점을 획득했습니다!",
                effect: () => {
                    const player = gameState.players.find(p => p.id === gameState.currentPlayer);
                    player.score += 500;
                    updateUI();
                }
            },
            {
                name: "🌪️ 토네이도 습격",
                description: "다른 플레이어들이 랜덤 위치로 흩어지고 50점씩 차감됩니다!",
                effect: () => {
                    const currentPlayerId = gameState.currentPlayer;
                    gameState.players.forEach(player => {
                        // 현재 플레이어(황금 열쇠에 도착한 플레이어)는 제외
                        if (player.id !== currentPlayerId) {
                            // 무인도에 있는 플레이어는 토네이도로 이동하지 않음
                            if (player.isOnIsland) {
                                return;
                            }
                            
                            // 토네이도로 랜덤 위치 이동 (무인도 제외)
                            let newPosition;
                            do {
                                newPosition = Math.floor(Math.random() * 24);
                            } while (newPosition === 12); // 무인도(12번 칸) 제외
                            
                            player.position = newPosition;
                            player.score = Math.max(0, player.score - 50);
                            
                            // 토네이도로 인해 이동한 경우 슈퍼 점프 기회 취소 (무인도 상태는 유지)
                            if (player.hasSuperJumpChance) {
                                player.hasSuperJumpChance = false;
                            }
                            
                            console.log(`[DEBUG] 토네이도 - ${player.name}이 ${newPosition}번 칸으로 이동`);
                        }
                    });
                    updatePlayerPieces();
                    updateUI();
                }
            },
            {
                name: "💰 기부금 수령하기",
                description: "기부금 모금에서 모든 금액을 가져갑니다!",
                effect: () => {
                    const player = gameState.players.find(p => p.id === gameState.currentPlayer);
                    const receivedAmount = gameState.donationFund;
                    
                    if (receivedAmount > 0) {
                        player.score += receivedAmount;
                        gameState.donationFund = 0;
                        updateDonationDisplay();
                        updateUI();
                    }
                }
            },
            {
                name: "🎁 신비한 상자",
                description: "상자를 열어보세요! 500점, 0점, 또는 -200점 중 하나를 획득합니다!",
                effect: () => {
                    // 신비한 상자 이벤트는 팝업에서 직접 처리되므로 여기서는 아무것도 하지 않음
                }
            }
        ];

        // 플레이어 카드 동적 생성 함수
        function createPlayerCards() {
            const playersSection = document.getElementById('players-section');
            if (!playersSection) return;
            
            // 기존 플레이어 카드 제거
            playersSection.innerHTML = '';
            
            // 현재 게임 상태의 플레이어 수만큼 카드 생성
            const gameState = gameStateManager.state;
            gameState.players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = 'player-info';
                playerCard.id = `player${player.id}-info`;
                
                playerCard.innerHTML = `
                    <div class="player-avatar" style="background: ${player.color};">${player.id}</div>
                    <div class="player-details">
                        <div class="player-name">${player.name}</div>
                        <div class="player-score">점수: <span id="score${player.id}">${player.score}</span></div>
                        <div class="player-lands">땅 소유: <span id="lands${player.id}">0</span>개</div>
                    </div>
                `;
                
                playersSection.appendChild(playerCard);
            });
        }

        // 게임 활성화
        function initGame() {
            // 뷰포트 높이 설정
            setViewportHeight();
            
            // 슈퍼 점프 관련 상태 활성화
            gameState.superJumpMode = false;
            gameState.superJumpFailed = false;
            gameState.players.forEach(player => {
                player.isWaitJump = false;
                player.hasSuperJumpChance = false;
                player.isOnIsland = false;
                player.islandTurnCount = 0;
                player.islandQuizStreak = 0;
            });
            
            // 무인도 모드 활성화
            gameState.modes.island.active = false;
            gameState.modes.island.escapePhase = null;
            gameState.modes.island.justEscaped = false;
            
            // 무인도 표시기 숨기기 (제거됨)
            // islandManager.hideIslandIndicator();
            
            
            // 기본 팔레트(오션 톤) 적용
            const defaultPalette = palettesData.palettes[0]; // 오션 톤
            
            // CSS 변수 업데이트
            document.documentElement.style.setProperty('--color-start', defaultPalette.colors.golden);
            document.documentElement.style.setProperty('--color-quiz', defaultPalette.colors.quiz);
            document.documentElement.style.setProperty('--color-golden', defaultPalette.colors.golden);
            document.documentElement.style.setProperty('--color-special', defaultPalette.colors.special);
            document.documentElement.style.setProperty('--color-corner', defaultPalette.colors.corner);
            document.documentElement.style.setProperty('--color-center', defaultPalette.colors.center);
            document.documentElement.style.setProperty('--color-background', defaultPalette.colors.background);
            document.documentElement.style.setProperty('--color-normal', defaultPalette.colors.normal);
            
            // 특별 칸 고유 색상 유지
            document.documentElement.style.setProperty('--color-superjump', '#00BFFF');
            document.documentElement.style.setProperty('--color-island', '#616161');
            document.documentElement.style.setProperty('--color-donation', '#FF69B4');
            
            // 팔레트별 플레이어 색상 CSS 변수 설정
            defaultPalette.playerColors.forEach((color, index) => {
                document.documentElement.style.setProperty(`--player-color-${index + 1}`, color);
            });
            
            // 플레이어 색상 업데이트
            defaultPalette.playerColors.forEach((color, index) => {
                if (gameState.players[index]) {
                    gameState.players[index].color = color;
                }
            });
            
            // 플레이어 카드 생성
            createPlayerCards();
            
            // 보드 생성
            createBoard();
            
            // 초기 주사위 값 설정 (5로 시작하여 주사위가 사라지지 않게 함)
            gameState.diceValue = 5;
            updateDiceIcon(5);
            updateUI();
            
            // 주사위 버튼 초기 상태 설정
            diceButtonManager.updateFromGameState();
            
            // 게임 상태 모니터링 시작
            gameStateMonitor.startMonitoring();
            
            // 소유권 활성화 및 띠지 색상 설정
            resetSpaceOwners();
            // 보드 생성 후 띠지 색상 활성화
            setTimeout(() => {
                updateRibbonColors();
                updateLandOwnershipDisplay(); // 땅 소유 표시 활성화
                updateDonationDisplay(); // 기부금 모금 표시 활성화
                updateStarDisplay(); // 별 표시 활성화
                addLandClickHandlers(); // 땅 클릭 이벤트 추가
            }, 100);
        }

        // 모노폴리 스타일 보드 생성

        function createBoard() {
            const board = document.getElementById('gameBoard');
            board.innerHTML = '';

            // 7x7 그리드 생성
            for (let row = 0; row < 7; row++) {
                for (let col = 0; col < 7; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'board-space';
                    
                    // 모서리 칸들
                    if ((row === 0 && col === 0) || (row === 0 && col === 6) || 
                        (row === 6 && col === 0) || (row === 6 && col === 6)) {
                        cell.classList.add('corner-space');
                        
                        if (row === 0 && col === 0) {
                            // 무인도 - special 타입
                            const space = boardSpaces.find(s => s.id === 12);
                            if (space) {
                                cell.className = `board-space corner-space ${space.color}`;
                            }
                            cell.innerHTML = '<div class="space-name">   무  인  도   </div>';
                            cell.dataset.spaceId = 12;
                            cell.onclick = () => handleSpaceClick(12);
                        } else if (row === 0 && col === 6) {
                            // 기부금 모금 - special 타입
                            const space = boardSpaces.find(s => s.id === 18);
                            if (space) {
                                cell.className = `board-space corner-space ${space.color}`;
                            }
                            cell.innerHTML = '<div class="space-name">기부금 모금<br><span class="donation-amount" id="donationAmount">0점</span></div>';
                            cell.dataset.spaceId = 18;
                            cell.onclick = () => handleSpaceClick(18);
                        } else if (row === 6 && col === 0) {
                            // 슈퍼 점프 - special 타입
                            const space = boardSpaces.find(s => s.id === 6);
                            if (space) {
                                cell.className = `board-space corner-space ${space.color}`;
                            }
                            cell.innerHTML = '<div class="space-name">슈퍼 점프</div>';
                            cell.dataset.spaceId = 6;
                            cell.onclick = () => handleSpaceClick(6);
                        } else if (row === 6 && col === 6) {
                            // 시작 - start 타입
                            const space = boardSpaces.find(s => s.id === 0);
                            if (space) {
                                cell.className = `board-space corner-space ${space.color}`;
                            }
                            cell.innerHTML = '<div class="space-name">START</div>';
                            cell.dataset.spaceId = 0;
                            cell.onclick = () => handleSpaceClick(0);
                        }
                        
                        // 중앙 패널과 겹치는 모서리 칸들은 호버 효과 비활성화
                        if ((row >= 2 && row <= 4) && (col >= 2 && col <= 4)) {
                            cell.className += ' center-background';
                        }
                    }
                    // 내부 5x5 그리드 (빈칸들)
                    else if (row >= 1 && row <= 5 && col >= 1 && col <= 5) {
                        // 빈칸들 (퀴즈, 마블 글씨 제거)
                        cell.style.background = 'var(--color-center)';
                        cell.style.border = 'none';
                        cell.style.boxShadow = 'none';
                        cell.style.outline = 'none';
                        cell.innerHTML = '';
                        cell.className = 'board-space center-background'; // 호버 효과 비활성화
                        // 클릭 이벤트 제거 (onclick 설정하지 않음)
                    }
                    // 경계 칸들 (외곽 경로)
                    else {
                        const spaceIndex = getSpaceIndex(row, col);
                        if (spaceIndex !== -1) {
                            const space = boardSpaces.find(s => s.id === spaceIndex);
                            if (space) {
                                cell.className = `board-space ${space.color}`;
                                cell.dataset.space = spaceIndex; // 띠지 시스템을 위한 data-space 속성 추가
                                // 황금 열쇠 칸인 경우 특별 처리
                                if (space.type === 'golden') {
                                    cell.innerHTML = `
                                        <div class="space-name">황금 열쇠</div>
                                        <div class="space-content">🔑</div>
                                    `;
                                } else {
                                cell.innerHTML = `
                                    <div class="space-content-wrapper">
                                        <div class="space-name">${space.name}</div>
                                    </div>
                                `;
                                }
                                
                                // 중앙 패널과 겹치는 영역의 칸들은 클릭 이벤트 제거
                                if ((row >= 2 && row <= 4) && (col >= 2 && col <= 4)) {
                                    cell.className += ' center-background';
                                    // 클릭 이벤트 제거 (onclick 설정하지 않음)
                                } else {
                                    cell.dataset.spaceId = space.id;
                                    cell.onclick = () => handleSpaceClick(space.id);
                                }
                            }
                        } else {
                            cell.style.background = 'transparent';
                            cell.style.border = 'none';
                            // 중앙 패널과 겹치는 영역의 빈 칸들도 호버 효과 비활성화
                            if ((row >= 2 && row <= 4) && (col >= 2 && col <= 4)) {
                                cell.className = 'board-space center-background';
                            }
                        }
                    }
                    
                    board.appendChild(cell);
                }
            }

            // 플레이어 말들 배치
            updatePlayerPieces();
        }

        // 그리드 위치를 보드 칸 인덱스로 변환 (스크린샷 기준)
        function getSpaceIndex(row, col) {
            // 상단 변 (13-17) - 왼쪽에서 오른쪽으로
            if (row === 0 && col >= 1 && col <= 5) {
                return 12 + col; // 13, 14, 15, 16, 17
            }
            // 우측 변 (19-23) - 위에서 아래로
            else if (col === 6 && row >= 1 && row <= 5) {
                return 18 + row; // 19, 20, 21, 22, 23
            }
            // 하단 변 (1-5) - 오른쪽에서 왼쪽으로
            else if (row === 6 && col >= 1 && col <= 5) {
                return 6 - col; // 5, 4, 3, 2, 1
            }
            // 좌측 변 (7-11) - 아래에서 위로
            else if (col === 0 && row >= 1 && row <= 5) {
                return 12 - row; // 11, 10, 9, 8, 7
            }
            return -1;
        }

        // 플레이어 말들 업데이트
        function updatePlayerPieces() {
            // 기존 말들 제거
            document.querySelectorAll('.player-piece').forEach(piece => piece.remove());

            // 각 칸별로 플레이어들을 그룹화
            const playersByPosition = {};
            gameState.players.forEach(player => {
                if (player.position >= 0 && player.position < boardSpaces.length) {
                    if (!playersByPosition[player.position]) {
                        playersByPosition[player.position] = [];
                    }
                    playersByPosition[player.position].push(player);
                }
            });

            // 각 칸에 플레이어 말들 배치
            Object.keys(playersByPosition).forEach(position => {
                const players = playersByPosition[position];
                const gridPos = getGridPosition(parseInt(position));
                
                if (gridPos) {
                    const cellIndex = gridPos.row * 7 + gridPos.col;
                        const spaceElement = document.querySelectorAll('.board-space')[cellIndex];
                    
                        if (spaceElement) {
                        players.forEach((player, index) => {
                            const piece = document.createElement('div');
                            piece.className = 'player-piece';
                            piece.style.background = player.color;
                            piece.textContent = player.id;
                            
                            // 상단 우측 정렬 배치 계산
                            const totalPlayers = players.length;
                            let rightPosition;
                            
                            if (totalPlayers === 1) {
                                rightPosition = '5%';
                            } else if (totalPlayers === 2) {
                                rightPosition = index === 0 ? '20%' : '5%';
                            } else if (totalPlayers === 3) {
                                rightPosition = index === 0 ? '35%' : index === 1 ? '20%' : '5%';
                            } else { // 4명
                                rightPosition = index === 0 ? '50%' : index === 1 ? '35%' : index === 2 ? '20%' : '5%';
                            }
                            
                            piece.style.right = rightPosition;
                            piece.style.left = 'auto'; // left 속성 활성화
                            spaceElement.appendChild(piece);
                        });
                    }
                }
            });
        }

        // 보드 칸 인덱스를 그리드 위치로 변환 (스크린샷 기준)
        function getGridPosition(spaceIndex) {
            if (spaceIndex === 0) return { row: 6, col: 6 }; // 시작 (우하단)
            if (spaceIndex === 6) return { row: 6, col: 0 }; // 슈퍼 점프 (좌하단)
            if (spaceIndex === 12) return { row: 0, col: 0 }; // 무인도 (좌상단)
            if (spaceIndex === 18) return { row: 0, col: 6 }; // 기부금 모금 (우상단)
            
            // 상단 변 (13-17) - 왼쪽에서 오른쪽으로
            if (spaceIndex >= 13 && spaceIndex <= 17) {
                return { row: 0, col: spaceIndex - 12 };
            }
            // 우측 변 (19-23) - 위에서 아래로
            else if (spaceIndex >= 19 && spaceIndex <= 23) {
                return { row: spaceIndex - 18, col: 6 };
            }
            // 하단 변 (1-5) - 오른쪽에서 왼쪽으로
            else if (spaceIndex >= 1 && spaceIndex <= 5) {
                return { row: 6, col: 6 - spaceIndex };
            }
            // 좌측 변 (7-11) - 아래에서 위로
            else if (spaceIndex >= 7 && spaceIndex <= 11) {
                return { row: 12 - spaceIndex, col: 0 };
            }
            
            return null;
        }

        // 새로운 SVG 기반 주사위 시스템
        let isRolling = false;
        
        // 퀴즈 타이머 변수
        let quizTimer = null;

        // 소유권 시스템
        let spaceOwners = {
            1: null, 2: null, 4: null, 5: null,      // 1번 지역
            7: null, 8: null, 10: null, 11: null,    // 2번 지역
            13: null, 14: null, 16: null, 17: null,  // 3번 지역
            19: null, 20: null, 22: null, 23: null   // 4번 지역
        };

        // 별 개수 시스템 (땅별 별 개수 저장)
        let spaceStars = {
            1: 0, 2: 0, 4: 0, 5: 0,      // 1번 지역
            7: 0, 8: 0, 10: 0, 11: 0,    // 2번 지역
            13: 0, 14: 0, 16: 0, 17: 0,  // 3번 지역
            19: 0, 20: 0, 22: 0, 23: 0   // 4번 지역
        };

        // 통행세 기준 (1성 기준)
        const tollRates = {
            1: 100, 2: 100, 4: 100, 5: 100,      // 1번 지역
            7: 200, 8: 200, 10: 200, 11: 200,    // 2번 지역
            13: 300, 14: 300, 16: 300, 17: 300,  // 3번 지역
            19: 300, 20: 300, 22: 300, 23: 300   // 4번 지역
        };


        // 띠지 색상 업데이트 함수 (동적 플레이어 색상 사용)
        function updateRibbonColors() {
            const spaces = document.querySelectorAll('.board-space[data-space]');
            if (spaces.length === 0) {
                return;
            }
            
            spaces.forEach(space => {
                const spaceNumber = parseInt(space.dataset.space);
                const ownerIndex = spaceOwners[spaceNumber];
                
                if (ownerIndex !== null && ownerIndex !== undefined) {
                    // 현재 게임 상태의 플레이어 색상 사용 (팔레트 변경 시 동적으로 업데이트됨)
                    const ownerColor = gameState.players[ownerIndex] ? gameState.players[ownerIndex].color : '#1976D2';
                    space.style.setProperty('--ribbon-color', ownerColor);
                    
                } else {
                    // 소유자가 없으면 투명하게
                    space.style.setProperty('--ribbon-color', 'transparent');
                }
            });
        }

        // 소유권 활성화 함수
        function resetSpaceOwners() {
            spaceOwners = {
                1: null, 2: null, 4: null, 5: null,      // 1번 지역
                7: null, 8: null, 10: null, 11: null,    // 2번 지역
                13: null, 14: null, 16: null, 17: null,  // 3번 지역
                19: null, 20: null, 22: null, 23: null   // 4번 지역
            };
            
            // 별 개수도 초기화
            spaceStars = {
                1: 0, 2: 0, 4: 0, 5: 0,      // 1번 지역
                7: 0, 8: 0, 10: 0, 11: 0,    // 2번 지역
                13: 0, 14: 0, 16: 0, 17: 0,  // 3번 지역
                19: 0, 20: 0, 22: 0, 23: 0   // 4번 지역
            };
        }

        // 칸 구매 함수 (문제를 맞췄을 때 호출)
        function buySpace(playerIndex, spaceNumber) {
            if (spaceOwners[spaceNumber] === null) {
                spaceOwners[spaceNumber] = playerIndex;
                spaceStars[spaceNumber] = 1; // 첫 구매 시 1성
                updateRibbonColors();
                updateLandOwnershipDisplay(); // 땅 소유 표시 업데이트
                updateStarDisplay(); // 별 표시 업데이트
            }
        }

        // 별 개수 증가 함수
        function increaseStar(spaceNumber) {
            if (spaceStars[spaceNumber] < 5) {
                spaceStars[spaceNumber]++;
                updateStarDisplay();
            }
        }

        // 별 개수 감소 함수
        function decreaseStar(spaceNumber) {
            if (spaceStars[spaceNumber] > 0) {
                spaceStars[spaceNumber]--;
                updateStarDisplay();
                
                // 별이 0개가 되면 소유권도 제거
                if (spaceStars[spaceNumber] === 0) {
                    spaceOwners[spaceNumber] = null;
                    updateRibbonColors();
                    updateLandOwnershipDisplay();
                }
            }
        }

        // 통행세 계산 함수
        function calculateToll(spaceNumber) {
            const baseRate = tollRates[spaceNumber] || 0;
            const starCount = spaceStars[spaceNumber] || 0;
            return baseRate * starCount;
        }

        // 별 표시 업데이트 함수
        function updateStarDisplay() {
            const spaces = document.querySelectorAll('.board-space[data-space]');
            spaces.forEach(space => {
                const spaceNumber = parseInt(space.dataset.space);
                const starCount = spaceStars[spaceNumber] || 0;
                
                // 기존 별 표시 제거
                const existingStars = space.querySelector('.star-display');
                if (existingStars) {
                    existingStars.remove();
                }
                
                // 별이 있으면 숫자와 함께 표시
                if (starCount > 0) {
                    const wrapper = space.querySelector('.space-content-wrapper');
                    if (wrapper) {
                        const starDisplay = document.createElement('div');
                        starDisplay.className = 'star-display';
                        starDisplay.innerHTML = '⭐'.repeat(starCount);
                        wrapper.appendChild(starDisplay);
                    }
                }
            });
        }

        // 땅 퀴즈 처리 함수
        function handleLandQuiz(position) {
            const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
            const ownerIndex = spaceOwners[position];
            const starCount = spaceStars[position] || 0;
            const space = boardSpaces.find(s => s.id === position);
            const landName = space ? space.name : `${position}번`;
            
            // 무소유 땅인 경우
            if (ownerIndex === null) {
                showMessage(`${landName} 땅에 도착했습니다! 퀴즈를 맞춰 땅을 소유하세요!`);
                setTimeout(() => {
                    showQuiz();
                }, 1500);
                return;
            }
            
            // 본인 땅인 경우
            if (ownerIndex === currentPlayer.id - 1) {
                if (starCount >= 5) {
                    showMessage(`${landName} 땅에 도착했습니다! 퀴즈를 맞춰 1,000점을 획득하세요!`);
                } else {
                    showMessage(`${landName} 땅에 도착했습니다! 퀴즈를 맞춰 별을 증가시키세요!`);
                }
                setTimeout(() => {
                    showQuiz();
                }, 1500);
                return;
            }
            
            // 다른 사람 땅인 경우 - 통행세 지불
            const toll = calculateToll(position);
            const owner = gameState.players[ownerIndex];
            
            if (toll > 0) {
                currentPlayer.score -= toll;
                owner.score += toll;
                
                showMessage(`${owner.name}의 ${landName} 땅에 도착! 통행세 ${formatNumber(toll)}점 지불!`);
                
                setTimeout(() => {
                    showMessage('통행세 지불 후 퀴즈를 맞춰 별을 감소시킬 수 있습니다!');
                    setTimeout(() => {
                        showQuiz();
                    }, 1500);
                }, 1500);
            } else {
                showMessage(`${owner.name}의 ${landName} 땅에 도착했습니다!`);
                setTimeout(() => {
                    showQuiz();
                }, 1500);
            }
        }

        // 땅 퀴즈 답변 처리 함수
        function handleLandQuizAnswer(selected, correct, points, spaceNumber) {
            const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
            const ownerIndex = spaceOwners[spaceNumber];
            const starCount = spaceStars[spaceNumber] || 0;
            const space = boardSpaces.find(s => s.id === spaceNumber);
            const landName = space ? space.name : `${spaceNumber}번`;
            
            // 시간 초과 처리
            if (selected === -1) {
                showMessage('시간 초과! 점수 없음');
                closeQuiz();
                return;
            }
            
            // 정답인 경우
            if (selected === correct) {
                // 기본 점수 부여 (500점 또는 5성 땅은 1000점)
                const bonusPoints = starCount >= 5 ? 1000 : 500;
                currentPlayer.score += bonusPoints;
                
                // 무소유 땅인 경우 - 땅 구매
                if (ownerIndex === null) {
                    buySpace(currentPlayer.id - 1, spaceNumber);
                    showMessage(`정답! +${formatNumber(bonusPoints)}점 획득! ${landName} 땅을 소유했습니다!`);
                }
                // 본인 땅인 경우 - 별 증가
                else if (ownerIndex === currentPlayer.id - 1) {
                    if (starCount < 5) {
                        increaseStar(spaceNumber);
                        showMessage(`정답! +${formatNumber(bonusPoints)}점 획득! ${landName} 땅의 별이 증가했습니다!`);
                    } else {
                        showMessage(`정답! +${formatNumber(bonusPoints)}점 획득!`);
                    }
                }
                // 다른 사람 땅인 경우 - 별 감소
                else {
                    if (starCount > 0) {
                        decreaseStar(spaceNumber);
                        showMessage(`정답! +${formatNumber(bonusPoints)}점 획득! ${landName} 땅의 별이 감소했습니다!`);
                    } else {
                        showMessage(`정답! +${formatNumber(bonusPoints)}점 획득!`);
                    }
                }
            } else {
                // 오답인 경우
                showMessage('틀렸습니다! 점수 없음');
            }
            
            closeQuiz();
            updateUI();
        }

        // 땅 소유 개수 계산 함수
        function getPlayerLandCount(playerIndex) {
            let count = 0;
            for (const spaceNumber in spaceOwners) {
                if (spaceOwners[spaceNumber] === playerIndex) {
                    count++;
                }
            }
            return count;
        }

        // 땅 소유 표시 업데이트 함수
        function updateLandOwnershipDisplay() {
            for (let i = 0; i < 4; i++) {
                const landCount = getPlayerLandCount(i);
                const landElement = document.getElementById(`lands${i + 1}`);
                if (landElement) {
                    landElement.textContent = landCount;
                }
            }
        }

        // 땅 클릭 이벤트 핸들러 추가
        function addLandClickHandlers() {
            const spaces = document.querySelectorAll('.board-space[data-space]');
            spaces.forEach(space => {
                const spaceNumber = parseInt(space.dataset.space);
                // 땅 칸만 클릭 이벤트 추가 (특별 칸 제외)
                if (spaceOwners[spaceNumber] !== undefined) {
                    space.style.cursor = 'pointer';
                    space.addEventListener('click', () => {
                        showLandInfoPopup(spaceNumber);
                    });
                }
            });
        }

        // 땅 정보 팝업 표시
        function showLandInfoPopup(spaceNumber) {
            const ownerIndex = spaceOwners[spaceNumber];
            const starCount = spaceStars[spaceNumber] || 0;
            const toll = calculateToll(spaceNumber);
            const space = boardSpaces.find(s => s.id === spaceNumber);
            const landName = space ? space.name : `${spaceNumber}번`;
            
            let content = `<h3>${landName} 땅 정보</h3>`;
            
            if (ownerIndex === null) {
                content += `<p>소유자: 없음</p>`;
                content += `<p>별 개수: 0개</p>`;
                content += `<p>통행세: 없음</p>`;
            } else {
                const owner = gameState.players[ownerIndex];
                content += `<p>소유자: ${owner.name}</p>`;
                content += `<p>별 개수: ${starCount}개</p>`;
                content += `<p>통행세: ${formatNumber(toll)}점</p>`;
            }
            
            // 팝업 생성
            const popup = document.createElement('div');
            popup.className = 'popup land-info-popup';
            popup.innerHTML = `
                <div class="popup-content">
                    ${content}
                    <button onclick="this.parentElement.parentElement.remove()">확인</button>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // 팝업 표시
            setTimeout(() => {
                popup.classList.add('show');
            }, 10);
        }

        // 주사위 아이콘 SVG 패턴들 (흰색 배경)
        const dicePatterns = {
            1: `<rect width="18" height="18" x="3" y="3" rx="2" ry="2" fill="white" stroke="#374151" stroke-width="1"/>
                <circle cx="12" cy="12" r="1" fill="#374151"/>`,
            
            2: `<rect width="18" height="18" x="3" y="3" rx="2" ry="2" fill="white" stroke="#374151" stroke-width="1"/>
                <circle cx="8" cy="8" r="1" fill="#374151"/>
                <circle cx="16" cy="16" r="1" fill="#374151"/>`,
            
            3: `<rect width="18" height="18" x="3" y="3" rx="2" ry="2" fill="white" stroke="#374151" stroke-width="1"/>
                <circle cx="8" cy="8" r="1" fill="#374151"/>
                <circle cx="12" cy="12" r="1" fill="#374151"/>
                <circle cx="16" cy="16" r="1" fill="#374151"/>`,
            
            4: `<rect width="18" height="18" x="3" y="3" rx="2" ry="2" fill="white" stroke="#374151" stroke-width="1"/>
                <circle cx="8" cy="8" r="1" fill="#374151"/>
                <circle cx="8" cy="16" r="1" fill="#374151"/>
                <circle cx="16" cy="8" r="1" fill="#374151"/>
                <circle cx="16" cy="16" r="1" fill="#374151"/>`,
            
            5: `<rect width="18" height="18" x="3" y="3" rx="2" ry="2" fill="white" stroke="#374151" stroke-width="1"/>
                <circle cx="8" cy="8" r="1" fill="#374151"/>
                <circle cx="8" cy="16" r="1" fill="#374151"/>
                <circle cx="12" cy="12" r="1" fill="#374151"/>
                <circle cx="16" cy="8" r="1" fill="#374151"/>
                <circle cx="16" cy="16" r="1" fill="#374151"/>`,
            
            6: `<rect width="18" height="18" x="3" y="3" rx="2" ry="2" fill="white" stroke="#374151" stroke-width="1"/>
                <circle cx="8" cy="8" r="1" fill="#374151"/>
                <circle cx="8" cy="12" r="1" fill="#374151"/>
                <circle cx="8" cy="16" r="1" fill="#374151"/>
                <circle cx="16" cy="8" r="1" fill="#374151"/>
                <circle cx="16" cy="12" r="1" fill="#374151"/>
                <circle cx="16" cy="16" r="1" fill="#374151"/>`
        };

        // 주사위 아이콘 업데이트 함수
        function updateDiceIcon(value) {
            const diceIcon = document.getElementById('diceIcon');
            diceIcon.innerHTML = dicePatterns[value];
        }

        // 주사위 굴리기
        function rollDice() {
            if (gameState.gamePhase !== 'waiting' && gameState.gamePhase !== 'rolling') {
                return;
            }
            if (isRolling) {
                return;
            }
            if (gameState.superJumpMode) return; // 슈퍼 점프 모드일 때는 주사위 비활성화
            
            // 무인도에 갇힌 플레이어는 3턴째부터만 주사위를 굴릴 수 있음
            const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
            if (currentPlayer && currentPlayer.isOnIsland && currentPlayer.islandTurnCount < 3) {
                return;
            }

            // 게임 액션 기록
            gameStateMonitor.recordAction();
            

            const diceIcon = document.getElementById('diceIcon');
            const rollBtn = document.getElementById('rollDiceBtn');
            
            isRolling = true;
            gameState.gamePhase = 'rolling';
            
            // 애니메이션 시작
            diceIcon.classList.add('spinning');
            
            // 새로운 주사위 버튼 관리 시스템 사용
            diceButtonManager.setState('disabled');
            // 버튼 텍스트는 그대로 유지 (크기 변화 방지)

            // 랜덤 주사위 값 생성
            const finalValue = Math.floor(Math.random() * 6) + 1;
            
            // 애니메이션 효과를 위한 여러 번 값 변경
            let rolls = 0;
            const rollInterval = setInterval(() => {
                const tempValue = Math.floor(Math.random() * 6) + 1;
                updateDiceIcon(tempValue);
                rolls++;
                
                // 10번 굴린 후 최종 값으로 설정
                if (rolls > 10) {
                    clearInterval(rollInterval);
                    gameState.diceValue = finalValue;
                    gameState.gamePhase = 'moving';
                    updateDiceIcon(finalValue);
                    
                    
                    diceIcon.classList.remove('spinning');
                rollBtn.disabled = false;
                    isRolling = false;

                // 플레이어 이동
                setTimeout(() => {
                        movePlayer(finalValue);
                    }, 300);
                }
            }, 100); // 100ms마다 주사위 값 변경
        }

        // 플레이어 이동
        function movePlayer(steps) {
            const player = gameState.players.find(p => p.id === gameState.currentPlayer);
            const startPosition = player.position;
            let currentStep = 0;
            
            // 단계별 이동 애니메이션
            const moveStep = () => {
                if (currentStep < steps) {
                    currentStep++;
                    let tempPosition = startPosition + currentStep;
            
            // 보드를 한 바퀴 돌면 시작점 통과 보너스 (24칸 보드)
                    if (tempPosition >= 24) {
                        tempPosition = tempPosition - 24;
                        if (currentStep === steps) { // 마지막 단계에서만 보너스 적용
                player.score += 200;
                showMessage('시작점 통과 보너스! +200점');
                        }
            }
            
                    // 임시 위치로 플레이어 이동 (애니메이션용)
                    player.position = tempPosition;
            updatePlayerPieces();
                    
                    // 이동 애니메이션 효과
                    const playerPiece = document.querySelector(`.player-piece[style*="background: ${player.color}"]`);
                    if (playerPiece) {
                        playerPiece.classList.add('moving');
                        setTimeout(() => {
                            playerPiece.classList.remove('moving');
                        }, 600);
                    }
                    
                    // 다음 단계로 이동 (0.4초 간격)
                    setTimeout(moveStep, 400);
                } else {
                    // 최종 위치 설정 및 착지 애니메이션
                    let finalPosition = startPosition + steps;
                    if (finalPosition >= 24) {
                        finalPosition = finalPosition - 24;
                    }
                    player.position = finalPosition;
                    
                    // 착지 애니메이션
                    const playerPiece = document.querySelector(`.player-piece[style*="background: ${player.color}"]`);
                    if (playerPiece) {
                        playerPiece.classList.add('landing');
                        setTimeout(() => {
                            playerPiece.classList.remove('landing');
                        }, 400);
                    }
                    
            updateUI();

            // 도착한 칸의 액션 처리
            setTimeout(() => {
                        handleSpaceAction(finalPosition);
            }, 500);
                }
            };
            
            // 첫 번째 단계 시작
            moveStep();
        }

        // 칸 액션 처리
        function handleSpaceAction(position) {
            const space = boardSpaces.find(s => s.id === position);
            if (!space) return;


            let shouldAutoEndTurn = true; // 자동 턴 전환 여부

            switch (space.type) {
                case 'start':
                    // 시작점은 이미 통과 보너스로 처리됨
                    break;
                case 'quiz':
                    handleLandQuiz(position);
                    return;
                case 'golden':
                    showGoldenKeyEvent();
                    return;
                case 'corner':
                    // corner 타입 칸들의 이름에 따라 다른 액션 수행
                    if (space.name === '무인도') {
                        const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
                        islandManager.putPlayerOnIsland(currentPlayer.id);
                        shouldAutoEndTurn = false; // 무인도 팝업은 사용자 확인 후 턴 전환
                    } else if (space.name === '슈퍼 점프') {
                        const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
                        currentPlayer.hasSuperJumpChance = true; // 슈퍼 점프 기회 플래그 설정
                        showSuperJumpPopup(currentPlayer.name);
                        shouldAutoEndTurn = false; // 슈퍼 점프 팝업은 사용자 확인 후 턴 전환
                    } else if (space.name === '기부금 모금') {
                        const donationPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
                        
                        // 기부금 300점 차감 (최소 0점 유지)
                        const donationAmount = Math.min(300, donationPlayer.score);
                        donationPlayer.score = Math.max(0, donationPlayer.score - donationAmount);
                        
                        // 기부금 모금에 추가
                        gameState.donationFund += donationAmount;
                        updateDonationDisplay();
                        
                        // 기부금 전용 팝업 표시
                        showDonationPopup(donationAmount, gameState.donationFund);
                        shouldAutoEndTurn = false; // 기부금 팝업은 사용자 확인 후 턴 전환
                    } else {
                        // 기타 모서리 칸은 황금열쇠 이벤트로 처리
                        showGoldenKeyEvent();
                    }
                    break;
                case 'special':
                    // special 타입 칸들은 황금열쇠 이벤트로 처리
                    showGoldenKeyEvent();
                    return;
                case 'finish':
                    const finishPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
                    finishPlayer.score += 500;
                    showMessage('도착점 도달! +500점');
                    break;
            }

            // 자동으로 턴 전환 (턴 종료 버튼 제거)
            if (shouldAutoEndTurn && !gameState.modes.island.justEscaped) {
                setTimeout(() => {
                    endTurn();
                }, 2000); // 2초 후 자동 턴 전환
            } else if (gameState.modes.island.justEscaped) {
                // 무인도에서 방금 탈출한 플레이어의 경우 이벤트 처리 완료 후 턴 전환
                // 플래그는 턴 전환 알림 팝업을 표시한 후 활성화
                setTimeout(() => {
                    try {
                        endTurn();
                        updateUI();
                    } catch (error) {
                        console.error('endTurn 에러:', error);
                        // 에러 발생 시 기본 턴 전환 처리
                        const currentPlayerIndex = gameState.players.findIndex(p => p.id === gameState.currentPlayer);
                        if (currentPlayerIndex === -1) {
                            console.error('endTurn 에러 처리 중 현재 플레이어를 찾을 수 없습니다:', gameState.currentPlayer);
                            return;
                        }
                        const nextPlayerIndex = (currentPlayerIndex + 1) % gameState.players.length;
                        gameState.currentPlayer = gameState.players[nextPlayerIndex].id;
                        gameState.gamePhase = 'waiting';
                        updateUI();
                    }
                }, 2000); // 2초 후 턴 전환
            }
            updateUI();
        }

        // 퀴즈 표시
        function showQuiz() {
            
            try {
            const question = quizQuestions[Math.floor(Math.random() * quizQuestions.length)];
            const popup = document.getElementById('quizPopup');
            const questionEl = document.getElementById('quizQuestion');
            const optionsEl = document.getElementById('quizOptions');
            const titleEl = document.querySelector('#quizPopup .popup-title');

                if (!popup || !questionEl || !optionsEl) {
                    return;
                }

            // 현재 플레이어 정보로 제목 업데이트
            const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
            const playerName = currentPlayer ? currentPlayer.name : `플레이어 ${gameState.currentPlayer}`;
            
            if (titleEl) {
                if (gameState.superJumpMode) {
                    titleEl.textContent = `🚀 ${playerName} - 슈퍼 점프 퀴즈!`;
                    popup.classList.add('super-jump-mode');
                } else if (currentPlayer && currentPlayer.isOnIsland) {
                    // 무인도 퀴즈인 경우
                    const requiredStreak = currentPlayer.islandTurnCount === 1 ? 2 : 1;
                    titleEl.textContent = `🏝️ ${playerName} - 무인도 탈출 퀴즈!`;
                    popup.classList.add('island-mode');
                } else {
                    titleEl.textContent = `🧠 ${playerName} - 퀴즈 도전!`;
                    popup.classList.remove('super-jump-mode');
                    popup.classList.remove('island-mode');
                }
                }

            questionEl.textContent = question.question;
            optionsEl.innerHTML = '';

            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'popup-button';
                button.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
                button.onclick = () => answerQuiz(index, question.correct, question.points);
                optionsEl.appendChild(button);
            });

            // 무인도 퀴즈인 경우 진행 상황 표시
            if (currentPlayer && currentPlayer.isOnIsland) {
                const requiredStreak = currentPlayer.islandTurnCount === 1 ? 2 : 1;
                const progressEl = document.createElement('div');
                progressEl.style.cssText = 'margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center;';
                progressEl.innerHTML = `
                    <p style="margin: 5px 0; font-size: 14px;">문제를 ${requiredStreak}개 연속으로 맞춰 탈출하세요!</p>
                    <p style="margin: 5px 0; font-size: 16px; font-weight: bold;">현재 연속 정답: ${currentPlayer.islandQuizStreak}/${requiredStreak}</p>
                `;
                optionsEl.appendChild(progressEl);
            }

            popup.classList.add('show');
            startQuizTimer();
            
            // 무인도 퀴즈인 경우 현재 플레이어 하이라이트 설정
            if (currentPlayer && currentPlayer.isOnIsland) {
                updatePlayerHighlightForIsland(currentPlayer);
            }
            } catch (error) {
                showMessage('퀴즈를 불러올 수 없습니다.');
            }
        }

        // 퀴즈 타이머
        function startQuizTimer() {
            // 기존 타이머가 있다면 정리
            if (quizTimer) {
                clearInterval(quizTimer);
                quizTimer = null;
            }
            
            let timeLeft = 30;
            const timerEl = document.getElementById('timeLeft');
            
            // 초기 시간 표시
            if (timerEl) {
                timerEl.textContent = timeLeft;
            }
            
            quizTimer = setInterval(() => {
                timeLeft--;
                if (timerEl) {
                timerEl.textContent = timeLeft;
                }
                
                if (timeLeft <= 0) {
                    clearInterval(quizTimer);
                    quizTimer = null;
                    answerQuiz(-1, 0, 0); // 시간 초과
                }
            }, 1000);
        }

        // 퀴즈 답변
        function answerQuiz(selected, correct, points) {
            const player = gameState.players.find(p => p.id === gameState.currentPlayer);
            const currentSpace = player.position;
            
            // 무인도 퀴즈인지 확인
            if (player.isOnIsland) {
                const isCorrect = selected === correct;
                islandManager.handleIslandQuizAnswer(player.id, isCorrect);
                return;
            }
            
            // 슈퍼 점프 모드인지 확인
            if (gameState.superJumpMode) {
                if (selected === -1) {
                    gameState.superJumpMode = false;
                    player.isWaitJump = false;
                    gameState.gamePhase = 'waiting'; // 퀴즈 실패 후 waiting 상태
                    gameState.superJumpFailed = true; // 슈퍼 점프 실패 플래그 설정
                    
                    // 슈퍼 점프 시간 초과 시 턴 전환 알림 팝업 표시
                    showTurnNotification('도전 실패! 주사위를 굴려 이동하세요.');
                } else if (selected === correct) {
                    showMessage('정답! 슈퍼 점프하고 싶은 지역을 터치하세요.');
                    enableSuperJumpMode();
                } else {
                    gameState.superJumpMode = false;
                    player.isWaitJump = false;
                    gameState.gamePhase = 'waiting'; // 퀴즈 실패 후 waiting 상태
                    gameState.superJumpFailed = true; // 슈퍼 점프 실패 플래그 설정
                    
                    // 슈퍼 점프 실패 시 턴 전환 알림 팝업 표시
                    showTurnNotification('도전 실패! 주사위를 굴려 이동하세요.');
                }
                closeQuiz();
                return;
            }
            
            // 땅 퀴즈 처리
            if (spaceOwners[currentSpace] !== undefined) {
                handleLandQuizAnswer(selected, correct, points, currentSpace);
                return;
            }
            
            // 일반 퀴즈 처리
            // 시간 초과 처리
            if (selected === -1) {
                showMessage('시간 초과! 점수 없음');
            } else if (selected === correct) {
                player.score += points;
                
                // 퀴즈 칸이고 아직 소유자가 없다면 구매
                if (boardSpaces.find(s => s.id === currentSpace)?.type === 'quiz' && 
                    spaceOwners[currentSpace] === null) {
                    // 플레이어 ID를 0부터 시작하는 인덱스로 변환 (1->0, 2->1, 3->2, 4->3)
                    const playerIndex = gameState.currentPlayer - 1;
                    buySpace(playerIndex, currentSpace);
                    showMessage(`정답! +${formatNumber(points)}점 획득! 칸 ${currentSpace}을 구매했습니다!`);
                } else {
                    showMessage(`정답! +${formatNumber(points)}점 획득!`);
                }
            } else {
                showMessage('틀렸습니다! 점수 없음');
            }
            closeQuiz();
        }

        // 퀴즈 닫기
        function closeQuiz() {
            
            // 타이머 정리
            if (quizTimer) {
                clearInterval(quizTimer);
                quizTimer = null;
            }
            
            const popup = document.getElementById('quizPopup');
            popup.classList.remove('show');
            
            // 슈퍼 점프 모드가 아닐 때는 슈퍼 점프 모드 클래스 제거
            if (!gameState.superJumpMode) {
                popup.classList.remove('super-jump-mode');
            }
            
            // 무인도 모드 클래스 제거
            popup.classList.remove('island-mode');
            
            // 슈퍼 점프 모드가 아니고 슈퍼 점프 실패가 아니고 무인도 모드가 아니고 무인도 탈출 성공이 아닐 때만 턴 전환
            const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
            if (!gameState.superJumpMode && !gameState.superJumpFailed && !(currentPlayer && currentPlayer.isOnIsland) && !gameState.modes.island.justEscaped) {
                setTimeout(() => {
                    try {
                    endTurn();
                    } catch (error) {
                        console.error('closeQuiz에서 endTurn 에러:', error);
                        // 에러 발생 시 기본 턴 전환 처리
                        const currentPlayerIndex = gameState.players.findIndex(p => p.id === gameState.currentPlayer);
                        if (currentPlayerIndex === -1) {
                            console.error('closeQuiz 에러 처리 중 현재 플레이어를 찾을 수 없습니다:', gameState.currentPlayer);
                            return;
                        }
                        const nextPlayerIndex = (currentPlayerIndex + 1) % gameState.players.length;
                        gameState.currentPlayer = gameState.players[nextPlayerIndex].id;
                        gameState.gamePhase = 'waiting';
                        updateUI();
                    }
                }, 1500); // 1.5초 후 자동 턴 전환
            }
            // 무인도 퀴즈 중이나 무인도 탈출 성공 시에는 턴 전환하지 않음 (무인도 매니저에서 처리)
        }

        // 현재 황금 열쇠 이벤트 저장 변수
        let currentGoldenKeyEvent = null;

        // 황금 열쇠 이벤트 표시 (간소화 버전)
        function showGoldenDiscoveryMessage() {
            
            const event = goldenKeyEvents[Math.floor(Math.random() * goldenKeyEvents.length)];
            currentGoldenKeyEvent = event;
            
            const popup = document.getElementById('goldenDiscoveryPopup');
            const eventTitleEl = document.getElementById('discoveryEventTitle');
            const eventDescriptionEl = document.getElementById('discoveryEventDescription');
            const mysteryBoxResultEl = document.getElementById('mysteryBoxResult');
            const mysteryBoxResultTextEl = document.getElementById('mysteryBoxResultText');

            eventTitleEl.textContent = event.name;
            eventDescriptionEl.textContent = event.description;
            
            // 신비한 상자 이벤트인 경우 결과 생성 및 표시
            if (event.name === "🎁 신비한 상자") {
                const results = [
                    { points: 500, message: "🎉 대박! 황금 보물을 발견했습니다! +500점!" },
                    { points: 0, message: "😅 빈 상자였습니다... 아무것도 얻지 못했습니다." },
                    { points: -200, message: "💥 함정이었습니다! 상자에서 독가스가 나와 -200점!" }
                ];
                const randomResult = results[Math.floor(Math.random() * results.length)];
                
                // 결과를 이벤트에 저장 (확인 버튼을 누른 후 적용하기 위해)
                event.effect = () => {
                    const player = gameState.players.find(p => p.id === gameState.currentPlayer);
                const oldScore = player.score;
                player.score = Math.max(0, player.score + randomResult.points);
                const actualChange = player.score - oldScore;
                
                // 점수만 업데이트 (메시지는 팝업 내부에 이미 표시됨)
                updateUI();
                };
                
                // 결과 표시
                mysteryBoxResultTextEl.textContent = randomResult.message;
                mysteryBoxResultEl.style.display = 'block';
            } else {
                mysteryBoxResultEl.style.display = 'none';
            }
            
            // 황금 열쇠 모드 클래스 추가
            popup.classList.add('golden-key-mode');
            
            // 팝업 표시
            popup.classList.add('show');
        }

        // 통합된 황금 열쇠 팝업 닫기
        function closeGoldenDiscovery() {
            const popup = document.getElementById('goldenDiscoveryPopup');
            popup.classList.remove('show');
            popup.classList.remove('golden-key-mode');
            
            // 황금 카드 효과 적용
            if (currentGoldenKeyEvent && currentGoldenKeyEvent.effect) {
                currentGoldenKeyEvent.effect();
            }
            
            // 이벤트 활성화
            currentGoldenKeyEvent = null;
            
            // 다음 플레이어로 턴 전환
            setTimeout(() => {
            endTurn();
            }, 1000);
        }

        // 황금 열쇠 이벤트 표시 (통합 버전 사용)
        function showGoldenKeyEvent() {
            // 통합된 황금 열쇠 발견 메시지 표시
            showGoldenDiscoveryMessage();
        }

        // 황금 열쇠 효과 적용
        function applyGoldenKeyEffect(event) {
            if (event && event.effect) {
                event.effect();
            }
        }

        // 황금 열쇠 닫기
        function closeGoldenKey() {
            document.getElementById('goldenKeyPopup').classList.remove('show');
            
            // 황금 카드 효과 적용
            if (currentGoldenKeyEvent && currentGoldenKeyEvent.effect) {
                    currentGoldenKeyEvent.effect();
            }
            
            // 이벤트 활성화
            currentGoldenKeyEvent = null;
            
            // 다음 플레이어로 턴 전환
                setTimeout(() => {
                    endTurn();
            }, 1000);
        }

        // 턴 전환 알림 표시
        function showTurnNotification(message) {
            try {
                // DOM이 완전히 로드되었는지 확인
                if (document.readyState !== 'complete') {
                    console.warn('DOM이 완전히 로드되지 않았습니다. 잠시 후 다시 시도합니다.');
                    setTimeout(() => showTurnNotification(message), 100);
                    return;
                }
                
            const popup = document.getElementById('turnNotificationPopup');
                if (!popup) {
                    console.error('턴 전환 알림 팝업을 찾을 수 없습니다');
                    return;
                }
                
                // 팝업 내부에서 요소를 찾기
                const contentEl = popup.querySelector('.popup-content');
                const titleEl = popup.querySelector('.popup-title');
                const buttonEl = popup.querySelector('.popup-button');
                
                // 요소가 존재하지 않으면 에러 처리
                if (!contentEl || !titleEl || !buttonEl) {
                    console.error('턴 전환 알림 팝업 내부 요소를 찾을 수 없습니다:', { contentEl, titleEl, buttonEl });
                    return;
                }
                
                // 확인 버튼의 onclick 이벤트 명시적으로 설정
                buttonEl.onclick = closeTurnNotification;
            
            // 슈퍼 점프 모드일 때는 제목과 메시지를 다르게 표시
            if (gameState.superJumpMode) {
                const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
                const playerName = currentPlayer ? currentPlayer.name : `플레이어 ${gameState.currentPlayer}`;
                    titleEl.innerHTML = '🚀 슈퍼 점프 도전!';
                contentEl.innerHTML = `<p>${playerName} - 문제를 풀어 슈퍼 점프에 도전하세요!</p>`;
                    popup.classList.add('super-jump-mode');
            } else {
                // 무인도에 갇힌 플레이어의 턴인지 확인
                    const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
                if (currentPlayer && currentPlayer.isOnIsland) {
                    titleEl.innerHTML = '🏝️ 무인도 탈출 도전!';
                    contentEl.innerHTML = `<p>${currentPlayer.name}의 무인도 탈출 도전!</p>`;
                    popup.classList.add('island-mode');
                    console.log('[DEBUG] 콘텐츠 요소 설정 후:', contentEl.innerHTML);
                } else if (message && message.includes('도전 실패')) {
                    const playerName = currentPlayer ? currentPlayer.name : `플레이어 ${gameState.currentPlayer}`;
                    titleEl.innerHTML = '❌ 도전 실패!';
                    contentEl.innerHTML = `<p>${playerName} - 주사위를 굴려 이동하세요.</p>`;
                    popup.classList.remove('island-mode');
                } else {
                    titleEl.innerHTML = '🎮 턴 전환';
                    contentEl.innerHTML = `<p>${message || '턴이 전환되었습니다.'}</p>`;
                    popup.classList.remove('island-mode');
                }
                popup.classList.remove('super-jump-mode');
            }
                
                popup.classList.add('show');
            } catch (error) {
                console.error('showTurnNotification 에러:', error);
                // 에러 발생 시 기본 메시지 표시
                const popup = document.getElementById('turnNotificationPopup');
                if (popup) {
            popup.classList.add('show');
                }
            }
        }

        // 턴 전환 알림 닫기
        function closeTurnNotification() {
            console.log('[DEBUG] closeTurnNotification 함수 호출됨');
            const popup = document.getElementById('turnNotificationPopup');
            popup.classList.remove('show');
            
            // 게임 액션 기록
            gameStateMonitor.recordAction();
            
            // 현재 플레이어가 무인도에 갇혀있는지 확인
            const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
            
            if (currentPlayer && currentPlayer.isOnIsland) {
                // 무인도에 갇힌 플레이어의 퀴즈 시작
                try {
                    islandManager.attemptIslandEscape(currentPlayer.id);
                    console.log('[DEBUG] attemptIslandEscape 호출 완료');
                } catch (error) {
                    console.error('[DEBUG] attemptIslandEscape 에러:', error);
                }
                return; // 무인도 퀴즈 시작 후 다른 로직 실행 방지
            } else if (gameState.superJumpMode) {
                showQuiz();
            } else {
                // 슈퍼 점프 모드가 아닐 때는 슈퍼 점프 모드 클래스 제거
                popup.classList.remove('super-jump-mode');
                
                // 무인도에서 탈출한 플레이어가 턴 전환 알림을 확인한 경우
                if (gameState.modes.island.justEscaped) {
                    // 플래그 활성화
                    gameState.modes.island.justEscaped = false;
                    // 주사위 버튼 활성화
                    diceButtonManager.updateFromGameState();
                    // 턴 전환은 이미 endTurn()에서 완료되었으므로 UI만 업데이트
                    updateUI();
                    return;
                }
                
                // 무인도에 갇힌 플레이어의 턴 전환 알림 확인 시
                const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
                if (currentPlayer && currentPlayer.isOnIsland) {
                    try {
                        islandManager.attemptIslandEscape(currentPlayer.id);
                    } catch (error) {
                        console.error('[DEBUG] 무인도 탈출 로직 에러:', error);
                    }
                    return;
                }
                
                // 일반적인 턴 전환 알림 확인 시
                diceButtonManager.updateFromGameState();
                
                if (gameState.superJumpFailed) {
                    gameState.superJumpFailed = false;
                }
                
                if (gameState.gamePhase !== 'waiting') {
                    gameState.gamePhase = 'waiting';
                }
                
                // UI 업데이트
                updateUI();
            }
        }

        // 턴 종료 (자동 턴 전환)
        function endTurn() {
            try {
            const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
            
            // 슈퍼 점프 대기 상태인지 확인
                if (currentPlayer && currentPlayer.isWaitJump) {
                gameState.gamePhase = 'superJumping';
                gameState.superJumpMode = true;
                showMessage('문제를 맞춰 원하는 곳으로 이동하세요.');
                showQuiz(); // 슈퍼 점프용 퀴즈
                return; // 턴 전환하지 않음
            }
            
            // 게임 액션 기록
            gameStateMonitor.recordAction();
            
            // 동적 턴 전환 로직 (플레이어 수에 따라 자동 조정)
            const previousPlayer = gameState.currentPlayer;
            const currentPlayerIndex = gameState.players.findIndex(p => p.id === gameState.currentPlayer);
            
            // 현재 플레이어를 찾지 못한 경우 에러 처리
            if (currentPlayerIndex === -1) {
                console.error('현재 플레이어를 찾을 수 없습니다:', gameState.currentPlayer);
                console.error('사용 가능한 플레이어들:', gameState.players.map(p => p.id));
                return;
            }
            
            const nextPlayerIndex = (currentPlayerIndex + 1) % gameState.players.length;
            gameState.currentPlayer = gameState.players[nextPlayerIndex].id;
            gameState.gamePhase = 'waiting';
            gameState.diceValue = 0;

                console.log('🔍 [DEBUG] 턴 전환 완료 - 이전 플레이어:', previousPlayer, '→ 새 플레이어:', gameState.currentPlayer);

            // 물음표로 바꾸지 않고 현재 주사위 값 유지
                diceButtonManager.updateFromGameState();

            const newCurrentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
                
                if (!newCurrentPlayer) {
                    console.error('newCurrentPlayer를 찾을 수 없습니다:', gameState.currentPlayer);
                    return;
                }
                
                // 무인도에 갇힌 플레이어의 턴 처리
                if (newCurrentPlayer.isOnIsland) {
                    
                    // 무인도에 갇힌 플레이어에게도 턴 전환 메시지 표시
                    showTurnNotification(`${newCurrentPlayer.name}의 차례입니다.`);
                    return;
                }
                
                // 무인도에 갇힌 플레이어가 없으면 무인도 표시기 숨기기 (제거됨)
                // if (!islandManager.hasIslandPlayers()) {
                //     islandManager.hideIslandIndicator();
                // }
                
            if (newCurrentPlayer.hasSuperJumpChance) {
                // 현재 위치가 슈퍼 점프 칸인지 확인
                const currentSpace = boardSpaces.find(s => s.id === newCurrentPlayer.position);
                if (currentSpace && currentSpace.name === '슈퍼 점프') {
                    newCurrentPlayer.hasSuperJumpChance = false; // 기회 사용
                    newCurrentPlayer.isWaitJump = true; // 슈퍼 점프 대기 상태로 설정
                    gameState.gamePhase = 'superJumping';
                    gameState.superJumpMode = true;
                    
                    // 턴 알림 팝업으로 슈퍼 점프 시작 알림
                    showTurnNotification('슈퍼 점프 도전');
                } else {
                    newCurrentPlayer.hasSuperJumpChance = false; // 기회 취소
                    showTurnNotification(`플레이어 ${gameState.currentPlayer}의 차례입니다.`);
                }
            } else {
                // 일반 턴 전환 팝업 표시
                showTurnNotification(`플레이어 ${gameState.currentPlayer}의 차례입니다.`);
            }

                // 턴 전환 완료 후 UI 업데이트
                // updateUI()는 endTurn() 함수 끝에서 호출하지 않고, 호출하는 곳에서 처리
            } catch (error) {
                console.error('endTurn 함수 에러:', error);
                // 에러 발생 시 기본 턴 전환 처리
                const currentPlayerIndex = gameState.players.findIndex(p => p.id === gameState.currentPlayer);
                if (currentPlayerIndex === -1) {
                    console.error('endTurn 함수 에러 처리 중 현재 플레이어를 찾을 수 없습니다:', gameState.currentPlayer);
                    return;
                }
                const nextPlayerIndex = (currentPlayerIndex + 1) % gameState.players.length;
                gameState.currentPlayer = gameState.players[nextPlayerIndex].id;
                gameState.gamePhase = 'waiting';
            updateUI();
            }
        }

        // UI 업데이트
        function updateUI() {
            // 플레이어 정보 업데이트
            gameState.players.forEach(player => {
                const scoreElement = document.getElementById(`score${player.id}`);
                if (scoreElement) {
                    scoreElement.textContent = formatNumber(player.score);
                }
            });

            // 현재 플레이어 하이라이트
            updatePlayerHighlight();

            // 주사위 표시 (새로운 SVG 시스템)
            if (gameState.diceValue) {
                updateDiceIcon(gameState.diceValue);
            }

            updatePlayerPieces();
        }

        // 플레이어 하이라이트 업데이트
        function updatePlayerHighlight() {
            // 모든 플레이어 카드에서 active 클래스 제거 (항상 먼저 제거)
            document.querySelectorAll('.player-info').forEach(card => {
                card.classList.remove('active');
            });

            // 무인도에 갇힌 플레이어도 하이라이트 처리
            const currentPlayer = gameState.players.find(p => p.id === gameState.currentPlayer);
            
            if (currentPlayer && currentPlayer.isOnIsland) {
                updatePlayerHighlightForIsland(currentPlayer);
                return;
            }

            // 현재 플레이어 카드에 active 클래스 추가
            const currentPlayerCard = document.getElementById(`player${gameState.currentPlayer}-info`);
            
            if (currentPlayerCard) {
                currentPlayerCard.classList.add('active');
            } else {
                console.error('플레이어', gameState.currentPlayer, '카드를 찾을 수 없음');
            }
        }

        // 무인도 퀴즈 중 플레이어 하이라이트 업데이트
        function updatePlayerHighlightForIsland(player) {
            // 모든 플레이어 카드에서 active 클래스 제거
            document.querySelectorAll('.player-info').forEach(card => {
                card.classList.remove('active');
            });

            // 무인도에 갇힌 플레이어 카드에 active 클래스 추가
            const playerCard = document.getElementById(`player${player.id}-info`);
            
            if (playerCard) {
                playerCard.classList.add('active');
            } else {
                console.error('무인도 플레이어', player.id, '카드를 찾을 수 없음');
            }
        }

        // 메시지 표시 (개선된 알림)
        function showMessage(message) {
            // 기존 알림 제거
            const existingNotification = document.querySelector('.game-notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // 슈퍼 점프 관련 메시지인지 확인
            const isSuperJumpMessage = message.includes('슈퍼 점프') || 
                                     message.includes('정답! 슈퍼 점프') || 
                                     message.includes('문제를 맞춰 원하는 곳으로') ||
                                     gameState.superJumpMode;

            // 황금 카드 관련 메시지인지 확인
            const isGoldenKeyMessage = message.includes('대박! 황금 보물을 발견했습니다!') ||
                                     message.includes('빈 상자였습니다') ||
                                     message.includes('함정이었습니다') ||
                                     message.includes('로켓 부스터') ||
                                     message.includes('복권 당첨') ||
                                     message.includes('황금') ||
                                     message.includes('보물') ||
                                     message.includes('축하합니다!') ||
                                     message.includes('획득했습니다!');

            // 무인도 관련 메시지인지 확인 (성공 메시지는 제외)
            const isIslandMessage = (message.includes('무인도에 갇혔습니다') ||
                                 message.includes('무인도에서 탈출') ||
                                 message.includes('무인도 탈출') ||
                                 message.includes('무인도에서 나갈 수 있습니다') ||
                                 message.includes('틀렸습니다! 다음 턴에 다시 도전하세요') ||
                                 (message.includes('정답!') && message.includes('문제 더 맞춰주세요'))) &&
                                 !message.includes('무인도 탈출 성공') &&
                                 !message.includes('무인도에서 탈출했습니다');

            // 기부금 관련 메시지인지 확인
            const isDonationMessage = message.includes('기부금') ||
                                     message.includes('기부') ||
                                     message.includes('모금') ||
                                     message.includes('수령');

            // 새로운 알림 생성
            const notification = document.createElement('div');
            notification.className = 'game-notification';
            notification.textContent = message;
            
            if (isSuperJumpMessage) {
                // 슈퍼 점프 관련 메시지 스타일
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #00BFFF, #00CED1, #9370DB);
                    color: #fff;
                    padding: 15px 25px;
                    border-radius: 25px;
                    font-size: 16px;
                    font-weight: bold;
                    border: 3px solid #00BFFF;
                    box-shadow: 0 0 30px rgba(0, 191, 255, 0.6);
                    z-index: 2000;
                    animation: slideDown 0.3s ease-out;
                    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
                `;
            } else if (isGoldenKeyMessage) {
                // 황금 카드 관련 메시지 스타일
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #FFD700, #FFA500, #FF6347);
                    color: #fff;
                    padding: 15px 25px;
                    border-radius: 25px;
                    font-size: 16px;
                    font-weight: bold;
                    border: 3px solid #FFD700;
                    box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
                    z-index: 2000;
                    animation: slideDown 0.3s ease-out;
                    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
                `;
            } else if (isIslandMessage) {
                // 무인도 관련 메시지 스타일
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #424242, #616161, #757575);
                    color: #fff;
                    padding: 15px 25px;
                    border-radius: 25px;
                    font-size: 16px;
                    font-weight: bold;
                    border: 3px solid #424242;
                    box-shadow: 0 0 30px rgba(66, 66, 66, 0.6);
                    z-index: 2000;
                    animation: slideDown 0.3s ease-out;
                    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
                `;
            } else if (isDonationMessage) {
                // 기부금 관련 메시지 스타일 (핫핑크 계열)
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #FF69B4, #FF1493, #FFB6C1);
                    color: #fff;
                    padding: 15px 25px;
                    border-radius: 25px;
                    font-size: 16px;
                    font-weight: bold;
                    border: 3px solid #FF69B4;
                    box-shadow: 0 0 30px rgba(255, 105, 180, 0.6);
                    z-index: 2000;
                    animation: slideDown 0.3s ease-out;
                    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
                `;
            } else {
                // 일반 메시지 스타일
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 15px 25px;
                border-radius: 25px;
                font-size: 16px;
                font-weight: bold;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                z-index: 2000;
                animation: slideDown 0.3s ease-out;
            `;
            }

            // CSS 애니메이션 추가
            if (!document.querySelector('#notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideDown {
                        from { 
                            opacity: 0; 
                            transform: translateX(-50%) translateY(-20px); 
                        }
                        to { 
                            opacity: 1; 
                            transform: translateX(-50%) translateY(0); 
                        }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(notification);

            // 3초 후 자동 제거
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideDown 0.3s ease-out reverse';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 3000);
        }

        // 칸 클릭 처리
        function handleSpaceClick(spaceId) {
            // 슈퍼 점프 모드인지 확인
            if (gameState.superJumpMode) {
                if (spaceId === 6) {
                    showMessage('슈퍼 점프 칸은 선택할 수 없습니다.');
                    return;
                }
                // 슈퍼 점프 이동 처리
                performSuperJump(spaceId);
                return;
            }
            
            // 일반 모드: 칸 클릭 시 정보 표시 (선택사항)
            const space = boardSpaces.find(s => s.id === spaceId);
            if (space) {
                showMessage(`${space.name} (${space.type})`);
            }
        }

        // 슈퍼 점프 모드 활성화
        function enableSuperJumpMode() {
            // 슈퍼 점프 모드 표시기 추가
            showSuperJumpIndicator();
            
            // 슈퍼 점프 칸 제외한 모든 칸에 클릭 가능 표시
            document.querySelectorAll('.board-space').forEach(cell => {
                const spaceId = parseInt(cell.dataset.spaceId);
                if (spaceId !== 6 && spaceId !== undefined) { // 슈퍼 점프 칸(6) 제외
                    cell.classList.add('super-jump-target');
                    cell.style.cursor = 'pointer';
                }
            });
            
            // 슈퍼 점프 칸 비활성화
            const superJumpCell = document.querySelector('[data-space-id="6"]');
            if (superJumpCell) {
                superJumpCell.classList.add('super-jump-disabled');
            }
            
            // 주사위 버튼 비활성화
            diceButtonManager.setState('disabled');
        }

        // 슈퍼 점프 모드 비활성화
        function disableSuperJumpMode() {
            // 슈퍼 점프 모드 표시기 제거
            hideSuperJumpIndicator();
            
            // 모든 슈퍼 점프 관련 클래스 제거
            document.querySelectorAll('.board-space').forEach(cell => {
                cell.classList.remove('super-jump-target', 'super-jump-disabled');
                cell.style.cursor = '';
            });
            
            // 주사위 버튼 활성화
            diceButtonManager.updateFromGameState();
        }

        // 슈퍼 점프 실행
        function performSuperJump(targetSpaceId) {
            const player = gameState.players.find(p => p.id === gameState.currentPlayer);
            const currentPosition = player.position;
            const targetSpace = boardSpaces.find(s => s.id === targetSpaceId);
            
            if (!targetSpace) {
                showMessage('잘못된 칸입니다.');
                return;
            }
            
            // 슈퍼 점프 모드 비활성화
            disableSuperJumpMode();
            
            // 플레이어 이동
            player.position = targetSpaceId;
            
            // 시작점을 돌았다면 추가 점수 부여
            if (currentPosition > targetSpaceId) {
                player.score += 200;
                showMessage(`슈퍼 점프! 시작점을 돌아 +200점 보너스!`);
            } else {
                showMessage(`슈퍼 점프! ${targetSpace.name}으로 이동!`);
            }
            
            // 슈퍼 점프 상태 활성화
            player.isWaitJump = false;
            gameState.superJumpMode = false;
            gameState.gamePhase = 'waiting';
            
            // UI 업데이트
            updatePlayerPieces();
            updateUI();
            
            // 도착한 칸의 액션 처리
            setTimeout(() => {
                handleSpaceAction(targetSpaceId);
            }, 1000);
        }

        // 슈퍼 점프 모드 표시기 표시
        function showSuperJumpIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'superJumpIndicator';
            indicator.className = 'super-jump-mode-indicator';
            indicator.textContent = '🚀 슈퍼 점프 모드 - 원하는 칸을 클릭하세요!';
            document.body.appendChild(indicator);
        }

        // 슈퍼 점프 모드 표시기 숨기기
        function hideSuperJumpIndicator() {
            const indicator = document.getElementById('superJumpIndicator');
            if (indicator) {
                indicator.remove();
            }
        }


        // 전체화면 토글 함수
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                // 전체화면 진입
                document.documentElement.requestFullscreen().then(() => {
                    document.body.classList.add('fullscreen-mode');
                    document.getElementById('fullscreenIcon').classList.add('minimize');
                    document.getElementById('fullscreenBtn').title = '전체화면 해제';
                }).catch(err => {
                    // 전체화면 진입 실패
                });
            } else {
                // 전체화면 해제
                document.exitFullscreen().then(() => {
                    document.body.classList.remove('fullscreen-mode');
                    document.getElementById('fullscreenIcon').classList.remove('minimize');
                    document.getElementById('fullscreenBtn').title = '전체화면 토글';
                }).catch(err => {
                    // 전체화면 해제 실패
                });
            }
        }

        // 설정 창 열기 함수
        function openSettings() {
            const modal = document.getElementById('settingsModal');
            if (modal) {
                modal.style.display = 'flex';
            } else {
                createSettingsModal();
            }
        }

        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function createSettingsModal() {
            const modal = document.createElement('div');
            modal.id = 'settingsModal';
            modal.className = 'settings-modal';
            modal.innerHTML = `
                <div class="settings-container">
                    <div class="settings-header">
                        <h2>⚙️ 게임 설정</h2>
                        <button class="close-btn" onclick="closeSettings()">✕</button>
                    </div>
                    <div class="settings-content">
                        <div class="settings-sidebar">
                            <div class="sidebar-item active" onclick="selectSettingsTab('color')">
                                🎨 색상
                            </div>
                            <div class="sidebar-item" onclick="selectSettingsTab('sound')">
                                🔊 사운드
                            </div>
                            <div class="sidebar-item" onclick="selectSettingsTab('game')">
                                🎮 게임
                            </div>
                            <div class="sidebar-item" onclick="selectSettingsTab('display')">
                                📱 화면
                            </div>
                        </div>
                        <div class="settings-main">
                            <div class="settings-panel active" id="color-panel">
                                <h3>🎨 색상 설정</h3>
                                <div class="color-settings-layout">
                                    <div class="palette-selection">
                                        <div class="setting-group">
                                            <label>팔레트 선택</label>
                                            <div class="palette-list" id="paletteList">
                                                <!-- 팔레트가 여기에 동적으로 생성됩니다 -->
                                            </div>
                                        </div>
                                    </div>
                                    <div class="palette-preview">
                                        <h4>미리보기</h4>
                                        <div class="mini-board-container">
                                            <div class="mini-board" id="miniBoard">
                                                <!-- 미니 보드가 여기에 생성됩니다 -->
                                            </div>
                                        </div>
                                        <div class="palette-info">
                                            <div class="palette-name" id="selectedPaletteName">오션 톤</div>
                                            <div class="palette-theme" id="selectedPaletteTheme">바다 느낌, 시원하고 깔끔함</div>
                                            <div class="palette-colors" id="selectedPaletteColors">
                                                <div class="color-item">
                                                    <span class="color-swatch" style="background: #FF5722;"></span>
                                                    <span>플레이어 1</span>
                                                </div>
                                                <div class="color-item">
                                                    <span class="color-swatch" style="background: #3F51B5;"></span>
                                                    <span>플레이어 2</span>
                                                </div>
                                                <div class="color-item">
                                                    <span class="color-swatch" style="background: #4CAF50;"></span>
                                                    <span>플레이어 3</span>
                                                </div>
                                                <div class="color-item">
                                                    <span class="color-swatch" style="background: #FF9800;"></span>
                                                    <span>플레이어 4</span>
                                                </div>
                                            </div>
                                        </div>
                                            <div class="preview-actions">
                                                <button class="btn-apply" onclick="applySelectedPalette()">적용</button>
                                            </div>
                                    </div>
                                </div>
                            </div>
                            <div class="settings-panel" id="sound-panel">
                                <h3>🔊 사운드 설정</h3>
                                <div class="setting-group">
                                    <label>효과음 볼륨</label>
                                    <input type="range" min="0" max="100" value="80" class="volume-slider">
                                    <span class="volume-value">80%</span>
                                </div>
                                <div class="setting-group">
                                    <label>배경음악 볼륨</label>
                                    <input type="range" min="0" max="100" value="60" class="volume-slider">
                                    <span class="volume-value">60%</span>
                                </div>
                                <div class="setting-group">
                                    <label><input type="checkbox"> 음소거</label>
                                </div>
                            </div>
                            <div class="settings-panel" id="game-panel">
                                <h3>🎮 게임 설정</h3>
                                <div class="setting-group">
                                    <label><input type="checkbox"> 애니메이션 효과</label>
                                </div>
                                <div class="setting-group">
                                    <label><input type="checkbox"> 자동 턴 전환</label>
                                </div>
                            </div>
                            <div class="settings-panel" id="display-panel">
                                <h3>📱 화면 설정</h3>
                                <div class="setting-group">
                                    <label><input type="checkbox"> 전체화면 모드</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            // DOM이 완전히 렌더링된 후 팔레트 로드
            setTimeout(() => {
                loadPalettes();
                const newModal = document.getElementById('settingsModal');
                if (newModal) {
                    newModal.style.display = 'flex';
                }
            }, 100);
        }

        function selectSettingsTab(tabName) {
            // 모든 탭 비활성화
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.settings-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // 선택된 탭 활성화
            event.target.classList.add('active');
            document.getElementById(tabName + '-panel').classList.add('active');
        }

        // 팔레트 데이터를 JavaScript 변수로 직접 포함
        const palettesData = {
            "palettes": [
                {
                    "id": 0,
                    "name": "팔레트 1 - 오션 톤",
                    "theme": "바다 느낌, 시원하고 깔끔함",
                    "colors": {
                        "golden": "#FFD700",
                        "corner": "#4682B4",
                        "quiz": "#00CED1",
                        "special": "#6495ED",
                        "complete": "#FF7F50",
                        "center": "#E0F6FF",
                        "normal": "#B0E0E6",
                        "background": "#F0F8FF"
                    },
                    "playerColors": ["#E91E63", "#2196F3", "#4CAF50", "#9C27B0"]
                },
                {
                    "id": 1,
                    "name": "팔레트 2 - 비비드 톤",
                    "theme": "생동감 있고 밝은 느낌, 높은 대비",
                    "colors": {
                        "golden": "#FFD700",
                        "corner": "#1E90FF",
                        "quiz": "#32CD32",
                        "special": "#8A2BE2",
                        "complete": "#FF6347",
                        "center": "#FFE4B5",
                        "normal": "#87CEEB",
                        "background": "#F0F8FF"
                    },
                    "playerColors": ["#F44336", "#4CAF50", "#2196F3", "#9C27B0"]
                },
                {
                    "id": 2,
                    "name": "팔레트 3 - 모던 라이트",
                    "theme": "세련되고 밝은 느낌, 현대적",
                    "colors": {
                        "golden": "#FFD700",
                        "corner": "#4682B4",
                        "quiz": "#20B2AA",
                        "special": "#9370DB",
                        "complete": "#FF6B6B",
                        "center": "#F8F9FA",
                        "normal": "#E3F2FD",
                        "background": "#FAFAFA"
                    },
                    "playerColors": ["#FF5722", "#4CAF50", "#9C27B0", "#2196F3"]
                },
                {
                    "id": 3,
                    "name": "팔레트 4 - 웜 라이트",
                    "theme": "따뜻하고 밝은 느낌, 아늑함",
                    "colors": {
                        "golden": "#FFD700",
                        "corner": "#FF8C00",
                        "quiz": "#00CED1",
                        "special": "#DA70D6",
                        "complete": "#FF1493",
                        "center": "#FFF8DC",
                        "normal": "#F0E68C",
                        "background": "#FFFACD"
                    },
                    "playerColors": ["#E91E63", "#4CAF50", "#9C27B0", "#2196F3"]
                },
                {
                    "id": 4,
                    "name": "팔레트 5 - 쿨 라이트",
                    "theme": "시원하고 차분한 느낌, 집중력 향상",
                    "colors": {
                        "golden": "#FFD700",
                        "corner": "#4169E1",
                        "quiz": "#00FA9A",
                        "special": "#6A5ACD",
                        "complete": "#FF69B4",
                        "center": "#F0FFFF",
                        "normal": "#E0FFFF",
                        "background": "#F0F8FF"
                    },
                    "playerColors": ["#FF5722", "#4CAF50", "#2196F3", "#9C27B0"]
                },
                {
                    "id": 5,
                    "name": "팔레트 6 - 네이처 톤",
                    "theme": "자연스럽고 편안한 느낌, 힐링",
                    "colors": {
                        "golden": "#FFD700",
                        "corner": "#8FBC8F",
                        "quiz": "#90EE90",
                        "special": "#DDA0DD",
                        "complete": "#F0A0A0",
                        "center": "#F5FFFA",
                        "normal": "#E0FFE0",
                        "background": "#F0FFF0"
                    },
                    "playerColors": ["#E91E63", "#2196F3", "#9C27B0", "#4CAF50"]
                },
                {
                    "id": 6,
                    "name": "팔레트 7 - 파스텔 톤",
                    "theme": "부드럽고 밝은 느낌, 어린이 친화적",
                    "colors": {
                        "golden": "#FFD700",
                        "corner": "#E6E6FA",
                        "quiz": "#B0E0E6",
                        "special": "#98FB98",
                        "complete": "#FFB6C1",
                        "center": "#F0F8FF",
                        "normal": "#FFFACD",
                        "background": "#F5F5F5"
                    },
                    "playerColors": ["#E91E63", "#2196F3", "#9C27B0", "#4CAF50"]
                },
                {
                    "id": 7,
                    "name": "팔레트 8 - 선셋 톤",
                    "theme": "일몰 느낌, 따뜻하고 로맨틱",
                    "colors": {
                        "golden": "#FFD700",
                        "corner": "#FF8C00",
                        "quiz": "#FFA500",
                        "special": "#FF6347",
                        "complete": "#FF4500",
                        "center": "#FFF8DC",
                        "normal": "#FFE4B5",
                        "background": "#FFFACD"
                    },
                    "playerColors": ["#F44336", "#4CAF50", "#2196F3", "#9C27B0"]
                },
                {
                    "id": 8,
                    "name": "팔레트 9 - 라벤더 톤",
                    "theme": "보라색 계열, 우아하고 고급스러움",
                    "colors": {
                        "golden": "#FFD700",
                        "corner": "#9370DB",
                        "quiz": "#DDA0DD",
                        "special": "#BA55D3",
                        "complete": "#FF69B4",
                        "center": "#F8F8FF",
                        "normal": "#E6E6FA",
                        "background": "#F0F0FF"
                    },
                    "playerColors": ["#FF5722", "#4CAF50", "#2196F3", "#E91E63"]
                },
                {
                    "id": 9,
                    "name": "팔레트 10 - 민트 톤",
                    "theme": "민트색 계열, 신선하고 깔끔함",
                    "colors": {
                        "golden": "#FFD700",
                        "corner": "#20B2AA",
                        "quiz": "#00FA9A",
                        "special": "#40E0D0",
                        "complete": "#00CED1",
                        "center": "#F0FFFF",
                        "normal": "#E0FFFF",
                        "background": "#F5FFFA"
                    },
                    "playerColors": ["#E91E63", "#9C27B0", "#2196F3", "#4CAF50"]
                },
                {
                    "id": 10,
                    "name": "팔레트 11 - 코랄 톤",
                    "theme": "코랄색 계열, 활기차고 생동감",
                    "colors": {
                        "golden": "#FFD700",
                        "corner": "#FF7F50",
                        "quiz": "#FF6347",
                        "special": "#FF69B4",
                        "complete": "#FF1493",
                        "center": "#FFF0F5",
                        "normal": "#FFE4E1",
                        "background": "#FFF5EE"
                    },
                    "playerColors": ["#4CAF50", "#2196F3", "#9C27B0", "#E91E63"]
                },
                {
                    "id": 11,
                    "name": "팔레트 12 - 포레스트 톤",
                    "theme": "숲 느낌, 자연스럽고 안정감",
                    "colors": {
                        "golden": "#FFD700",
                        "corner": "#228B22",
                        "quiz": "#32CD32",
                        "special": "#9ACD32",
                        "complete": "#ADFF2F",
                        "center": "#F0FFF0",
                        "normal": "#E0FFE0",
                        "background": "#F5FFFA"
                    },
                    "playerColors": ["#E91E63", "#2196F3", "#9C27B0", "#4CAF50"]
                }
            ]
        };

        // 현재 게임판에 적용된 팔레트를 찾는 함수
        function getCurrentPalette() {
            const currentStartColor = getComputedStyle(document.documentElement).getPropertyValue('--color-start').trim();
            const currentQuizColor = getComputedStyle(document.documentElement).getPropertyValue('--color-quiz').trim();
            
            // 현재 색상과 일치하는 팔레트 찾기
            for (let i = 0; i < palettesData.palettes.length; i++) {
                const palette = palettesData.palettes[i];
                if (palette.colors.golden === currentStartColor && palette.colors.quiz === currentQuizColor) {
                    return i; // 팔레트 인덱스 반환
                }
            }
            return 0; // 기본값으로 첫 번째 팔레트 반환
        }

        function loadPalettes() {
            try {
                const paletteList = document.getElementById('paletteList');
                
                if (paletteList && palettesData.palettes) {
                    paletteList.innerHTML = '';
                    
                    // 현재 적용된 팔레트 인덱스 가져오기
                    const currentPaletteIndex = getCurrentPalette();
                    
                    palettesData.palettes.forEach((palette, index) => {
                        const paletteItem = document.createElement('div');
                        paletteItem.className = 'palette-item';
                        
                        // 현재 팔레트인 경우 active 클래스 추가
                        if (index === currentPaletteIndex) {
                            paletteItem.classList.add('active');
                            selectedPalette = palette; // 현재 팔레트를 선택된 팔레트로 설정
                        }
                        
                        paletteItem.innerHTML = `
                            <div class="palette-name">${palette.name.replace('팔레트 ', '').replace(/^\d+\s*-\s*/, '')}</div>
                        `;
                        paletteItem.onclick = () => selectPalette(index, palette);
                        paletteList.appendChild(paletteItem);
                    });
                    
                    // 현재 팔레트로 미리보기 업데이트
                    if (selectedPalette) {
                        updatePreview(selectedPalette);
                    }
                }
            } catch (error) {
                // 팔레트 로딩 실패
            }
        }

        let selectedPalette = null;

        function selectPalette(index, palette) {
            // 모든 팔레트 아이템에서 active 클래스 제거
            document.querySelectorAll('.palette-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 선택된 팔레트에 active 클래스 추가
            event.currentTarget.classList.add('active');
            
            // 선택된 팔레트 저장
            selectedPalette = palette;
            
            // 미리보기 업데이트
            updatePreview(palette);
        }

        function updatePreview(palette) {
            // 팔레트 정보 업데이트 (번호 제거)
            const displayName = palette.name.replace(/팔레트 \d+ - /, '');
            document.getElementById('selectedPaletteName').textContent = displayName;
            document.getElementById('selectedPaletteTheme').textContent = palette.theme;
            
            // 팔레트별 플레이어 색상 스와치 업데이트 (BoardColorTest.html과 동일)
            const colorItems = document.querySelectorAll('#selectedPaletteColors .color-item');
            const playerColors = [
                { color: palette.playerColors[0], name: '플레이어 1' },
                { color: palette.playerColors[1], name: '플레이어 2' },
                { color: palette.playerColors[2], name: '플레이어 3' },
                { color: palette.playerColors[3], name: '플레이어 4' }
            ];
            
            colorItems.forEach((item, index) => {
                if (playerColors[index]) {
                    const swatch = item.querySelector('.color-swatch');
                    const name = item.querySelector('span:last-child');
                    swatch.style.background = playerColors[index].color;
                    name.textContent = playerColors[index].name;
                }
            });
            
            // 미니 보드 업데이트
            updateMiniBoard(palette);
        }

        function updateMiniBoard(palette) {
            const miniBoard = document.getElementById('miniBoard');
            if (!miniBoard) return;
            
            // 미니 보드 생성 (7x7 그리드)
            miniBoard.innerHTML = '';
            
            // 7x7 바둑판 모양으로 색상 배치
            const boardLayout = [
                ['golden', 'normal', 'normal', 'normal', 'normal', 'normal', 'corner'],
                ['normal', 'center', 'center', 'center', 'center', 'center', 'normal'],
                ['normal', 'center', 'center', 'center', 'center', 'center', 'normal'],
                ['normal', 'center', 'center', 'center', 'center', 'center', 'normal'],
                ['normal', 'center', 'center', 'center', 'center', 'center', 'normal'],
                ['normal', 'center', 'center', 'center', 'center', 'center', 'normal'],
                ['corner', 'normal', 'normal', 'normal', 'normal', 'normal', 'golden']
            ];
            
            let cellNumber = 1;
            boardLayout.forEach((row, rowIndex) => {
                row.forEach((cellType, colIndex) => {
                    const miniSpace = document.createElement('div');
                    miniSpace.className = 'mini-space';
                    
                    // 칸 번호별 색상 매핑
                    let color;
                    if ([1, 7, 43, 49].includes(cellNumber)) {
                        // 모서리 칸
                        color = palette.colors.corner;
                    } else if ([4, 22, 28, 46].includes(cellNumber)) {
                        // 황금열쇠 칸
                        color = palette.colors.golden;
                    } else if ([2, 3, 5, 6, 8, 15, 29, 36, 14, 21, 35, 42, 44, 45, 47, 48].includes(cellNumber)) {
                        // 퀴즈 칸
                        color = palette.colors.quiz;
                    } else {
                        // 보드 중앙 칸 (나머지)
                        color = palette.colors.center;
                    }
                    
                    miniSpace.style.backgroundColor = color;
                    
                    miniBoard.appendChild(miniSpace);
                    cellNumber++;
                });
            });
        }

        function applySelectedPalette() {
            if (selectedPalette) {
                applyPalette(selectedPalette);
                // 설정 창은 닫지 않고 유지
            }
        }

        function applyPalette(palette) {
            // CSS 변수 업데이트
            document.documentElement.style.setProperty('--color-start', palette.colors.golden);
            document.documentElement.style.setProperty('--color-quiz', palette.colors.quiz);
            document.documentElement.style.setProperty('--color-golden', palette.colors.golden);
            document.documentElement.style.setProperty('--color-special', palette.colors.special);
            document.documentElement.style.setProperty('--color-corner', palette.colors.corner);
            document.documentElement.style.setProperty('--color-center', palette.colors.center);
            document.documentElement.style.setProperty('--color-background', palette.colors.background);
            document.documentElement.style.setProperty('--color-normal', palette.colors.normal);
            
            // 특별 칸 고유 색상 유지 (팔레트 변경 시에도 고정)
            document.documentElement.style.setProperty('--color-superjump', '#00BFFF');
            document.documentElement.style.setProperty('--color-island', '#616161');
            document.documentElement.style.setProperty('--color-donation', '#FF69B4');
            
            // 팔레트별 플레이어 색상 CSS 변수 설정 (BoardColorTest.html과 동일)
            palette.playerColors.forEach((color, index) => {
                document.documentElement.style.setProperty(`--player-color-${index + 1}`, color);
            });
            
            // 플레이어 색상 업데이트 (팔레트별 색상 사용)
            palette.playerColors.forEach((color, index) => {
                if (gameState.players[index]) {
                    gameState.players[index].color = color;
                }
            });
            
            // 보드 다시 그리기
            createBoard();
            updateUI();
            
            // 보드 재생성 후 띠지 색상과 소유권 표시 업데이트
            setTimeout(() => {
                updateRibbonColors();
                updateLandOwnershipDisplay();
            }, 100);
        }

        // 전체화면 상태 변화 감지 (ESC 키 등으로 해제될 때)
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                document.body.classList.remove('fullscreen-mode');
                document.getElementById('fullscreenIcon').classList.remove('minimize');
                document.getElementById('fullscreenBtn').title = '전체화면 토글';
            }
        });

        // F11 키 지원 (선택사항)
        document.addEventListener('keydown', (event) => {
            if (event.key === 'F11') {
                event.preventDefault();
                toggleFullscreen();
            }
        });

        // 게임 시작
        window.onload = function() {
            initGame();
        };
    </script>
</body>
</html>
